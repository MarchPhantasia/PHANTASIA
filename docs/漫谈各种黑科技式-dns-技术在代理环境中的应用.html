<!doctype html>
<html lang="en">

<head>
    <title data-rh="true">漫谈各种黑科技式 DNS 技术在代理环境中的应用. 这篇文章目的是以非技术性例举方式，谈一谈各种 DNS… | by Tachyon | Medium</title>
    <meta data-rh="true" charset="utf-8" />
    <meta data-rh="true" name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1,maximum-scale=1" />
    <meta data-rh="true" name="theme-color" content="#000000" />
    <meta data-rh="true" name="twitter:app:name:iphone" content="Medium" />
    <meta data-rh="true" name="twitter:app:id:iphone" content="828256236" />
    <meta data-rh="true" property="al:ios:app_name" content="Medium" />
    <meta data-rh="true" property="al:ios:app_store_id" content="828256236" />
    <meta data-rh="true" property="al:android:package" content="com.medium.reader" />
    <meta data-rh="true" property="fb:app_id" content="542599432471018" />
    <meta data-rh="true" property="og:site_name" content="Medium" />
    <meta data-rh="true" property="og:type" content="article" />
    <meta data-rh="true" property="article:published_time" content="2021-02-06T17:15:03.897Z" />
    <meta data-rh="true" name="title"
        content="漫谈各种黑科技式 DNS 技术在代理环境中的应用. 这篇文章目的是以非技术性例举方式，谈一谈各种 DNS… | by Tachyon | Medium" />
    <meta data-rh="true" property="og:title" content="漫谈各种黑科技式 DNS 技术在代理环境中的应用" />
    <meta data-rh="true" property="al:android:url" content="medium://p/62c50e58cbd0" />
    <meta data-rh="true" property="al:ios:url" content="medium://p/62c50e58cbd0" />
    <meta data-rh="true" property="al:android:app_name" content="Medium" />
    <meta data-rh="true" name="description"
        content="这篇文章目的是以非技术性例举方式，谈一谈各种 DNS 技术在代理环境中如何工作，主要集中在对 V2Ray 的使用上，因为最近 V2Ray 发布了一个 DNS 相关的功能：https://steemit.com/cn/@v2ray/dns，其用法很多，可以解决很多问题，但如果不理解其工作方式，就很难做出合理的配置。 本文所讨论的也不单纯是 DNS，还涉及 V2Ray…" />
    <meta data-rh="true" property="og:description"
        content="这篇文章目的是以非技术性例举方式，谈一谈各种 DNS 技术在代理环境中如何工作，主要集中在对 V2Ray 的使用上，因为最近 V2Ray 发布了一个 DNS…" />
    <meta data-rh="true" property="og:url"
        content="https://tachyondevel.medium.com/%E6%BC%AB%E8%B0%88%E5%90%84%E7%A7%8D%E9%BB%91%E7%A7%91%E6%8A%80%E5%BC%8F-dns-%E6%8A%80%E6%9C%AF%E5%9C%A8%E4%BB%A3%E7%90%86%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8-62c50e58cbd0" />
    <meta data-rh="true" property="al:web:url"
        content="https://tachyondevel.medium.com/%E6%BC%AB%E8%B0%88%E5%90%84%E7%A7%8D%E9%BB%91%E7%A7%91%E6%8A%80%E5%BC%8F-dns-%E6%8A%80%E6%9C%AF%E5%9C%A8%E4%BB%A3%E7%90%86%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8-62c50e58cbd0" />
    <meta data-rh="true" property="article:author" content="https://tachyondevel.medium.com" />
    <meta data-rh="true" name="author" content="Tachyon" />
    <meta data-rh="true" name="robots" content="index,follow,max-image-preview:large" />
    <meta data-rh="true" name="referrer" content="unsafe-url" />
    <meta data-rh="true" property="twitter:title" content="漫谈各种黑科技式 DNS 技术在代理环境中的应用" />
    <meta data-rh="true" name="twitter:site" content="@Medium" />
    <meta data-rh="true" name="twitter:app:url:iphone" content="medium://p/62c50e58cbd0" />
    <meta data-rh="true" property="twitter:description"
        content="这篇文章目的是以非技术性例举方式，谈一谈各种 DNS 技术在代理环境中如何工作，主要集中在对 V2Ray 的使用上，因为最近 V2Ray 发布了一个 DNS…" />
    <meta data-rh="true" name="twitter:card" content="summary" />
    <meta data-rh="true" name="twitter:label1" content="Reading time" />
    <meta data-rh="true" name="twitter:data1" content="38 min read" />
    <link data-rh="true" rel="icon" href="https://miro.medium.com/v2/1*m-R_BkNf1Qjr1YbyOIJY2w.png" />
    <link data-rh="true" rel="search" type="application/opensearchdescription+xml" title="Medium" href="/osd.xml" />
    <link data-rh="true" rel="apple-touch-icon" sizes="152x152"
        href="https://miro.medium.com/v2/resize:fill:152:152/1*sHhtYhaCe2Uc3IU0IgKwIQ.png" />
    <link data-rh="true" rel="apple-touch-icon" sizes="120x120"
        href="https://miro.medium.com/v2/resize:fill:120:120/1*sHhtYhaCe2Uc3IU0IgKwIQ.png" />
    <link data-rh="true" rel="apple-touch-icon" sizes="76x76"
        href="https://miro.medium.com/v2/resize:fill:76:76/1*sHhtYhaCe2Uc3IU0IgKwIQ.png" />
    <link data-rh="true" rel="apple-touch-icon" sizes="60x60"
        href="https://miro.medium.com/v2/resize:fill:60:60/1*sHhtYhaCe2Uc3IU0IgKwIQ.png" />
    <link data-rh="true" rel="mask-icon" href="https://cdn-static-1.medium.com/_/fp/icons/Medium-Avatar-500x500.svg"
        color="#171717" />
    <link data-rh="true" rel="preconnect" href="https://glyph.medium.com" crossOrigin="" />
    <link data-rh="true" id="glyph_preload_link" rel="preload" as="style" type="text/css"
        href="https://glyph.medium.com/css/unbound.css" />
    <link data-rh="true" id="glyph_link" rel="stylesheet" type="text/css"
        href="https://glyph.medium.com/css/unbound.css" />
    <link data-rh="true" rel="author" href="https://tachyondevel.medium.com" />
    <link data-rh="true" rel="canonical"
        href="https://tachyondevel.medium.com/%E6%BC%AB%E8%B0%88%E5%90%84%E7%A7%8D%E9%BB%91%E7%A7%91%E6%8A%80%E5%BC%8F-dns-%E6%8A%80%E6%9C%AF%E5%9C%A8%E4%BB%A3%E7%90%86%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8-62c50e58cbd0" />
    <link data-rh="true" rel="alternate" href="android-app://com.medium.reader/https/medium.com/p/62c50e58cbd0" />
    <script data-rh="true"
        type="application/ld+json">{"@context":"http:\u002F\u002Fschema.org","@type":"NewsArticle","image":{"@type":"ImageObject","url":"https:\u002F\u002Fmiro.medium.com\u002Fv2\u002F1*kFrc4tBFM_tCis-2Ic87WA.png","height":810,"width":1440},"url":"https:\u002F\u002Ftachyondevel.medium.com\u002F%E6%BC%AB%E8%B0%88%E5%90%84%E7%A7%8D%E9%BB%91%E7%A7%91%E6%8A%80%E5%BC%8F-dns-%E6%8A%80%E6%9C%AF%E5%9C%A8%E4%BB%A3%E7%90%86%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8-62c50e58cbd0","dateCreated":"2019-02-15T20:42:00.917Z","datePublished":"2019-02-15T20:42:00.917Z","dateModified":"2022-10-28T07:40:52.845Z","headline":"漫谈各种黑科技式 DNS 技术在代理环境中的应用 - Tachyon - Medium","name":"漫谈各种黑科技式 DNS 技术在代理环境中的应用 - Tachyon - Medium","description":"这篇文章目的是以非技术性例举方式，谈一谈各种 DNS 技术在代理环境中如何工作，主要集中在对 V2Ray 的使用上，因为最近 V2Ray 发布了一个 DNS 相关的功能：https:\u002F\u002Fsteemit.com\u002Fcn\u002F@v2ray\u002Fdns，其用法很多，可以解决很多问题，但如果不理解其工作方式，就很难做出合理的配置。 本文所讨论的也不单纯是 DNS，还涉及 V2Ray…","identifier":"62c50e58cbd0","author":{"@type":"Person","name":"Tachyon","url":"https:\u002F\u002Ftachyondevel.medium.com"},"creator":["Tachyon"],"publisher":{"@type":"Organization","name":"Medium","url":"https:\u002F\u002Ftachyondevel.medium.com\u002F","logo":{"@type":"ImageObject","width":308,"height":60,"url":"https:\u002F\u002Fmiro.medium.com\u002Fv2\u002Fresize:fit:616\u002F1*OMF3fSqH8t4xBJ9-6oZDZw.png"}},"mainEntityOfPage":"https:\u002F\u002Ftachyondevel.medium.com\u002F%E6%BC%AB%E8%B0%88%E5%90%84%E7%A7%8D%E9%BB%91%E7%A7%91%E6%8A%80%E5%BC%8F-dns-%E6%8A%80%E6%9C%AF%E5%9C%A8%E4%BB%A3%E7%90%86%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8-62c50e58cbd0"}</script>
    <style type="text/css" data-fela-rehydration="513" data-fela-type="STATIC">
        html {
            box-sizing: border-box;
            -webkit-text-size-adjust: 100%
        }

        *,
        *:before,
        *:after {
            box-sizing: inherit
        }

        body {
            margin: 0;
            padding: 0;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            color: rgba(0, 0, 0, 0.8);
            position: relative;
            min-height: 100vh;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        dl,
        dd,
        ol,
        ul,
        menu,
        figure,
        blockquote,
        p,
        pre,
        form {
            margin: 0
        }

        menu,
        ol,
        ul {
            padding: 0;
            list-style: none;
            list-style-image: none
        }

        main {
            display: block
        }

        a {
            color: inherit;
            text-decoration: none
        }

        a,
        button,
        input {
            -webkit-tap-highlight-color: transparent
        }

        img,
        svg {
            vertical-align: middle
        }

        button {
            background: transparent;
            overflow: visible
        }

        button,
        input,
        optgroup,
        select,
        textarea {
            margin: 0
        }


        :root {
            --reach-tabs: 1;
            --reach-menu-button: 1
        }

        #speechify-root {
            font-family: Sohne, sans-serif
        }

        div[data-popper-reference-hidden="true"] {
            visibility: hidden;
            pointer-events: none
        }

        .grecaptcha-badge {
            visibility: hidden
        }

        /*XCode style (c) Angel Garcia <angelgarcia.mail@gmail.com>*/
        .hljs {
            background: #fff;
            color: black;
        }

        /* Gray DOCTYPE selectors like WebKit */
        .xml .hljs-meta {
            color: #c0c0c0;
        }

        .hljs-comment,
        .hljs-quote {
            color: #007400;
        }

        .hljs-tag,
        .hljs-attribute,
        .hljs-keyword,
        .hljs-selector-tag,
        .hljs-literal,
        .hljs-name {
            color: #aa0d91;
        }

        .hljs-variable,
        .hljs-template-variable {
            color: #3F6E74;
        }

        .hljs-code,
        .hljs-string,
        .hljs-meta .hljs-string {
            color: #c41a16;
        }

        .hljs-regexp,
        .hljs-link {
            color: #0E0EFF;
        }

        .hljs-title,
        .hljs-symbol,
        .hljs-bullet,
        .hljs-number {
            color: #1c00cf;
        }

        .hljs-section,
        .hljs-meta {
            color: #643820;
        }

        .hljs-title.class_,
        .hljs-class .hljs-title,
        .hljs-type,
        .hljs-built_in,
        .hljs-params {
            color: #5c2699;
        }

        .hljs-attr {
            color: #836C28;
        }

        .hljs-subst {
            color: #000;
        }

        .hljs-formula {
            background-color: #eee;
            font-style: italic;
        }

        .hljs-addition {
            background-color: #baeeba;
        }

        .hljs-deletion {
            background-color: #ffc8bd;
        }

        .hljs-selector-id,
        .hljs-selector-class {
            color: #9b703f;
        }

        .hljs-doctag,
        .hljs-strong {
            font-weight: bold;
        }

        .hljs-emphasis {
            font-style: italic;
        }
    </style>
    <style type="text/css" data-fela-rehydration="513" data-fela-type="KEYFRAME">
        @-webkit-keyframes k1 {
            0% {
                opacity: 0.8
            }

            50% {
                opacity: 0.5
            }

            100% {
                opacity: 0.8
            }
        }

        @-moz-keyframes k1 {
            0% {
                opacity: 0.8
            }

            50% {
                opacity: 0.5
            }

            100% {
                opacity: 0.8
            }
        }

        @keyframes k1 {
            0% {
                opacity: 0.8
            }

            50% {
                opacity: 0.5
            }

            100% {
                opacity: 0.8
            }
        }
    </style>
    <style type="text/css" data-fela-rehydration="513" data-fela-type="RULE">
        .a {
            font-family: medium-content-sans-serif-font, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif
        }

        .b {
            font-weight: 400
        }

        .c {
            background-color: rgba(255, 255, 255, 1)
        }

        .l {
            display: block
        }

        .m {
            position: sticky
        }

        .n {
            top: 0
        }

        .o {
            z-index: 500
        }

        .p {
            padding: 0 24px
        }

        .q {
            align-items: center
        }

        .r {
            border-bottom: solid 1px #F2F2F2
        }

        .y {
            height: 41px
        }

        .z {
            line-height: 20px
        }

        .ab {
            display: flex
        }

        .ac {
            height: 57px
        }

        .ae {
            flex: 1 0 auto
        }

        .af {
            color: inherit
        }

        .ag {
            fill: inherit
        }

        .ah {
            font-size: inherit
        }

        .ai {
            border: inherit
        }

        .aj {
            font-family: inherit
        }

        .ak {
            letter-spacing: inherit
        }

        .al {
            font-weight: inherit
        }

        .am {
            padding: 0
        }

        .an {
            margin: 0
        }

        .ao {
            cursor: pointer
        }

        .ap:disabled {
            cursor: not-allowed
        }

        .aq:disabled {
            color: #6B6B6B
        }

        .ar:disabled {
            fill: #6B6B6B
        }

        .au {
            fill: rgba(0, 0, 0, 1)
        }

        .av {
            height: 22px
        }

        .aw {
            margin-left: 16px
        }

        .ax {
            border: none
        }

        .ay {
            border-radius: 20px
        }

        .az {
            width: 240px
        }

        .ba {
            background: #F9F9F9
        }

        .bb path {
            fill: #6B6B6B
        }

        .bd {
            outline: none
        }

        .be {
            font-family: sohne, "Helvetica Neue", Helvetica, Arial, sans-serif
        }

        .bf {
            font-size: 14px
        }

        .bg {
            width: 100%
        }

        .bh {
            padding: 10px 20px 10px 0
        }

        .bi {
            background-color: transparent
        }

        .bj {
            color: #242424
        }

        .bk::placeholder {
            color: #6B6B6B
        }

        .bl {
            display: inline-block
        }

        .bm {
            margin-left: 12px
        }

        .bn {
            margin-right: 12px
        }

        .bo {
            border-radius: 4px
        }

        .bp {
            margin-left: 24px
        }

        .bq {
            height: 24px
        }

        .bw {
            background-color: #F9F9F9
        }

        .bx {
            border-radius: 50%
        }

        .by {
            height: 32px
        }

        .bz {
            width: 32px
        }

        .ca {
            justify-content: center
        }

        .cg {
            max-width: 680px
        }

        .ch {
            min-width: 0
        }

        .ci {
            animation: k1 1.2s ease-in-out infinite
        }

        .cj {
            height: 100vh
        }

        .ck {
            margin-bottom: 16px
        }

        .cl {
            margin-top: 48px
        }

        .cm {
            align-items: flex-start
        }

        .cn {
            flex-direction: column
        }

        .co {
            justify-content: space-between
        }

        .cp {
            margin-bottom: 24px
        }

        .cv {
            width: 80%
        }

        .cw {
            background-color: #F2F2F2
        }

        .dc {
            height: 44px
        }

        .dd {
            width: 44px
        }

        .de {
            margin: auto 0
        }

        .df {
            margin-bottom: 4px
        }

        .dg {
            height: 16px
        }

        .dh {
            width: 120px
        }

        .di {
            width: 80px
        }

        .do {
            margin-bottom: 8px
        }

        .dp {
            width: 96%
        }

        .dq {
            width: 98%
        }

        .dr {
            width: 81%
        }

        .ds {
            margin-left: 8px
        }

        .dt {
            color: #6B6B6B
        }

        .du {
            font-size: 13px
        }

        .dv {
            height: 100%
        }

        .eo {
            color: #FFFFFF
        }

        .ep {
            fill: #FFFFFF
        }

        .eq {
            background: #1A8917
        }

        .er {
            border-color: #1A8917
        }

        .ev:disabled {
            cursor: inherit !important
        }

        .ew:disabled {
            opacity: 0.3
        }

        .ex:disabled:hover {
            background: #1A8917
        }

        .ey:disabled:hover {
            border-color: #1A8917
        }

        .ez {
            border-radius: 99em
        }

        .fa {
            border-width: 1px
        }

        .fb {
            border-style: solid
        }

        .fc {
            box-sizing: border-box
        }

        .fd {
            text-decoration: none
        }

        .fe {
            text-align: center
        }

        .fh {
            margin-right: 32px
        }

        .fi {
            position: relative
        }

        .fj {
            fill: #6B6B6B
        }

        .fm {
            background: transparent
        }

        .fn svg {
            margin-left: 4px
        }

        .fo svg {
            fill: #6B6B6B
        }

        .fq {
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.05)
        }

        .fr {
            position: absolute
        }

        .fy {
            margin: 0 24px
        }

        .gc {
            background: rgba(255, 255, 255, 1)
        }

        .gd {
            border: 1px solid #F2F2F2
        }

        .ge {
            box-shadow: 0 1px 4px #F2F2F2
        }

        .gf {
            max-height: 100vh
        }

        .gg {
            overflow-y: auto
        }

        .gh {
            left: 0
        }

        .gi {
            top: calc(100vh + 100px)
        }

        .gj {
            bottom: calc(100vh + 100px)
        }

        .gk {
            width: 10px
        }

        .gl {
            pointer-events: none
        }

        .gm {
            word-break: break-word
        }

        .gn {
            word-wrap: break-word
        }

        .go:after {
            display: block
        }

        .gp:after {
            content: ""
        }

        .gq:after {
            clear: both
        }

        .gr {
            line-height: 1.23
        }

        .gs {
            letter-spacing: 0
        }

        .gt {
            font-style: normal
        }

        .gu {
            font-weight: 700
        }

        /* .hu {
            @media all and (max-width: 551.98px): 8px
        }

        .hv {
            @media all and (min-width: 552px) and (max-width: 727.98px): 8px
        }

        .hw {
            @media all and (min-width: 728px) and (max-width: 903.98px): 16px
        }

        .hx {
            @media all and (min-width: 904px) and (max-width: 1079.98px): 16px
        }

        .hy {
            @media all and (min-width: 1080px): 16px
        } */

        .ie {
            align-items: baseline
        }

        .if {
            width: 48px
        }

        .ig {
            height: 48px
        }

        .ih {
            border: 2px solid rgba(255, 255, 255, 1)
        }

        .ii {
            z-index: 0
        }

        .ij {
            box-shadow: none
        }

        .ik {
            border: 1px solid rgba(0, 0, 0, 0.05)
        }

        .il {
            margin-bottom: 2px
        }

        .im {
            flex-wrap: nowrap
        }

        .in {
            font-size: 16px
        }

        .io {
            line-height: 24px
        }

        .iq {
            margin: 0 8px
        }

        .ir {
            display: inline
        }

        .is {
            color: #1A8917
        }

        .it {
            fill: #1A8917
        }

        .iw {
            flex: 0 0 auto
        }

        .iz {
            flex-wrap: wrap
        }

        .ja {
            padding-left: 8px
        }

        .jb {
            padding-right: 8px
        }

        .kc>* {
            flex-shrink: 0
        }

        .kd {
            overflow-x: scroll
        }

        .ke::-webkit-scrollbar {
            display: none
        }

        .kf {
            scrollbar-width: none
        }

        .kg {
            -ms-overflow-style: none
        }

        .kh {
            width: 74px
        }

        .ki {
            flex-direction: row
        }

        .kj {
            z-index: 2
        }

        .kk {
            margin-right: 4px
        }

        /* 
        .kn {
            -webkit-user-select: none
        } */

        .ko {
            border: 0
        }

        .kp {
            fill: rgba(117, 117, 117, 1)
        }

        .ks {
            outline: 0
        }

        .kt {
            user-select: none
        }

        .ku>svg {
            pointer-events: none
        }

        .ld {
            cursor: progress
        }

        .le {
            margin-left: 4px
        }

        .lf {
            margin-top: 0px
        }

        .lg {
            opacity: 1
        }

        .lh {
            padding: 4px 0
        }

        .lk {
            width: 16px
        }

        .lm {
            padding: 8px 2px
        }

        .ln svg {
            color: #6B6B6B
        }

        .me {
            line-height: 1.58
        }

        .mf {
            letter-spacing: -0.004em
        }

        .mg {
            font-family: source-serif-pro, Georgia, Cambria, "Times New Roman", Times, serif
        }

        .nb {
            margin-bottom: -0.46em
        }

        .nc {
            text-decoration: underline
        }

        .nd {
            line-height: 1.18
        }

        .ne {
            letter-spacing: -0.022em
        }

        .nf {
            font-weight: 600
        }

        .nv {
            margin-bottom: -0.31em
        }

        .og {
            overflow-x: auto
        }

        .oh {
            font-family: source-code-pro, Menlo, Monaco, "Courier New", Courier, monospace
        }

        .oi {
            padding: 20px
        }

        .oj {
            border-radius: 0
        }

        .ok {
            background: #F2F2F2
        }

        .ol {
            margin-top: -0.09em
        }

        .om {
            margin-bottom: -0.09em
        }

        .on {
            white-space: pre-wrap
        }

        .oo {
            min-width: fit-content
        }

        .op {
            margin-top: 0.91em
        }

        .oq {
            box-shadow: inset 3px 0 0 0 #242424
        }

        .or {
            padding-left: 23px
        }

        .os {
            margin-left: -20px
        }

        .ot {
            font-style: italic
        }

        .ou {
            padding: 2px 4px
        }

        .ov {
            font-size: 75%
        }

        .ow>strong {
            font-family: inherit
        }

        .ox {
            list-style-type: decimal
        }

        .oy {
            margin-left: 30px
        }

        .oz {
            padding-left: 0px
        }

        .pk {
            box-shadow: inset 0 0 0 1px #F2F2F2
        }

        .pl {
            padding: 0px
        }

        .pm {
            padding: 16px 20px
        }

        .pn {
            flex: 1 1 auto
        }

        .pp {
            overflow: hidden
        }

        .pq {
            max-height: 40px
        }

        .pr {
            text-overflow: ellipsis
        }

        .ps {
            display: -webkit-box
        }

        .pt {
            -webkit-line-clamp: 2
        }

        .pu {
            -webkit-box-orient: vertical
        }

        .pw {
            margin-top: 8px
        }

        .px {
            margin-top: 12px
        }

        .py {
            width: 160px
        }

        .pz {
            background-image: url(https://miro.medium.com/v2/resize:fit:320/1*FMxGqnBy9DV48g4yZ_vWKg.png)
        }

        .qa {
            background-origin: border-box
        }

        .qb {
            background-size: cover
        }

        .qc {
            height: 167px
        }

        .qd {
            background-position: 50% 50%
        }

        .qe {
            max-width: 100%
        }

        .qf {
            list-style-type: disc
        }

        .qg {
            margin-bottom: 26px
        }

        .qh {
            margin-top: 6px
        }

        .qi {
            margin-right: 8px
        }

        .qj {
            padding: 8px 16px
        }

        .qk {
            border-radius: 100px
        }

        .ql {
            transition: background 300ms ease
        }

        .qn {
            white-space: nowrap
        }

        .qo {
            border-top: none
        }

        .qu {
            height: 52px
        }

        .qv {
            max-height: 52px
        }

        .qw {
            box-sizing: content-box
        }

        .qx {
            position: static
        }

        .qy {
            z-index: 1
        }

        .ra {
            max-width: 155px
        }

        .rg {
            margin-right: 20px
        }

        .rm {
            align-items: flex-end
        }

        .rn {
            width: 76px
        }

        .ro {
            height: 76px
        }

        .rp {
            border: 2px solid #F9F9F9
        }

        .rq {
            height: 72px
        }

        .rr {
            width: 72px
        }

        .rs {
            width: auto
        }

        .rt {
            stroke: #F2F2F2
        }

        .ru {
            height: 36px
        }

        .rv {
            width: 36px
        }

        .rw {
            color: #F2F2F2
        }

        .rx {
            fill: #F2F2F2
        }

        .ry {
            border-color: #F2F2F2
        }

        .se {
            font-weight: 500
        }

        .sf {
            font-size: 24px
        }

        .sg {
            line-height: 30px
        }

        .sh {
            letter-spacing: -0.016em
        }

        .si {
            margin-top: 16px
        }

        .sj {
            height: 0px
        }

        .sk {
            border-bottom: solid 1px #E5E5E5
        }

        .sq {
            margin-top: 72px
        }

        .sr {
            padding: 24px 0
        }

        .ss {
            margin-bottom: 0px
        }

        .st {
            margin-right: 16px
        }

        .as:hover:not(:disabled) {
            color: rgba(25, 25, 25, 1)
        }

        .at:hover:not(:disabled) {
            fill: rgba(25, 25, 25, 1)
        }

        .es:hover {
            background: #156D12
        }

        .et:hover {
            border-color: #156D12
        }

        .eu:hover {
            cursor: pointer
        }

        .fk:hover {
            color: #242424
        }

        .fl:hover {
            fill: #242424
        }

        .fp:hover svg {
            fill: #242424
        }

        .fs:hover {
            background-color: rgba(0, 0, 0, 0.1)
        }

        .ip:hover {
            text-decoration: underline
        }

        .iu:hover:not(:disabled) {
            color: #156D12
        }

        .iv:hover:not(:disabled) {
            fill: #156D12
        }

        .kr:hover {
            fill: rgba(8, 8, 8, 1)
        }

        .li:hover {
            fill: #000000
        }

        .lj:hover p {
            color: #000000
        }

        .ll:hover {
            color: #000000
        }

        .lo:hover svg {
            color: #000000
        }

        .qm:hover {
            background-color: #F2F2F2
        }

        .rz:hover {
            background: #F2F2F2
        }

        .sa:hover {
            border-color: #F2F2F2
        }

        .sb:hover {
            cursor: wait
        }

        .sc:hover {
            color: #F2F2F2
        }

        .sd:hover {
            fill: #F2F2F2
        }

        .bc:focus-within path {
            fill: #242424
        }

        .kq:focus {
            fill: rgba(8, 8, 8, 1)
        }

        .lp:focus svg {
            color: #000000
        }

        .kv:active {
            border-style: none
        }
    </style>
    <style type="text/css" data-fela-rehydration="513" data-fela-type="RULE" media="all and (min-width: 1080px)">
        .d {
            display: none
        }

        .bv {
            width: 64px
        }

        .cf {
            margin: 0 64px
        }

        .cu {
            height: 48px
        }

        .db {
            margin-bottom: 52px
        }

        .dn {
            margin-bottom: 48px
        }

        .ee {
            font-size: 14px
        }

        .ef {
            line-height: 20px
        }

        .el {
            font-size: 13px
        }

        .em {
            padding: 5px 12px
        }

        .fg {
            display: flex
        }

        .fx {
            margin-bottom: 68px
        }

        .gb {
            max-width: 680px
        }

        .hp {
            font-size: 42px
        }

        .hq {
            margin-top: 1.19em
        }

        .hr {
            margin-bottom: 32px
        }

        .hs {
            line-height: 52px
        }

        .ht {
            letter-spacing: -0.011em
        }

        .id {
            align-items: center
        }

        .jo {
            border-top: solid 1px #F2F2F2
        }

        .jp {
            border-bottom: solid 1px #F2F2F2
        }

        .jq {
            margin: 32px 0 0
        }

        .jr {
            padding: 3px 8px
        }

        .ka>* {
            margin-right: 24px
        }

        .kb> :last-child {
            margin-right: 0
        }

        .lc {
            margin-top: 0px
        }

        .mx {
            font-size: 20px
        }

        .my {
            margin-top: 2.14em
        }

        .mz {
            line-height: 32px
        }

        .na {
            letter-spacing: -0.003em
        }

        .ns {
            margin-top: 1.72em
        }

        .nt {
            line-height: 24px
        }

        .nu {
            letter-spacing: 0
        }

        .oa {
            margin-top: 0.94em
        }

        .of {
            margin-top: 56px
        }

        .pe {
            margin-top: 1.14em
        }

        .pj {
            margin-top: 32px
        }

        .qt {
            margin-bottom: 88px
        }

        .rf {
            display: inline-block
        }

        .rl {
            padding-top: 72px
        }

        .sp {
            margin-top: 40px
        }
    </style>
    <style type="text/css" data-fela-rehydration="513" data-fela-type="RULE" media="all and (max-width: 1079.98px)">
        .e {
            display: none
        }

        .lb {
            margin-top: 0px
        }

        .re {
            display: inline-block
        }
    </style>
    <style type="text/css" data-fela-rehydration="513" data-fela-type="RULE" media="all and (max-width: 903.98px)">
        .f {
            display: none
        }

        .la {
            margin-top: 0px
        }

        .rd {
            display: inline-block
        }
    </style>
    <style type="text/css" data-fela-rehydration="513" data-fela-type="RULE" media="all and (max-width: 727.98px)">
        .g {
            display: none
        }

        .ky {
            margin-top: 0px
        }

        .kz {
            margin-right: 0px
        }

        .po {
            padding: 10px 12px 10px
        }

        .rc {
            display: inline-block
        }
    </style>
    <style type="text/css" data-fela-rehydration="513" data-fela-type="RULE" media="all and (max-width: 551.98px)">
        .h {
            display: none
        }

        .s {
            display: flex
        }

        .t {
            justify-content: space-between
        }

        .br {
            width: 24px
        }

        .cb {
            margin: 0 24px
        }

        .cq {
            height: 40px
        }

        .cx {
            margin-bottom: 44px
        }

        .dj {
            margin-bottom: 32px
        }

        .dw {
            font-size: 13px
        }

        .dx {
            line-height: 20px
        }

        .eg {
            padding: 0px 8px 1px
        }

        .ft {
            margin-bottom: 4px
        }

        .gv {
            font-size: 32px
        }

        .gw {
            margin-top: 1.01em
        }

        .gx {
            margin-bottom: 24px
        }

        .gy {
            line-height: 38px
        }

        .gz {
            letter-spacing: -0.014em
        }

        .hz {
            align-items: flex-start
        }

        .ix {
            flex-direction: column
        }

        .jc {
            margin: 24px -24px 0
        }

        .jd {
            padding: 0
        }

        .js>* {
            margin-right: 8px
        }

        .jt> :last-child {
            margin-right: 24px
        }

        .kl {
            margin-left: 0px
        }

        .kw {
            margin-top: 0px
        }

        .kx {
            margin-right: 0px
        }

        .lq {
            border: 1px solid #F2F2F2
        }

        .lr {
            border-radius: 99em
        }

        .ls {
            padding: 0px 16px 0px 12px
        }

        .lt {
            height: 38px
        }

        .lu {
            align-items: center
        }

        .lw svg {
            margin-right: 8px
        }

        .mh {
            font-size: 18px
        }

        .mi {
            margin-top: 1.56em
        }

        .mj {
            line-height: 28px
        }

        .mk {
            letter-spacing: -0.003em
        }

        .ng {
            font-size: 16px
        }

        .nh {
            margin-top: 1.23em
        }

        .ni {
            letter-spacing: 0
        }

        .nw {
            margin-top: 0.67em
        }

        .ob {
            margin-top: 40px
        }

        .pa {
            margin-top: 1.34em
        }

        .pf {
            margin-top: 24px
        }

        .qp {
            margin-bottom: 80px
        }

        .rb {
            display: inline-block
        }

        .rh {
            padding-top: 48px
        }

        .sl {
            margin-top: 32px
        }

        .lv:hover {
            border-color: #E5E5E5
        }
    </style>
    <style type="text/css" data-fela-rehydration="513" data-fela-type="RULE"
        media="all and (min-width: 904px) and (max-width: 1079.98px)">
        .i {
            display: none
        }

        .bu {
            width: 64px
        }

        .ce {
            margin: 0 64px
        }

        .ct {
            height: 48px
        }

        .da {
            margin-bottom: 52px
        }

        .dm {
            margin-bottom: 48px
        }

        .ec {
            font-size: 14px
        }

        .ed {
            line-height: 20px
        }

        .ej {
            font-size: 13px
        }

        .ek {
            padding: 5px 12px
        }

        .ff {
            display: flex
        }

        .fw {
            margin-bottom: 68px
        }

        .ga {
            max-width: 680px
        }

        .hk {
            font-size: 42px
        }

        .hl {
            margin-top: 1.19em
        }

        .hm {
            margin-bottom: 32px
        }

        .hn {
            line-height: 52px
        }

        .ho {
            letter-spacing: -0.011em
        }

        .ic {
            align-items: center
        }

        .jk {
            border-top: solid 1px #F2F2F2
        }

        .jl {
            border-bottom: solid 1px #F2F2F2
        }

        .jm {
            margin: 32px 0 0
        }

        .jn {
            padding: 3px 8px
        }

        .jy>* {
            margin-right: 24px
        }

        .jz> :last-child {
            margin-right: 0
        }

        .mt {
            font-size: 20px
        }

        .mu {
            margin-top: 2.14em
        }

        .mv {
            line-height: 32px
        }

        .mw {
            letter-spacing: -0.003em
        }

        .np {
            margin-top: 1.72em
        }

        .nq {
            line-height: 24px
        }

        .nr {
            letter-spacing: 0
        }

        .nz {
            margin-top: 0.94em
        }

        .oe {
            margin-top: 56px
        }

        .pd {
            margin-top: 1.14em
        }

        .pi {
            margin-top: 32px
        }

        .qs {
            margin-bottom: 88px
        }

        .rk {
            padding-top: 72px
        }

        .so {
            margin-top: 40px
        }
    </style>
    <style type="text/css" data-fela-rehydration="513" data-fela-type="RULE"
        media="all and (min-width: 728px) and (max-width: 903.98px)">
        .j {
            display: none
        }

        .w {
            display: flex
        }

        .x {
            justify-content: space-between
        }

        .bt {
            width: 64px
        }

        .cd {
            margin: 0 48px
        }

        .cs {
            height: 48px
        }

        .cz {
            margin-bottom: 52px
        }

        .dl {
            margin-bottom: 48px
        }

        .ea {
            font-size: 13px
        }

        .eb {
            line-height: 20px
        }

        .ei {
            padding: 0px 8px 1px
        }

        .fv {
            margin-bottom: 68px
        }

        .fz {
            max-width: 680px
        }

        .hf {
            font-size: 42px
        }

        .hg {
            margin-top: 1.19em
        }

        .hh {
            margin-bottom: 32px
        }

        .hi {
            line-height: 52px
        }

        .hj {
            letter-spacing: -0.011em
        }

        .ib {
            align-items: center
        }

        .jg {
            border-top: solid 1px #F2F2F2
        }

        .jh {
            border-bottom: solid 1px #F2F2F2
        }

        .ji {
            margin: 32px 0 0
        }

        .jj {
            padding: 3px 8px
        }

        .jw>* {
            margin-right: 24px
        }

        .jx> :last-child {
            margin-right: 0
        }

        .mp {
            font-size: 20px
        }

        .mq {
            margin-top: 2.14em
        }

        .mr {
            line-height: 32px
        }

        .ms {
            letter-spacing: -0.003em
        }

        .nm {
            margin-top: 1.72em
        }

        .nn {
            line-height: 24px
        }

        .no {
            letter-spacing: 0
        }

        .ny {
            margin-top: 0.94em
        }

        .od {
            margin-top: 56px
        }

        .pc {
            margin-top: 1.14em
        }

        .ph {
            margin-top: 32px
        }

        .qr {
            margin-bottom: 88px
        }

        .rj {
            padding-top: 72px
        }

        .sn {
            margin-top: 40px
        }
    </style>
    <style type="text/css" data-fela-rehydration="513" data-fela-type="RULE"
        media="all and (min-width: 552px) and (max-width: 727.98px)">
        .k {
            display: none
        }

        .u {
            display: flex
        }

        .v {
            justify-content: space-between
        }

        .bs {
            width: 24px
        }

        .cc {
            margin: 0 24px
        }

        .cr {
            height: 40px
        }

        .cy {
            margin-bottom: 44px
        }

        .dk {
            margin-bottom: 32px
        }

        .dy {
            font-size: 13px
        }

        .dz {
            line-height: 20px
        }

        .eh {
            padding: 0px 8px 1px
        }

        .fu {
            margin-bottom: 4px
        }

        .ha {
            font-size: 32px
        }

        .hb {
            margin-top: 1.01em
        }

        .hc {
            margin-bottom: 24px
        }

        .hd {
            line-height: 38px
        }

        .he {
            letter-spacing: -0.014em
        }

        .ia {
            align-items: flex-start
        }

        .iy {
            flex-direction: column
        }

        .je {
            margin: 24px 0 0
        }

        .jf {
            padding: 0
        }

        .ju>* {
            margin-right: 8px
        }

        .jv> :last-child {
            margin-right: 8px
        }

        .km {
            margin-left: 0px
        }

        .lx {
            border: 1px solid #F2F2F2
        }

        .ly {
            border-radius: 99em
        }

        .lz {
            padding: 0px 16px 0px 12px
        }

        .ma {
            height: 38px
        }

        .mb {
            align-items: center
        }

        .md svg {
            margin-right: 8px
        }

        .ml {
            font-size: 18px
        }

        .mm {
            margin-top: 1.56em
        }

        .mn {
            line-height: 28px
        }

        .mo {
            letter-spacing: -0.003em
        }

        .nj {
            font-size: 16px
        }

        .nk {
            margin-top: 1.23em
        }

        .nl {
            letter-spacing: 0
        }

        .nx {
            margin-top: 0.67em
        }

        .oc {
            margin-top: 40px
        }

        .pb {
            margin-top: 1.34em
        }

        .pg {
            margin-top: 24px
        }

        .qq {
            margin-bottom: 80px
        }

        .ri {
            padding-top: 48px
        }

        .sm {
            margin-top: 32px
        }

        .mc:hover {
            border-color: #E5E5E5
        }
    </style>
    <style type="text/css" data-fela-rehydration="513" data-fela-type="RULE" media="print">
        .qz {
            display: none
        }
    </style>
    <style type="text/css" data-fela-rehydration="513" data-fela-type="RULE"
        media="(orientation: landscape) and (max-width: 903.98px)">
        .pv {
            max-height: none
        }
    </style>
</head>

<body>
    <div id="root" style="overflow: auto;-ms-overflow-style: none; scrollbar-width: none;  ">
        <div class="a b c">
            <div class="d e f g h i j k"></div>
            <script>document.domain = document.domain;</script>
            <div class="l c">
                <div class="l m n o c">
                    <div class="p q r s t u v w x i d y z"><a
                            class="dt ag du be ak b am an ao ap aq ar as at s u w i d q dv z"
                            href="https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F62c50e58cbd0&amp;%7Efeature=LoOpenInAppButton&amp;%7Echannel=ShowPostUnderUser&amp;source=---two_column_layout_nav----------------------------------"
                            rel="noopener follow">Open in app<svg width="10" height="10" viewBox="0 0 10 10" fill="none"
                                class="ds">
                                <path
                                    d="M.98 8.48a.37.37 0 1 0 .54.54l-.54-.54zm7.77-7.23h.38c0-.2-.17-.38-.38-.38v.38zM8.37 6.5a.37.37 0 1 0 .76 0h-.76zM3.5.87a.37.37 0 1 0 0 .76V.88zM1.52 9.03l7.5-7.5-.54-.54-7.5 7.5.54.54zm6.86-7.77V6.5h.74V1.25h-.74zm-4.88.38h5.25V.88H3.5v.74z"
                                    fill="currentColor"></path>
                            </svg></a>
                        <div class="ab q">
                            <p class="be b dw dx dy dz ea eb ec ed ee ef dt"><span><button
                                        class="be b dw dx eg dy dz eh ea eb ei ej ed ek el ef em eo ep eq er es et eu ev ew ex ey ez fa fb fc bl fd fe"
                                        data-testid="headerSignUpButton">Sign up</button></span></p>
                            <div class="aw l">
                                <p class="be b dw dx dy dz ea eb ec ed ee ef dt"><span><a
                                            class="af ag ah ai aj ak al am an ao ap aq ar as at"
                                            data-testid="headerSignInButton"
                                            href="https://medium.com/m/signin?operation=login&amp;redirect=https%3A%2F%2Ftachyondevel.medium.com%2F%E6%BC%AB%E8%B0%88%E5%90%84%E7%A7%8D%E9%BB%91%E7%A7%91%E6%8A%80%E5%BC%8F-dns-%E6%8A%80%E6%9C%AF%E5%9C%A8%E4%BB%A3%E7%90%86%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8-62c50e58cbd0&amp;source=post_page---two_column_layout_nav-----------------------global_nav-----------"
                                            rel="noopener follow">Sign in</a></span></p>
                            </div>
                        </div>
                    </div>
                    <div class="p q r ab ac">
                        <div class="ab q ae"><a class="af ag ah ai aj ak al am an ao ap aq ar as at ab"
                                aria-label="Homepage" data-testid="headerMediumLogo"
                                href="https://medium.com/?source=---two_column_layout_nav----------------------------------"
                                rel="noopener follow"><svg viewBox="0 0 3940 610" class="au av">
                                    <path
                                        d="M594.79 308.2c0 163.76-131.85 296.52-294.5 296.52S5.8 472 5.8 308.2 137.65 11.69 300.29 11.69s294.5 132.75 294.5 296.51M917.86 308.2c0 154.16-65.93 279.12-147.25 279.12s-147.25-125-147.25-279.12S689.29 29.08 770.61 29.08s147.25 125 147.25 279.12M1050 308.2c0 138.12-23.19 250.08-51.79 250.08s-51.79-112-51.79-250.08 23.19-250.08 51.8-250.08S1050 170.09 1050 308.2M1862.77 37.4l.82-.18v-6.35h-167.48l-155.51 365.5-155.51-365.5h-180.48v6.35l.81.18c30.57 6.9 46.09 17.19 46.09 54.3v434.45c0 37.11-15.58 47.4-46.15 54.3l-.81.18V587H1327v-6.35l-.81-.18c-30.57-6.9-46.09-17.19-46.09-54.3V116.9L1479.87 587h11.33l205.59-483.21V536.9c-2.62 29.31-18 38.36-45.68 44.61l-.82.19v6.3h213.3v-6.3l-.82-.19c-27.71-6.25-43.46-15.3-46.08-44.61l-.14-445.2h.14c0-37.11 15.52-47.4 46.08-54.3m97.43 287.8c3.49-78.06 31.52-134.4 78.56-135.37 14.51.24 26.68 5 36.14 14.16 20.1 19.51 29.55 60.28 28.09 121.21zm-2.11 22h250v-1.05c-.71-59.69-18-106.12-51.34-138-28.82-27.55-71.49-42.71-116.31-42.71h-1c-23.26 0-51.79 5.64-72.09 15.86-23.11 10.7-43.49 26.7-60.45 47.7-27.3 33.83-43.84 79.55-47.86 130.93-.13 1.54-.24 3.08-.35 4.62s-.18 2.92-.25 4.39a332.64 332.64 0 0 0-.36 21.69C1860.79 507 1923.65 600 2035.3 600c98 0 155.07-71.64 169.3-167.8l-7.19-2.53c-25 51.68-69.9 83-121 79.18-69.76-5.22-123.2-75.95-118.35-161.63m532.69 157.68c-8.2 19.45-25.31 30.15-48.24 30.15s-43.89-15.74-58.78-44.34c-16-30.7-24.42-74.1-24.42-125.51 0-107 33.28-176.21 84.79-176.21 21.57 0 38.55 10.7 46.65 29.37zm165.84 76.28c-30.57-7.23-46.09-18-46.09-57V5.28L2424.77 60v6.7l1.14-.09c25.62-2.07 43 1.47 53.09 10.79 7.9 7.3 11.75 18.5 11.75 34.26v71.14c-18.31-11.69-40.09-17.38-66.52-17.38-53.6 0-102.59 22.57-137.92 63.56-36.83 42.72-56.3 101.1-56.3 168.81C2230 518.72 2289.53 600 2378.13 600c51.83 0 93.53-28.4 112.62-76.3V588h166.65v-6.66zm159.29-505.33c0-37.76-28.47-66.24-66.24-66.24-37.59 0-67 29.1-67 66.24s29.44 66.24 67 66.24c37.77 0 66.24-28.48 66.24-66.24m43.84 505.33c-30.57-7.23-46.09-18-46.09-57h-.13V166.65l-166.66 47.85v6.5l1 .09c36.06 3.21 45.93 15.63 45.93 57.77V588h166.8v-6.66zm427.05 0c-30.57-7.23-46.09-18-46.09-57V166.65L3082 212.92v6.52l.94.1c29.48 3.1 38 16.23 38 58.56v226c-9.83 19.45-28.27 31-50.61 31.78-36.23 0-56.18-24.47-56.18-68.9V166.66l-166.66 47.85V221l1 .09c36.06 3.2 45.94 15.62 45.94 57.77v191.27a214.48 214.48 0 0 0 3.47 39.82l3 13.05c14.11 50.56 51.08 77 109 77 49.06 0 92.06-30.37 111-77.89v66h166.66v-6.66zM3934.2 588v-6.67l-.81-.19c-33.17-7.65-46.09-22.07-46.09-51.43v-243.2c0-75.83-42.59-121.09-113.93-121.09-52 0-95.85 30.05-112.73 76.86-13.41-49.6-52-76.86-109.06-76.86-50.12 0-89.4 26.45-106.25 71.13v-69.87l-166.66 45.89v6.54l1 .09c35.63 3.16 45.93 15.94 45.93 57V588h155.5v-6.66l-.82-.2c-26.46-6.22-35-17.56-35-46.66V255.72c7-16.35 21.11-35.72 49-35.72 34.64 0 52.2 24 52.2 71.28V588h155.54v-6.66l-.82-.2c-26.46-6.22-35-17.56-35-46.66v-248a160.45 160.45 0 0 0-2.2-27.68c7.42-17.77 22.34-38.8 51.37-38.8 35.13 0 52.2 23.31 52.2 71.28V588z">
                                    </path>
                                </svg></a>
                            <div class="aw h">
                                <div class="ab ax ay az ba q bb bc">
                                    <div class="bl" aria-hidden="false" aria-describedby="searchResults"
                                        aria-labelledby="searchResults"></div>
                                    <div class="bm bn ab"><svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                            <path fill-rule="evenodd" clip-rule="evenodd"
                                                d="M4.1 11.06a6.95 6.95 0 1 1 13.9 0 6.95 6.95 0 0 1-13.9 0zm6.94-8.05a8.05 8.05 0 1 0 5.13 14.26l3.75 3.75a.56.56 0 1 0 .8-.79l-3.74-3.73A8.05 8.05 0 0 0 11.04 3v.01z"
                                                fill="currentColor"></path>
                                        </svg></div><input role="combobox" aria-controls="searchResults"
                                        aria-expanded="false" aria-label="search" data-testid="headerSearchInput"
                                        tabindex="0" class="ax bd be bf z bg bh bi bj bk" placeholder="Search"
                                        value="" />
                                </div>
                            </div>
                        </div>
                        <div class="h k w ff fg">
                            <div class="fh ab"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at"
                                        data-testid="headerWriteButton"
                                        href="https://medium.com/m/signin?operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2Fnew-story&amp;source=---two_column_layout_nav-----------------------new_post_topnav-----------"
                                        rel="noopener follow">
                                        <div class="be b bf z dt fi fj ab q fk fl"><svg width="24" height="24"
                                                viewBox="0 0 24 24" fill="none" aria-label="Write">
                                                <path
                                                    d="M14 4a.5.5 0 0 0 0-1v1zm7 6a.5.5 0 0 0-1 0h1zm-7-7H4v1h10V3zM3 4v16h1V4H3zm1 17h16v-1H4v1zm17-1V10h-1v10h1zm-1 1a1 1 0 0 0 1-1h-1v1zM3 20a1 1 0 0 0 1 1v-1H3zM4 3a1 1 0 0 0-1 1h1V3z"
                                                    fill="currentColor"></path>
                                                <path
                                                    d="M17.5 4.5l-8.46 8.46a.25.25 0 0 0-.06.1l-.82 2.47c-.07.2.12.38.31.31l2.47-.82a.25.25 0 0 0 .1-.06L19.5 6.5m-2-2l2.32-2.32c.1-.1.26-.1.36 0l1.64 1.64c.1.1.1.26 0 .36L19.5 6.5m-2-2l2 2"
                                                    stroke="currentColor"></path>
                                            </svg>
                                            <div class="ds l">Write</div>
                                        </div>
                                    </a></span></div>
                        </div>
                        <div class="k j i d">
                            <div class="fh ab"><a class="af ag ah ai aj ak al am an ao ap aq ar as at"
                                    data-testid="headerSearchButton"
                                    href="https://medium.com/search?source=---two_column_layout_nav----------------------------------"
                                    rel="noopener follow">
                                    <div class="be b bf z dt fi fj ab q fk fl"><svg width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" aria-label="Search">
                                            <path fill-rule="evenodd" clip-rule="evenodd"
                                                d="M4.1 11.06a6.95 6.95 0 1 1 13.9 0 6.95 6.95 0 0 1-13.9 0zm6.94-8.05a8.05 8.05 0 1 0 5.13 14.26l3.75 3.75a.56.56 0 1 0 .8-.79l-3.74-3.73A8.05 8.05 0 0 0 11.04 3v.01z"
                                                fill="currentColor"></path>
                                        </svg></div>
                                </a></div>
                        </div>
                        <div class="fh h k j">
                            <div class="ab q">
                                <p class="be b dw dx dy dz ea eb ec ed ee ef dt"><span><button
                                            class="be b dw dx eg dy dz eh ea eb ei ej ed ek el ef em eo ep eq er es et eu ev ew ex ey ez fa fb fc bl fd fe"
                                            data-testid="headerSignUpButton">Sign up</button></span></p>
                                <div class="aw l">
                                    <p class="be b dw dx dy dz ea eb ec ed ee ef dt"><span><a
                                                class="af ag ah ai aj ak al am an ao ap aq ar as at"
                                                data-testid="headerSignInButton"
                                                href="https://medium.com/m/signin?operation=login&amp;redirect=https%3A%2F%2Ftachyondevel.medium.com%2F%E6%BC%AB%E8%B0%88%E5%90%84%E7%A7%8D%E9%BB%91%E7%A7%91%E6%8A%80%E5%BC%8F-dns-%E6%8A%80%E6%9C%AF%E5%9C%A8%E4%BB%A3%E7%90%86%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8-62c50e58cbd0&amp;source=post_page---two_column_layout_nav-----------------------global_nav-----------"
                                                rel="noopener follow">Sign in</a></span></p>
                                </div>
                            </div>
                        </div>
                        <div class="l" aria-hidden="false"><button class="ax fm am ab q ao fn fo fp"
                                aria-label="user options menu" data-testid="headerUserIcon">
                                <div class="l fi"><img alt="" class="l fc bx by bz cw"
                                        src="https://miro.medium.com/v2/resize:fill:64:64/1*dmbNkD5D-u45r44go_cf0g.png"
                                        width="32" height="32" loading="lazy" role="presentation" />
                                    <div class="fq bx l by bz fr n ax fs"></div>
                                </div>
                            </button></div>
                    </div>
                </div>
                <div class="l">
                    <div class="ft fu fv fw fx l">
                        <div class="ab ca">
                            <div class="ch bg fy fz ga gb"></div>
                        </div>
                        <article>
                            <div class="l">
                                <div class="l"><span class="l"></span>
                                    <section>
                                        <div>
                                            <div class="fr gh gi gj gk gl"></div>
                                            <div class="gm gn go gp gq">
                                                <div class="ab ca">
                                                    <div class="ch bg fy fz ga gb">
                                                        <div>
                                                            <h1 id="294d"
                                                                class="pw-post-title gr gs gt be gu gv gw gx gy gz ha hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq hr hs ht bj"
                                                                data-testid="storyTitle">漫谈各种黑科技式 DNS 技术在代理环境中的应用</h1>
                                                            <div class="hu hv hw hx hy">
                                                                <div class="speechify-ignore ab co">
                                                                    <div class="speechify-ignore bg l">
                                                                        <div class="hz ia ib ic id ab">
                                                                            <div>
                                                                                <div class="ab ie"><a
                                                                                        rel="noopener follow"
                                                                                        href="/?source=post_page-----62c50e58cbd0--------------------------------">
                                                                                        <div>
                                                                                            <div class="bl"
                                                                                                aria-hidden="false">
                                                                                                <div
                                                                                                    class="l if ig bx ih ii">
                                                                                                    <div class="l fi">
                                                                                                        <img alt="Tachyon"
                                                                                                            class="l fc bx dc dd cw"
                                                                                                            src="https://miro.medium.com/v2/resize:fill:88:88/0*8tbyh9DEBZIccKB1.jpg"
                                                                                                            width="44"
                                                                                                            height="44"
                                                                                                            loading="lazy"
                                                                                                            data-testid="authorPhoto" />
                                                                                                        <div
                                                                                                            class="ij bx l dc dd fr n ik fs">
                                                                                                        </div>
                                                                                                    </div>
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>
                                                                                    </a></div>
                                                                            </div>
                                                                            <div class="bm bg l">
                                                                                <div class="ab">
                                                                                    <div style="flex:1"><span
                                                                                            class="be b bf z bj">
                                                                                            <div class="il ab q">
                                                                                                <div class="ab q im">
                                                                                                    <div class="ab q">
                                                                                                        <div>
                                                                                                            <div class="bl"
                                                                                                                aria-hidden="false">
                                                                                                                <p
                                                                                                                    class="be b in io bj">
                                                                                                                    <a class="af ag ah ai aj ak al am an ao ap aq ar ip"
                                                                                                                        data-testid="authorName"
                                                                                                                        rel="noopener follow"
                                                                                                                        href="/?source=post_page-----62c50e58cbd0--------------------------------">Tachyon</a>
                                                                                                                </p>
                                                                                                            </div>
                                                                                                        </div>
                                                                                                    </div><span
                                                                                                        class="iq ir"
                                                                                                        aria-hidden="true"><span
                                                                                                            class="be b bf z dt">·</span></span>
                                                                                                    <p
                                                                                                        class="be b in io dt">
                                                                                                        <span><a class="is it ah ai aj ak al am an ao ap aq ar ew iu iv"
                                                                                                                href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F35c856cf9e4d&amp;operation=register&amp;redirect=https%3A%2F%2Ftachyondevel.medium.com%2F%E6%BC%AB%E8%B0%88%E5%90%84%E7%A7%8D%E9%BB%91%E7%A7%91%E6%8A%80%E5%BC%8F-dns-%E6%8A%80%E6%9C%AF%E5%9C%A8%E4%BB%A3%E7%90%86%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8-62c50e58cbd0&amp;user=Tachyon&amp;userId=35c856cf9e4d&amp;source=post_page-35c856cf9e4d----62c50e58cbd0---------------------post_header-----------"
                                                                                                                rel="noopener follow">Follow</a></span>
                                                                                                    </p>
                                                                                                </div>
                                                                                            </div>
                                                                                        </span></div>
                                                                                </div>
                                                                                <div class="l iw"><span
                                                                                        class="be b bf z dt">
                                                                                        <div class="ab cm ix iy iz">
                                                                                            <span class="be b bf z dt">
                                                                                                <div class="ab ae"><span
                                                                                                        data-testid="storyReadTime">38
                                                                                                        min read</span>
                                                                                                    <div class="ja jb l"
                                                                                                        aria-hidden="true">
                                                                                                        <span class="l"
                                                                                                            aria-hidden="true"><span
                                                                                                                class="be b bf z dt">·</span></span>
                                                                                                    </div><span
                                                                                                        data-testid="storyPublishDate">Feb
                                                                                                        15, 2019</span>
                                                                                                </div>
                                                                                            </span>
                                                                                        </div>
                                                                                    </span></div>
                                                                            </div>
                                                                        </div>
                                                                        <div
                                                                            class="ab co jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr">
                                                                            <div class="h k w ff fg q">
                                                                                <div class="kh l">
                                                                                    <div class="ab q ki kj">
                                                                                        <div
                                                                                            class="pw-multi-vote-icon fi kk kl km kn">
                                                                                            <span><a class="af ag ah ai aj ak al am an ao ap aq ar as at"
                                                                                                    data-testid="headerClapButton"
                                                                                                    href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Fp%2F62c50e58cbd0&amp;operation=register&amp;redirect=https%3A%2F%2Ftachyondevel.medium.com%2F%25E6%25BC%25AB%25E8%25B0%2588%25E5%2590%2584%25E7%25A7%258D%25E9%25BB%2591%25E7%25A7%2591%25E6%258A%2580%25E5%25BC%258F-dns-%25E6%258A%2580%25E6%259C%25AF%25E5%259C%25A8%25E4%25BB%25A3%25E7%2590%2586%25E7%258E%25AF%25E5%25A2%2583%25E4%25B8%25AD%25E7%259A%2584%25E5%25BA%2594%25E7%2594%25A8-62c50e58cbd0&amp;user=Tachyon&amp;userId=35c856cf9e4d&amp;source=-----62c50e58cbd0---------------------clap_footer-----------"
                                                                                                    rel="noopener follow">
                                                                                                    <div>
                                                                                                        <div class="bl"
                                                                                                            aria-hidden="false">
                                                                                                            <div
                                                                                                                class="ko ao kp kq kr ks am kt ku kv kn">
                                                                                                                <svg width="24"
                                                                                                                    height="24"
                                                                                                                    viewBox="0 0 24 24"
                                                                                                                    aria-label="clap">
                                                                                                                    <path
                                                                                                                        fill-rule="evenodd"
                                                                                                                        clip-rule="evenodd"
                                                                                                                        d="M11.37.83L12 3.28l.63-2.45h-1.26zM13.92 3.95l1.52-2.1-1.18-.4-.34 2.5zM8.59 1.84l1.52 2.11-.34-2.5-1.18.4zM18.52 18.92a4.23 4.23 0 0 1-2.62 1.33l.41-.37c2.39-2.4 2.86-4.95 1.4-7.63l-.91-1.6-.8-1.67c-.25-.56-.19-.98.21-1.29a.7.7 0 0 1 .55-.13c.28.05.54.23.72.5l2.37 4.16c.97 1.62 1.14 4.23-1.33 6.7zm-11-.44l-4.15-4.15a.83.83 0 0 1 1.17-1.17l2.16 2.16a.37.37 0 0 0 .51-.52l-2.15-2.16L3.6 11.2a.83.83 0 0 1 1.17-1.17l3.43 3.44a.36.36 0 0 0 .52 0 .36.36 0 0 0 0-.52L5.29 9.51l-.97-.97a.83.83 0 0 1 0-1.16.84.84 0 0 1 1.17 0l.97.97 3.44 3.43a.36.36 0 0 0 .51 0 .37.37 0 0 0 0-.52L6.98 7.83a.82.82 0 0 1-.18-.9.82.82 0 0 1 .76-.51c.22 0 .43.09.58.24l5.8 5.79a.37.37 0 0 0 .58-.42L13.4 9.67c-.26-.56-.2-.98.2-1.29a.7.7 0 0 1 .55-.13c.28.05.55.23.73.5l2.2 3.86c1.3 2.38.87 4.59-1.29 6.75a4.65 4.65 0 0 1-4.19 1.37 7.73 7.73 0 0 1-4.07-2.25zm3.23-12.5l2.12 2.11c-.41.5-.47 1.17-.13 1.9l.22.46-3.52-3.53a.81.81 0 0 1-.1-.36c0-.23.09-.43.24-.59a.85.85 0 0 1 1.17 0zm7.36 1.7a1.86 1.86 0 0 0-1.23-.84 1.44 1.44 0 0 0-1.12.27c-.3.24-.5.55-.58.89-.25-.25-.57-.4-.91-.47-.28-.04-.56 0-.82.1l-2.18-2.18a1.56 1.56 0 0 0-2.2 0c-.2.2-.33.44-.4.7a1.56 1.56 0 0 0-2.63.75 1.6 1.6 0 0 0-2.23-.04 1.56 1.56 0 0 0 0 2.2c-.24.1-.5.24-.72.45a1.56 1.56 0 0 0 0 2.2l.52.52a1.56 1.56 0 0 0-.75 2.61L7 19a8.46 8.46 0 0 0 4.48 2.45 5.18 5.18 0 0 0 3.36-.5 4.89 4.89 0 0 0 4.2-1.51c2.75-2.77 2.54-5.74 1.43-7.59L18.1 7.68z">
                                                                                                                    </path>
                                                                                                                </svg>
                                                                                                            </div>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                </a></span>
                                                                                        </div>
                                                                                        <div
                                                                                            class="pw-multi-vote-count l kw kx ky kz la lb lc">
                                                                                            <p class="be b du z dt">
                                                                                                <span
                                                                                                    class="ld">--</span>
                                                                                            </p>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                                <div>
                                                                                    <div class="bl" aria-hidden="false">
                                                                                        <button
                                                                                            class="ao ko lg lh ab q fj li lj"
                                                                                            aria-label="responses"><svg
                                                                                                width="24" height="24"
                                                                                                viewBox="0 0 24 24"
                                                                                                class="lf">
                                                                                                <path
                                                                                                    d="M18 16.8a7.14 7.14 0 0 0 2.24-5.32c0-4.12-3.53-7.48-8.05-7.48C7.67 4 4 7.36 4 11.48c0 4.13 3.67 7.48 8.2 7.48a8.9 8.9 0 0 0 2.38-.32c.23.2.48.39.75.56 1.06.69 2.2 1.04 3.4 1.04.22 0 .4-.11.48-.29a.5.5 0 0 0-.04-.52 6.4 6.4 0 0 1-1.16-2.65v.02zm-3.12 1.06l-.06-.22-.32.1a8 8 0 0 1-2.3.33c-4.03 0-7.3-2.96-7.3-6.59S8.17 4.9 12.2 4.9c4 0 7.1 2.96 7.1 6.6 0 1.8-.6 3.47-2.02 4.72l-.2.16v.26l.02.3a6.74 6.74 0 0 0 .88 2.4 5.27 5.27 0 0 1-2.17-.86c-.28-.17-.72-.38-.94-.59l.01-.02z">
                                                                                                </path>
                                                                                            </svg>
                                                                                            <p class="be b du z dt">
                                                                                                <span
                                                                                                    class="pw-responses-count le lf">12</span>
                                                                                            </p>
                                                                                        </button>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                            <div
                                                                                class="ab q js jt ju jv jw jx jy jz ka kb kc kd ke kf kg">
                                                                                <div class="lk k j i d"></div>
                                                                                <div class="h k">
                                                                                    <div>
                                                                                        <div class="bl"
                                                                                            aria-hidden="false"><span><a
                                                                                                    class="af ag ah ai aj ak al am an ao ap aq ar as at"
                                                                                                    data-testid="headerBookmarkButton"
                                                                                                    href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F62c50e58cbd0&amp;operation=register&amp;redirect=https%3A%2F%2Ftachyondevel.medium.com%2F%25E6%25BC%25AB%25E8%25B0%2588%25E5%2590%2584%25E7%25A7%258D%25E9%25BB%2591%25E7%25A7%2591%25E6%258A%2580%25E5%25BC%258F-dns-%25E6%258A%2580%25E6%259C%25AF%25E5%259C%25A8%25E4%25BB%25A3%25E7%2590%2586%25E7%258E%25AF%25E5%25A2%2583%25E4%25B8%25AD%25E7%259A%2584%25E5%25BA%2594%25E7%2594%25A8-62c50e58cbd0&amp;source=-----62c50e58cbd0---------------------bookmark_footer-----------"
                                                                                                    rel="noopener follow"><svg
                                                                                                        width="25"
                                                                                                        height="25"
                                                                                                        viewBox="0 0 25 25"
                                                                                                        fill="none"
                                                                                                        class="dt ll"
                                                                                                        aria-label="Add to list bookmark button">
                                                                                                        <path
                                                                                                            d="M18 2.5a.5.5 0 0 1 1 0V5h2.5a.5.5 0 0 1 0 1H19v2.5a.5.5 0 1 1-1 0V6h-2.5a.5.5 0 0 1 0-1H18V2.5zM7 7a1 1 0 0 1 1-1h3.5a.5.5 0 0 0 0-1H8a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4V7z"
                                                                                                            fill="currentColor">
                                                                                                        </path>
                                                                                                    </svg></a></span>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                                <div class="bl" aria-hidden="false"
                                                                                    aria-describedby="postFooterSocialMenu"
                                                                                    aria-labelledby="postFooterSocialMenu">
                                                                                    <div>
                                                                                        <div class="bl"
                                                                                            aria-hidden="false"><button
                                                                                                aria-controls="postFooterSocialMenu"
                                                                                                aria-expanded="false"
                                                                                                aria-label="Share Post"
                                                                                                data-testid="headerSocialShareButton"
                                                                                                class="af fj ah ai aj ak al lm an ao ap ew ln lo lj lp lq lr ls lt s lu lv lw lx ly lz ma u mb mc md"><svg
                                                                                                    width="24"
                                                                                                    height="24"
                                                                                                    viewBox="0 0 24 24"
                                                                                                    fill="none">
                                                                                                    <path
                                                                                                        fill-rule="evenodd"
                                                                                                        clip-rule="evenodd"
                                                                                                        d="M15.22 4.93a.42.42 0 0 1-.12.13h.01a.45.45 0 0 1-.29.08.52.52 0 0 1-.3-.13L12.5 3v7.07a.5.5 0 0 1-.5.5.5.5 0 0 1-.5-.5V3.02l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.8a.42.42 0 0 1 .07.5zm-.1.14zm.88 2h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11a2 2 0 0 1-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.14c.1.1.15.22.15.35a.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9V8.96c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1z"
                                                                                                        fill="currentColor">
                                                                                                    </path>
                                                                                                </svg>
                                                                                                <div class="j i d">
                                                                                                    <p
                                                                                                        class="be b bf z dt">
                                                                                                        Share</p>
                                                                                                </div>
                                                                                            </button></div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <p id="0e36"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            这篇文章目的是以非技术性例举方式，谈一谈各种 DNS 技术在代理环境中如何工作，主要集中在对 V2Ray
                                                            的使用上，因为最近 V2Ray 发布了一个 DNS 相关的功能：<a class="af nc"
                                                                href="https://steemit.com/cn/@v2ray/dns"
                                                                rel="noopener ugc nofollow"
                                                                target="_blank">https://steemit.com/cn/@v2ray/dns</a>，其用法很多，可以解决很多问题，但如果不理解其工作方式，就很难做出合理的配置。
                                                        </p>
                                                        <p id="8f17"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            本文所讨论的也不单纯是 DNS，还涉及 V2Ray 的部分工作原理，因为我们的讨论是依赖于使用 V2Ray 来对 DNS
                                                            流量做各种处理的。所以也希望读者看懂了文章中的例子后，可以举一反三，从而更好理解 V2Ray 的整体工作原理。</p>
                                                        <p id="2d91"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            本文举例范围预计会包括桌面系统（Windows, macOS）、移动端（iOS,
                                                            Android）、普通浏览器代理（系统代理）、全局代理（tun2socks），或许还会聊聊路由器上的透明代理。</p>
                                                        <h2 id="4691"
                                                            class="nd ne gt be nf ng nh dx ni nj nk dz nl mp nm nn no mt np nq nr mx ns nt nu nv bj">
                                                            桌面端环境</h2>
                                                        <p id="e5ea"
                                                            class="pw-post-body-paragraph me mf gt mg b mh nw mj mk ml nx mn mo mp ny mr ms mt nz mv mw mx oa mz na nb gm bj">
                                                            先从非常简单的例子说起，了解下大概的过程。</p>
                                                        <p id="d7f6"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            首先说一下不开任何代理软件，不做任何代理设置时，DNS 的工作方式：</p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="d938" class="nd ne gt oh b in ol om l on oo">S1</span><span id="90d8" class="nd ne gt oh b in op om l on oo">1. 浏览器地址栏输入 www.bilibili.com，敲下 Enter<br/>2. 浏览器发起针对 &quot;www.bilibili.com&quot; 这个域名的 DNS 请求<br/>3. 假设系统 DNS 设置了 114.114.114.114<br/>4. 承载 DNS 请求的 UDP 流量就会从你本机直接发到 114.114.114.114<br/>5. 114.114.114.114 接收了这些 UDP 流量<br/>6. 114.114.114.114 从这些 UDP 流量中解析出请求的域名 &quot;www.bilibili.com&quot;<br/>7. 114.114.114.114 尝试从自己缓存里找结果，有的话返回结果<br/>8. 114.114.114.114 如果没缓存，会向其它 DNS 服务器要结果，拿到后返回<br/>9. 浏览器收到 114.114.114.114 返回的结果<br/>10. 浏览器开始真正地对 Bilibili 的服务器发起 HTTP/HTTPS 连接</span></pre>
                                                        <p id="0f5f"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            下面假设在系统或浏览器中设置了 SOCKS 5（注意是 SOCKS 5，版本
                                                            5）代理服务器地址为：127.0.0.1:1086。</p>
                                                        <blockquote class="oq or os">
                                                            <p id="d082"
                                                                class="me mf ot mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                                Windows 系统的用户需要注意，系统代理里直接设置 SOCKS 代理有可能用的不是 SOCKS 5，而是
                                                                SOCKS 4，SOCKS 4 是不支持远程 DNS 解析的，想要设置 SOCKS 5 的话要用 PAC
                                                                文件，PAC 文件内容可以这么写：</p>
                                                            <p id="d884"
                                                                class="me mf ot mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                                function FindProxyForURL(url, host) {<br /> return
                                                                &quot;SOCKS5 127.0.0.1:1086; SOCKS
                                                                127.0.0.1:1086&quot;;<br />}</p>
                                                        </blockquote>
                                                        <p id="3ca4"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            然后在本地开启一个 V2Ray，配置大概如下：</p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="4de5" class="nd ne gt oh b in ol om l on oo">C1</span><span id="4f45" class="nd ne gt oh b in op om l on oo">{<br/>    &quot;dns&quot;: {<br/>        &quot;servers&quot;: [<br/>            &quot;223.5.5.5&quot;,<br/>            &quot;8.8.8.8&quot;<br/>        ]<br/>    },<br/>    &quot;outbounds&quot;: [<br/>        {<br/>            &quot;protocol&quot;: &quot;freedom&quot;,<br/>            &quot;settings&quot;: {}<br/>        }<br/>    ],<br/>    &quot;inbounds&quot;: [<br/>        {<br/>            &quot;domainOverride&quot;: [<br/>                &quot;http&quot;,<br/>                &quot;tls&quot;<br/>            ],<br/>            &quot;port&quot;: 1086,<br/>            &quot;listen&quot;: &quot;127.0.0.1&quot;,<br/>            &quot;protocol&quot;: &quot;socks&quot;,<br/>            &quot;settings&quot;: {<br/>                &quot;auth&quot;: &quot;noauth&quot;,<br/>                &quot;udp&quot;: true,<br/>                &quot;ip&quot;: &quot;127.0.0.1&quot;<br/>            }<br/>        }<br/>    ]<br/>}</span></pre>
                                                        <p id="cdc4"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            在这个基础上对比上面（S1）不设置代理的情况：</p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="7d11" class="nd ne gt oh b in ol om l on oo">S2</span><span id="14fa" class="nd ne gt oh b in op om l on oo">1. 浏览器地址栏输入 www.bilibili.com，敲下 Enter</span><span id="27f8" class="nd ne gt oh b in op om l on oo">2. 浏览器发现设置了 SOCKS 代理，因为 SOCKS 代理可以把域名传给服务器处理<br/>3. 所以浏览器不需要做 DNS 请求，直接把域名放进 SOCKS 请求中发给代理服务器<br/>4. 我们的代理服务器(V2Ray) 127.0.0.1:1086 收到了这个 SOCKS 代理请求<br/>5. 代理服务器(V2Ray) 从 SOCKS 请求中解析出 &quot;www.bilibili.com&quot; 这个域名<br/>6. 代理服务器(V2Ray) 要代理这个请求，但因为只有一个 Freedom outbound<br/>7. 于是就用 Freedom outbound 向 www.bilibili.com 发起 TCP 连接<br/>8. Freedom outbound 要向一个域名发 TCP 连接，得先解析域名</span><span id="f5fe" class="nd ne gt oh b in op om l on oo">9. 承载 DNS 请求的 UDP 流量就会从你本机直接发到 114.114.114.114<br/>10. 114.114.114.114 接收了这些 UDP 流量<br/>11. 114.114.114.114 从这些 UDP 流量中解析出请求的域名 &quot;www.bilibili.com&quot;<br/>12. 114.114.114.114 尝试从自己缓存里找结果，有的话返回结果<br/>13. 114.114.114.114 如果没缓存，会向其它 DNS 服务器要结果，拿到后返回</span><span id="26a8" class="nd ne gt oh b in op om l on oo">14. 程序(V2Ray)收到 114.114.114.114 返回的结果<br/>15. 程序(V2Ray)开始真正地对 Bilibili 的服务器发起 TCP 连接<br/>16. 连接一旦建立，代理服务器(V2Ray) 就可以真正地代理客户端(浏览器)的请求流量</span></pre>
                                                        <p id="3fc2"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            上面（S2）设置不涉及任何远程代理服务器，由本地的 V2Ray 充当代了理服务器，代理的 <a
                                                                class="af nc" href="http://www.bilibili.com"
                                                                rel="noopener ugc nofollow"
                                                                target="_blank">www.bilibili.com</a> 请求是采用直连方式，也一样有向
                                                            114.114.114.114 发出了 DNS 请求。但可以看到在后一个例子发起 DNS 请求的是
                                                            V2Ray（而不是浏览器），而从 Bilibili 的服务器看来，跟它连接是 V2Ray（而不是浏览器）。</p>
                                                        <p id="8b47"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            加了这么一层代理，看起来什么都没发生，只是换了角色，其实不然，角色这么一换，可做的事情就相当多了。拿 DNS
                                                            来说，原来是浏览器发起的 DNS 请求，我们没办法控制浏览器怎么去发这个 DNS
                                                            请求（你不可能去改浏览器的源代码自己编译一个来用吧？），但换成由 V2Ray 来发这个 DNS
                                                            请求后，我们就可以做很多事情。</p>
                                                        <p id="1dec"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            比如稍微改一下上面（C1）的配置，在 Freedom oubound 中加入 <code
                                                                class="cw ou ov ow oh b">&quot;domainStrategy&quot;: &quot;UseIP&quot;</code>
                                                            ：</p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="35d6" class="nd ne gt oh b in ol om l on oo">C2</span><span id="412a" class="nd ne gt oh b in op om l on oo">{<br/>    &quot;dns&quot;: {<br/>        &quot;servers&quot;: [<br/>            &quot;223.5.5.5&quot;,<br/>            &quot;8.8.8.8&quot;<br/>        ]<br/>    },<br/>    &quot;outbounds&quot;: [<br/>        {<br/>            &quot;protocol&quot;: &quot;freedom&quot;,<br/>            &quot;settings&quot;: {<br/>                &quot;domainStrategy&quot;: &quot;UseIP&quot;<br/>            }<br/>        }<br/>    ],<br/>    &quot;inbounds&quot;: [<br/>        {<br/>            &quot;domainOverride&quot;: [<br/>                &quot;http&quot;,<br/>                &quot;tls&quot;<br/>            ],<br/>            &quot;port&quot;: 1086,<br/>            &quot;listen&quot;: &quot;127.0.0.1&quot;,<br/>            &quot;protocol&quot;: &quot;socks&quot;,<br/>            &quot;settings&quot;: {<br/>                &quot;auth&quot;: &quot;noauth&quot;,<br/>                &quot;udp&quot;: true,<br/>                &quot;ip&quot;: &quot;127.0.0.1&quot;<br/>            }<br/>        }<br/>    ]<br/>}</span></pre>
                                                        <p id="e611"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            <a class="af nc"
                                                                href="https://v2ray.com/chapter_02/protocols/freedom.html"
                                                                rel="noopener ugc nofollow" target="_blank">V2Ray 文档</a>
                                                            中对 <code class="cw ou ov ow oh b">domainStrategy</code>
                                                            的说明是这样的：
                                                        </p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="0f96" class="nd ne gt oh b in ol om l on oo">在目标地址为域名时，Freedom 可以直接向此域名发出连接（<!-- -->&quot;AsIs&quot;<!-- -->），或者将域名解析为 IP 之后再建立连接（<!-- -->&quot;UseIP&quot;<!-- -->、<!-- -->&quot;UseIPv4&quot;<!-- -->、<!-- -->&quot;UseIPv6&quot;<!-- -->）。解析 IP 的步骤会使用 V2Ray <a class="af nc" href="https://v2ray.com/chapter_02/04_dns.html" rel="noopener ugc nofollow" target="_blank">内建的 DNS</a>。默认值为<!-- -->&quot;AsIs&quot;<!-- -->。</span></pre>
                                                        <p id="080a"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            原本默认为 <code class="cw ou ov ow oh b">AsIs</code>
                                                            的话，直接向域名发出连接就是说会用系统 DNS 来做 DNS 解析，但如果我们设置为 <code
                                                                class="cw ou ov ow oh b">UseIP</code> ，S2 中的步骤就会变成这样：
                                                        </p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="8efb" class="nd ne gt oh b in ol om l on oo">S3</span><span id="a1c7" class="nd ne gt oh b in op om l on oo">...</span><span id="0eaa" class="nd ne gt oh b in op om l on oo">8. Freedom outbound 要向一个域名发 TCP 连接，得先解析域名</span><span id="50c7" class="nd ne gt oh b in op om l on oo">* Freedom outbound 用了 UseIP 策略，所以使用内置 DNS 来解析域名<br/>* 内置 DNS 按顺序第一个是 223.5.5.5<br/>* 内置 DNS 请求会按路由规则走，因为没有任何规则，且只有一个 Freedom outbound<br/>* 内置 DNS 发到 223.5.5.5 的请求走 Freedom outbound</span><span id="1e15" class="nd ne gt oh b in op om l on oo">9. 承载 DNS 请求的 UDP 流量就会从你本机直接发到 223.5.5.5<br/>10. 223.5.5.5 接收了这些 UDP 流量<br/>11. 223.5.5.5 从这些 UDP 流量中解析出请求的域名 &quot;www.bilibili.com&quot;<br/>12. 223.5.5.5 尝试从自己缓存里找结果，有的话返回结果<br/>13. 223.5.5.5 如果没缓存，会向其它 DNS 服务器要结果，拿到后返回</span><span id="2351" class="nd ne gt oh b in op om l on oo">14. 程序(V2Ray)收到 223.5.5.5 返回的结果</span><span id="4880" class="nd ne gt oh b in op om l on oo">...</span></pre>
                                                        <p id="e032"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            所以这里我们改了一个 <code
                                                                class="cw ou ov ow oh b">domainStrategy</code>
                                                            参数，就相当于覆盖了系统的 DNS，本来应该走 114.114.114.114（系统 DNS）的 DNS 请求现在走
                                                            223.5.5.5（V2Ray 内置 DNS）了。</p>
                                                        <p id="b4d5"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            上面例子都很简单，并没什么实际用处，但了解这些可以方便理解后续各种花式玩法。另外虽说简单，但也已经包括了几个需要关注的点。
                                                        </p>
                                                        <p id="deb8"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            比如在 S2 中是这么写的：</p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="b2c0" class="nd ne gt oh b in ol om l on oo">浏览器发现设置了 SOCKS 代理</span></pre>
                                                        <p id="d82c"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            这里就得注意了，我们设置的 SOCKS
                                                            代理需要浏览器（应用程序）发现了，浏览器（应用程序）才会去使用它。如果应用程序没发现我们设置的系统代理呢？或者浏览器（应用程序）无视了我们设置的系统代理，按正常的流程去做请求呢？
                                                        </p>
                                                        <p id="56b2"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            这里的关键点是，一般桌面操作系统（Windows, macOS）中的系统代理设置只是一个 <code
                                                                class="cw ou ov ow oh b">可选</code> 的连接方式。</p>
                                                        <p id="1323"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            如果设置了系统代理，一般的浏览器程序（Chrome, Firefox,
                                                            Safari）默认都会发现并遵从这个设置。其它的一些应用程序就不一定会遵从这个设置了，比如 QQ
                                                            这样的程序，它默认应该是不会遵从这个设置的（它有自己的设置项），再比如打开命令行，输入以下命令：</p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="ea7f" class="nd ne gt oh b in ol om l on oo">curl https://www.bilibili.com</span></pre>
                                                        <p id="648d"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            <code class="cw ou ov ow oh b">curl</code>
                                                            做的这个请求时是不会使用系统代理的。如果想让 <code
                                                                class="cw ou ov ow oh b">curl</code> 使用代理，可以这么设置一个环境变量，
                                                            <code class="cw ou ov ow oh b">curl</code>
                                                            会读取这个变量，从而得知代理的存在并使用它：
                                                        </p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="dce4" class="nd ne gt oh b in ol om l on oo">http_proxy=127.0.0.1:1086 curl https://www.bilibili.com</span></pre>
                                                        <p id="aac9"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            再比如上面场景中多次提到 DNS 请求相关内容时，用了 <code
                                                                class="cw ou ov ow oh b">DNS 请求</code> ，<code
                                                                class="cw ou ov ow oh b">承载 DNS 请求的 UDP 流量</code>
                                                            等多种说法，它们其实都是指同一个东西，只是在不同的上下文中用了不同的说法。</p>
                                                        <p id="86d9"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            简单来说，从我们机器发出去的一个 DNS 请求会是这个样子的：</p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="3bc8" class="nd ne gt oh b in ol om l on oo">F1</span><span id="84ec" class="nd ne gt oh b in op om l on oo">+------+-------+--------------------------+<br/>| IP 头| UDP 头 | DNS 头 及 其 请 求 内 容  |<br/>+------+-------+--------------------------+</span><span id="c2c7" class="nd ne gt oh b in op om l on oo">重点：一般这种 DNS 请求都是纯文本（我们也只讨论这种 DNS），它们所流经的各种设备，各种程序都可以看到，可以修改里面的内容，发出的请求可以修改，返回的结果也可以修改，甚至修改过后毫无痕迹，就是说，对于发出的请求，DNS 服务器没办法知道它是否在中间链路被修改过，对于返回的结果，应用程序也没办法知道它是否在中间链路被修改过。</span></pre>
                                                        <p id="7d67"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            这是一个 IP 包，从某种角度来看可以说它是一个承载了 UDP 流量的 IP 包，其中 IP 头中包含了源地址（本机
                                                            IP）和目的地址（114.114.114.114），UDP 头中包含了源端口（随机）和目的端口（53），DNS
                                                            头及其请求内容中包含了请求要解析的域名（www.bilibili.com），要解析的 DNS 类型（A/AAAA）。
                                                        </p>
                                                        <p id="23bb"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            所谓在不同上下文用不同的说法，一般就是指在不同的时候我们关注不同信息，当表达流量从本机发送到
                                                            114.114.114.114，我们关注的是 IP 地址和端口，这时我们说承载 DNS 请求的 UDP 流量（因为 IP
                                                            地址和端口信息在 IP 头 和 UDP 头中），当我们只关注所要解析的域名 “www.bilibili.com”
                                                            时，会说 DNS 请求（因为这个信息在 DNS 头及其请求内容中）。更多的时候是混用，在这方面不会太严谨。</p>
                                                        <p id="5f4f"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            知道哪个信息包含在哪一部分的数据中，会对我们理解各种 DNS 技术的工作方式有很大帮助。</p>
                                                        <p id="b0a8"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            下面举一个实际使用中可能用上的例子，配置如下：</p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="f568" class="nd ne gt oh b in ol om l on oo">C3</span><span id="363e" class="nd ne gt oh b in op om l on oo">{<br/>    &quot;dns&quot;: {<br/>        &quot;servers&quot;: [<br/>            &quot;8.8.8.8&quot;,<br/>            &quot;localhost&quot;<br/>        ]<br/>    },<br/>    &quot;outbounds&quot;: [<br/>        {<br/>            &quot;protocol&quot;: &quot;vmess&quot;,<br/>            &quot;settings&quot;: {<br/>                &quot;vnext&quot;: [<br/>                    {<br/>                        &quot;users&quot;: [<br/>                            {<br/>                                &quot;id&quot;: &quot;xxx-x-x-x-xx-x-x-x-x&quot;<br/>                            }<br/>                        ],<br/>                        &quot;address&quot;: &quot;1.2.3.4&quot;,<br/>                        &quot;port&quot;: 10086<br/>                    }<br/>                ]<br/>            },<br/>            &quot;streamSettings&quot;: {<br/>                &quot;network&quot;: &quot;tcp&quot;<br/>            },<br/>            &quot;tag&quot;: &quot;proxy&quot;<br/>        },<br/>        {<br/>            &quot;tag&quot;: &quot;direct&quot;,<br/>            &quot;protocol&quot;: &quot;freedom&quot;,<br/>            &quot;settings&quot;: {}<br/>        }<br/>    ],<br/>    &quot;inbounds&quot;: [<br/>        {<br/>            &quot;domainOverride&quot;: [<br/>                &quot;http&quot;,<br/>                &quot;tls&quot;<br/>            ],<br/>            &quot;port&quot;: 1086,<br/>            &quot;listen&quot;: &quot;127.0.0.1&quot;,<br/>            &quot;protocol&quot;: &quot;socks&quot;,<br/>            &quot;settings&quot;: {<br/>                &quot;auth&quot;: &quot;noauth&quot;,<br/>                &quot;udp&quot;: true,<br/>                &quot;ip&quot;: &quot;127.0.0.1&quot;<br/>            }<br/>        }<br/>    ],<br/>    &quot;routing&quot;: {<br/>        &quot;domainStrategy&quot;: &quot;IPIfNonMatch&quot;,<br/>        &quot;rules&quot;: [<br/>            {<br/>                &quot;type&quot;: &quot;field&quot;,<br/>                &quot;ip&quot;: [<br/>                    &quot;8.8.8.8&quot;<br/>                ],<br/>                &quot;outboundTag&quot;: &quot;proxy&quot;<br/>            },<br/>            {<br/>                &quot;type&quot;: &quot;field&quot;,<br/>                &quot;domain&quot;: [<br/>                    &quot;geosite:cn&quot;<br/>                ],<br/>                &quot;outboundTag&quot;: &quot;direct&quot;<br/>            }<br/>        ]<br/>    }<br/>}</span></pre>
                                                        <p id="680e"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            简单描述下上面配置：内置 DNS 用 8.8.8.8 做首选服务器，localhost 作备用，路由中首先来一条规则让
                                                            8.8.8.8 的流量一定走 proxy，匹配了 geosite:cn 中的域名的请求走
                                                            direct，如果没匹配任何规则，则走主 outbound，也即 outbounds 中的第一个，也即 proxy。
                                                        </p>
                                                        <p id="5396"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            同样设置系统代理至 V2Ray 的 SOCKS inbound
                                                            127.0.0.1:1086，再来考虑浏览器做请求的过程，经过上面几个例子，可以看到很多步骤其实是一样的，所以后续例子中会简化一些：
                                                        </p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="2832" class="nd ne gt oh b in ol om l on oo">S4</span><span id="b74e" class="nd ne gt oh b in op om l on oo">1. 假设浏览器请求 <a class="af nc" href="https://www.bilibili.com" rel="noopener ugc nofollow" target="_blank">https://www.bilibili.com</a><br/>2. 浏览器发 SOCKS 请求到 V2Ray<br/>3. 请求来到 V2Ray 的 inbound，再到路由过程<br/>4. 很明显 <a class="af nc" href="http://www.bilibili.com" rel="noopener ugc nofollow" target="_blank">www.bilibili.com</a> 这个域名包括在 geosite:cn 中，走 direct<br/>5. Freedom outbound (direct) 对 <a class="af nc" href="http://www.bilibili.com" rel="noopener ugc nofollow" target="_blank">www.bilibili.com</a> 发起 TCP 连接<br/>6. Freedom outbound 解析域名，因为这次没有用 UseIP，用的是系统 DNS<br/>7. 直接发 DNS 请求到 114.114.114.114<br/>8. 得到结果后可以跟 Bilibili 服务器建立连接，准备代理浏览器发过来的 HTTPS 流量</span><span id="62aa" class="nd ne gt oh b in op om l on oo"><br/>S5</span><span id="e67d" class="nd ne gt oh b in op om l on oo">1. 再假设浏览器请求 https://www.google.com<br/>2. 浏览器发 SOCKS 请求到 V2Ray<br/>3. 请求来到 V2Ray 的 inbound，再到路由过程</span><span id="2508" class="nd ne gt oh b in op om l on oo">4. www.google.com 不在 gesoite:cn，也没匹配任何规则，本来应该直接走主 outbound: proxy，但因为我们用了 IPIfNonMatch 策略，V2Ray 会去尝试使用内置的 DNS 把 <a class="af nc" href="http://www.google.com" rel="noopener ugc nofollow" target="_blank">www.google.com</a> 的 IP 解析出来</span><span id="051d" class="nd ne gt oh b in op om l on oo">5. V2Ray 使用内置 DNS 向 8.8.8.8 发起针对 <a class="af nc" href="http://www.google.com" rel="noopener ugc nofollow" target="_blank">www.google.com</a> 的 DNS 请求，这个请求的流量将会是 UDP 流量</span><span id="4a43" class="nd ne gt oh b in op om l on oo">6. 内置 DNS 发出的 DNS 请求会按路由规则走，因为 8.8.8.8 匹配了路由中的第一条规则，这个 DNS 请求的流量会走 proxy</span><span id="a1f3" class="nd ne gt oh b in op om l on oo">7. proxy 向远端代理服务器发起 TCP 代理连接（因为 &quot;network&quot;: &quot;tcp&quot;）</span><span id="2b1c" class="nd ne gt oh b in op om l on oo">8. 建立起 TCP 连接后，proxy 向远端代理服务器发出 udp:8.8.8.8:53 这样的代理请求</span><span id="6cf1" class="nd ne gt oh b in op om l on oo">9. 远端服务器表示接受这个代理请求后，proxy 用建立好的 TCP 连接向远端服务器发送承载了 DNS 请求的 UDP 流量（所以 V2Ray/VMess 目前是 UDP over TCP）</span><span id="6341" class="nd ne gt oh b in op om l on oo">10. 远端代理服务器接收到这些承载 DNS 请求的 UDP 流量后，发送给最终目标 udp:8.8.8.8:53</span><span id="f414" class="nd ne gt oh b in op om l on oo">11. 8.8.8.8 返回给远端代理服务器 DNS 结果后，远端代理服务器原路返回至本地 V2Ray 的内置 DNS，至此，从步骤 5 ~ 11，整个 DNS 解析过程完成。</span><span id="9896" class="nd ne gt oh b in op om l on oo">12. 接上面步骤 4，V2Ray 得到 <a class="af nc" href="http://www.google.com" rel="noopener ugc nofollow" target="_blank">www.google.com</a> 的 IP，再进行一次规则匹配，很明显路由规则中没有相关的 IP 规则，所以还是没匹配到任何规则，最终还是走了主 outbound: proxy</span><span id="52f6" class="nd ne gt oh b in op om l on oo">13. proxy 向远端代理服务器发起 TCP 代理连接（因为 &quot;network&quot;: &quot;tcp&quot;）</span><span id="a079" class="nd ne gt oh b in op om l on oo">14. 连接建立后，因为 proxy 中所用的 VMess 协议可以像 SOCKS 那样把域名交给代理服务器处理，所以本地的 V2Ray 不需要自己解析 www.google.com，把域名放进 VMess 协议的参数中一并交给代理服务器来处理</span><span id="5df0" class="nd ne gt oh b in op om l on oo">15. 远端的 V2Ray 代理服务器收到这个代理请求后，它可能自己做域名解析，也可能继续交给下一级代理处理，只要后续代理都支持类 SOCKS 的域名处理方式，这个 DNS 请求就可以一推再推，推给最后一个代理服务器来处理，这个超出本文范围不作讨论，反正这个域名不需要我们本地去解析</span><span id="108d" class="nd ne gt oh b in op om l on oo">16. 远端代理服务器最后会发出针对 <a class="af nc" href="http://www.google.com" rel="noopener ugc nofollow" target="_blank">www.google.com</a> 的 DNS 请求（至于究竟是如何发，发到哪个 DNS 服务器，我们不一定能知道，也不关心这个）</span><span id="5fdd" class="nd ne gt oh b in op om l on oo">17. 远端代理服务器得到 DNS 结果后，可以真正地向 Google 的服务器建立 TCP 连接18. 远端的 V2Ray 做好准备后告诉本地 V2Ray 连接建立好了，可以传数据了</span><span id="ab9b" class="nd ne gt oh b in op om l on oo">19. 本地 V2Ray 就告诉浏览器连接好了，可以传数据了，浏览器就可以把 HTTPS 流量顺着这个代理链发送至 Google 的服务器</span></pre>
                                                        <p id="16a9"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            在上面 S5 中，步骤 5 ~ 11 做了次 DNS 请求，采用代理转发 DNS 请求流量的方式，而在步骤 14
                                                            中，又说可以不解析域名，交给远端服务器来解析，这两者其实并不冲突。一般来说，前者的处理方式就是实实在在的 UDP
                                                            流量代理而已，后者一般叫作远程 DNS 解析。用了 <code
                                                                class="cw ou ov ow oh b">IPIfNonMatch</code> ，对域名做一次 DNS
                                                            解析要经过 5 ~ 11 这么多步骤，看起来效率很慢，但如果代理服务器不慢的话，这个过程一般是很快的，最重要的是
                                                            V2Ray 内置 DNS 对 DNS 结果有一个缓存，所以并不需要每次都去做 DNS
                                                            请求。不管怎么说，毕竟还是做了额外的事情，而且有可能涉及到一个 UDP over TCP 的代理请求，的确会相对地慢点。
                                                        </p>
                                                        <p id="16bd"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            另外要提到一点是，上面的配置中都在本地 SOCKS inbound 中用了：</p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="8737" class="nd ne gt oh b in ol om l on oo">&quot;domainOverride&quot;: [<br/>   &quot;http&quot;,<br/>   &quot;tls&quot;<br/>]</span></pre>
                                                        <blockquote class="oq or os">
                                                            <p id="91a8"
                                                                class="me mf ot mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                                在新的配置格式中这个流量嗅探的配置有了新的写法，后续会用这个写法：</p>
                                                            <p id="a13c"
                                                                class="me mf ot mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                                <code
                                                                    class="cw ou ov ow oh b">&quot;sniffing&quot;: {<br/> &quot;enabled&quot;: true,<br/> &quot;destOverride&quot;: [&quot;http&quot;, &quot;tls&quot;]<br/>}</code>
                                                            </p>
                                                        </blockquote>
                                                        <p id="eb10"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            这个是对流量进行域名嗅探，如果配置了，V2Ray
                                                            就会做嗅探操作，但上面的例子没有把这个操作过程列出来，是因为目前我们的场景是桌面系统 +
                                                            浏览器，在这个环境中，这个嗅探功能不会起额外的作用，浏览器会把域名交给 V2Ray，不需要 V2Ray 去嗅探。</p>
                                                        <p id="1664"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            如果看明白上面的上面几个举例，相信读者已经对 V2Ray 的工作方式有了大致的了解。一般来说，流量从 inbound
                                                            进入到 V2Ray，再进入到路由匹配过程，找到匹配到的 outbound，然后流量就给到这个 outbound
                                                            处理。V2Ray 虽然有多种 inbound，多种
                                                            outbound，以及很灵活的路由匹配规则，有时候会让人眼花缭乱，但这条流量流经的路线是默认的，没有特殊配置，流量都会按这个顺序在
                                                            V2Ray 内部传递。</p>
                                                        <h2 id="89d4"
                                                            class="nd ne gt be nf ng nh dx ni nj nk dz nl mp nm nn no mt np nq nr mx ns nt nu nv bj">
                                                            V2Ray 内置 DNS</h2>
                                                        <p id="5399"
                                                            class="pw-post-body-paragraph me mf gt mg b mh nw mj mk ml nx mn mo mp ny mr ms mt nz mv mw mx oa mz na nb gm bj">
                                                            而 V2Ray 的内置 DNS 其实也只是一个很简单的功能模块，它为 V2Ray 内部其它模块提供 DNS
                                                            功能，它接受一个域名作为输入，返回一个 IP 列表作为输出。</p>
                                                        <blockquote class="oq or os">
                                                            <p id="1c62"
                                                                class="me mf ot mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                                直接拿 V2Ray 里面代码出来看，内置 DNS 功能对其它模块提供的接口是这样的，表示输入参数是域名，输出是
                                                                IP 列表以及一个错误信息，如果正常返回，错误信息会是空的，IP 列表可以同时有 IPv4 和 IPv6 地址：
                                                            </p>
                                                            <p id="a811"
                                                                class="me mf ot mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                                LookupIP(domain string) ([]net.IP, error)</p>
                                                        </blockquote>
                                                        <p id="bb76"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            这就是从其它 V2Ray 模块的角度来看 V2Ray 内置 DNS 功能，至于内置 DNS
                                                            内部是否做域名分流，内部向哪个 DNS 服务器发出 DNS 请求，用何种方式发这个 DNS
                                                            请求，其它模块是管不着的，也完全不知情的。这样看内置 DNS 功能就很简单，其它模块，比如上面提到路由模块用内置 DNS
                                                            来解析域名后用 IP 再次进行匹配（或者后面会提到的 DNS outbound 模块），其实就是这样调用了内置 DNS：
                                                        </p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="86d0" class="nd ne gt oh b in ol om l on oo">路由模块：我有一个域名，给你（内置 DNS 模块），帮我查查它的 IP 地址是什么</span><span id="228b" class="nd ne gt oh b in op om l on oo">内置 DNS 模块按照自己的配置，做了各种处理，最终得到 IP 地址</span><span id="553b" class="nd ne gt oh b in op om l on oo">内置 DNS 模块：这就是它（域名）的 IP，给你（路由模块）</span></pre>
                                                        <p id="e643"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            从其它模块（外部）看 V2Ray 的内置 DNS
                                                            就这么简单的，那从内部看它呢？从内部看也是比较简单的，只要分清楚外部和内部各自负责的事情，各自所能得到的信息，就很好理解。
                                                        </p>
                                                        <p id="706a"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            比如内置 DNS 支持 hosts，这个功能是怎么做的呢？按上面的描述，外部只传入一个域名，其它的管不了，那内置 DNS
                                                            里面随便返回什么样的结果，外部都不能有任何疑问，比如路由模块要查 <a class="af nc"
                                                                href="http://www.bilibili.com"
                                                                rel="noopener ugc nofollow"
                                                                target="_blank">www.google.com</a> 的 IP，传它给内置 DNS，但如果内置
                                                            DNS 根本就不发任何 DNS 请求，不做任何额外处理，直接就返回一个 127.0.0.1
                                                            给路由模块，这时路由模块也不得有任何异议，就算很显示 127.0.0.1 不可能是 <a class="af nc"
                                                                href="http://www.bilibili.com"
                                                                rel="noopener ugc nofollow"
                                                                target="_blank">www.google.com</a> 真正的 IP 地址。那样在内置 DNS
                                                            中配置一个 <code class="cw ou ov ow oh b">域名 -&gt; IP</code>
                                                            的列表，只要传进来的域名匹配了列表中的域名，就直接返回相应 IP，这就等效于 hosts 了。</p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="42a6" class="nd ne gt oh b in ol om l on oo">&quot;dns&quot;: {<br/>  &quot;hosts&quot;: {<br/>    &quot;<a class="af nc" href="http://www.bilibili.com" rel="noopener ugc nofollow" target="_blank">www.google.com</a>&quot;: &quot;127.0.0.1&quot;<br/>  }<br/>}</span></pre>
                                                        <p id="70b5"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            再看内置 DNS 的 servers 一项，如果内置 DNS 这样配置：</p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="39b3" class="nd ne gt oh b in ol om l on oo">&quot;dns&quot;: {<br/>  &quot;servers&quot;: [<br/>    &quot;8.8.8.8&quot;,<br/>    &quot;223.5.5.5&quot;,<br/>    &quot;localhost&quot;<br/>  ]<br/>}</span></pre>
                                                        <p id="1241"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            路由模块传入 <a class="af nc" href="http://www.bilibili.com"
                                                                rel="noopener ugc nofollow"
                                                                target="_blank">www.bilibili.com</a> 这个域名，想要它的 IP 地址，内置
                                                            DNS 会从上至下按顺序，向 servers 里每个 DNS 服务器发 DNS
                                                            请求，一个一个地来，直到有结果返回，然后再把结果返回给路由模块。</p>
                                                        <p id="7a5a"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            从内置 DNS 向 servers 列表中的 DNS 服务器发出的 DNS
                                                            请求的流量，并不是从本机直接发到对应的服务器（localhost 除外），而是会通过 outbound 发出去，假如是
                                                            Freedom outbound，的确还是会从本机直接发到相应 DNS 服务器，但假如是一个 VMess
                                                            outbound，DNS 请求的流量就会被代理到 VMess 代理服务器上，由代理服务器发到相应的 DNS 服务器。
                                                        </p>
                                                        <p id="d05c"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            内置 DNS 发出的请求的流量可能的流经线路：</p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="e010" class="nd ne gt oh b in ol om l on oo">内置 DNS -&gt; 通过路由功能选择了 Freedom outbound -&gt; 8.8.8.8<br/>内置 DNS -&gt; 通过路由功能选择了 VMess outbound -&gt; VMess 代理服务器 -&gt; 8.8.8.8</span></pre>
                                                        <p id="4aa7"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            使用哪个 outbound，取决于路由配置。</p>
                                                        <p id="030d"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            所以这里就很有趣了：</p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="55a4" class="nd ne gt oh b in ol om l on oo">1. 路由模块想要 <a class="af nc" href="http://www.bilibili.com" rel="noopener ugc nofollow" target="_blank">www.bilibili.com</a> 的域名，调用了内置 DNS 模块去查<br/>2. 内置 DNS 模块内部需要发个 DNS 请求去查，但它不太确定要把流量发到哪个 outbound<br/>3. 内置 DNS 模块于是调用路由模块，让路由来给它决定发到 udp:8.8.8.8:53 的流量究竟要交给哪个 outbound 比较合适</span></pre>
                                                        <p id="d566"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            可是呢，考虑一下我们的配置以及要查询的这个域名，8.8.8.8 在列表第一项，要先用它来查，但我们要查的域名是
                                                            www.bilibili.com，一般来说是不太合适向 8.8.8.8 查这个域名。所以无论路由模块判断走
                                                            Freedom outbound 还是 VMess outbound，都不合适。因为走 Freedom outbound
                                                            发到 8.8.8.8，恐怕返回结果是假的，走 VMess outbound，恐怕返回结果是国外 CDN 的。</p>
                                                        <blockquote class="oq or os">
                                                            <p id="ff62"
                                                                class="me mf ot mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                                这里必须再插一段话，要考虑返回结果如何如何，我们还得考虑这个返回结果是用来干什么的，如果是我们当前的例子，是用来给路由模块做
                                                                IP 规则匹配的，那返回结果是不是假的并不重要，重要的是它是否能匹配到 direct
                                                                规则；如果返回结果用作其它目的，比如后面会说到的 DNS outbound，就又是另一个故事了~</p>
                                                        </blockquote>
                                                        <p id="fd52"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            回到主线，不管怎么，我们不想考虑太多东西，我们只想这个 DNS 请求能够合理地发出，很明显的一个选择就是让这个 <a
                                                                class="af nc" href="http://www.bilibili.com"
                                                                rel="noopener ugc nofollow"
                                                                target="_blank">www.bilibili.com</a> 的 DNS 请求发到
                                                            223.5.5.5，且走 Freedom outbound。</p>
                                                        <p id="448c"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            那把 223.5.5.5 放到列表第一项如何？这是治标不治本，想想假如又有另一个 DNS 请求要发到 <a
                                                                class="af nc" href="http://www.google.com"
                                                                rel="noopener ugc nofollow"
                                                                target="_blank">www.google.com</a> 的，这个请求先发到 223.5.5.5
                                                            就又不太合适了。</p>
                                                        <p id="a00f"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            V2Ray 当然已经考虑到这情况，有了所谓的 <code
                                                                class="cw ou ov ow oh b">DNS 分流</code> 功能：</p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="06f1" class="nd ne gt oh b in ol om l on oo">&quot;dns&quot;: {<br/>  &quot;servers&quot;: [<br/>    &quot;8.8.8.8&quot;,<br/>    {<br/>      &quot;address&quot;: &quot;223.5.5.5&quot;,<br/>      &quot;port&quot;: 53,<br/>      &quot;domains&quot;: [<br/>        &quot;domain:<a class="af nc" href="http://www.bilibili.com" rel="noopener ugc nofollow" target="_blank">www.bilibili.com</a>&quot;<br/>      ]<br/>    },<br/>    &quot;localhost&quot;<br/>  ]<br/>}</span></pre>
                                                        <p id="5786"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            这样配置内置 DNS，虽然 8.8.8.8 在第一，但因为要查询的域名 <a class="af nc"
                                                                href="http://www.bilibili.com"
                                                                rel="noopener ugc nofollow"
                                                                target="_blank">www.bilibili.com</a> 匹配了第二项中的域名规则，内置 DNS
                                                            就会优先向第二个 DNS 服务器发出 DNS 请求。</p>
                                                        <p id="4091"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            这里有一个很容易忽略掉的过程，就是选择 outbound，我们用 DNS 分流功能选择了 DNS
                                                            服务器，还得在路由中配置合适的规则，来选合适的 outbound 向这个 DNS 服务器发出 DNS 请求流量。</p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="2ab4" class="nd ne gt oh b in ol om l on oo">内置 DNS 查询 www.bilibili.com -&gt; 内置 DNS 通过分流功能选择了 223.5.5.5 -&gt; 通过路由功能选择了 Freedom outbound -&gt; 223.5.5.5</span><span id="a6a0" class="nd ne gt oh b in op om l on oo">内置 DNS 查询 www.bilibili.com -&gt; 内置 DNS 通过分流功能选择了 223.5.5.5 -&gt; 通过路由功能选择了 VMess outbound -&gt; VMess 代理服务器 -&gt; 223.5.5.5</span></pre>
                                                        <p id="aab5"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            就算 DNS 分流配置好了，如果路由规则配置不当，让 udp:223.5.5.5:53 的流量走了
                                                            proxy，就有可能发生上面第二个线路，返回的 IP 地址就有可能是 Bilibili 在国外 CDN 的 IP。（IP
                                                            结果是真的，只是…）</p>
                                                        <p id="df76"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            所以千万不能忘记，除了配置好 DNS 分流域名，还要为各个 DNS 服务器配置路由规则：</p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="1fcc" class="nd ne gt oh b in ol om l on oo">&quot;routing&quot;: {<br/>    &quot;domainStrategy&quot;: &quot;IPIfNonMatch&quot;,<br/>    &quot;rules&quot;: [<br/>        {<br/>            &quot;type&quot;: &quot;field&quot;,<br/>            &quot;ip&quot;: [<br/>                &quot;8.8.8.8&quot;<br/>            ],<br/>            &quot;outboundTag&quot;: &quot;proxy&quot;<br/>        },<br/>        {<br/>            &quot;type&quot;: &quot;field&quot;,<br/>            &quot;ip&quot;: [<br/>                &quot;223.5.5.5&quot;<br/>            ],<br/>            &quot;outboundTag&quot;: &quot;direct&quot;<br/>        }<br/>    ]<br/>}</span></pre>
                                                        <p id="1df9"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            总结一下上面的，要正确配置 V2Ray 内置 DNS：</p>
                                                        <ol class="">
                                                            <li id="6966"
                                                                class="me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb ox oy oz bj">
                                                                正确配置 servers 列表及域名分流（用域名信息来选 DNS 服务器）</li>
                                                            <li id="cb6c"
                                                                class="me mf gt mg b mh pa mj mk ml pb mn mo mp pc mr ms mt pd mv mw mx pe mz na nb ox oy oz bj">
                                                                正确为发出的 DNS 请求配置路由规则（用 DNS
                                                                服务器的地址信息以及流量的协议信息：IP，端口，tcp/udp）</li>
                                                        </ol>
                                                        <p id="28c7"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            V2Ray 内置 DNS 还有一个叫 <code
                                                                class="cw ou ov ow oh b">clientIp</code>
                                                            的项是什么用的？我个人不太建议去依赖这个选项，但如果你想知道它的作用，是这样的，假如上面例子中真的在路由规则上配置错了，出现了这个线路的情况：
                                                        </p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="9ea6" class="nd ne gt oh b in ol om l on oo">内置 DNS 查询 www.bilibili.com -&gt; 内置 DNS 通过分流功能选择了 223.5.5.5 -&gt; 通过路由功能选择了 VMess outbound -&gt; VMess 代理服务器 -&gt; 223.5.5.5</span></pre>
                                                        <p id="1158"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            那 <code class="cw ou ov ow oh b">clientIP</code> 是 DNS
                                                            请求中可以带上的一个参数，它用来提示 DNS 服务器（223.5.5.5）你所在的地理位置，223.5.5.5
                                                            就知道你在哪，就 <code class="cw ou ov ow oh b">有可能</code>
                                                            会返回一个合适你所在的地理位置的 CDN 的 IP（也即 Bilibili 国内 CDN 的 IP）。</p>
                                                        <p id="15fb"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            关于内置 DNS，最后再说一说 <code
                                                                class="cw ou ov ow oh b">localhost</code> ，上面的描述不适用于
                                                            localhost，简单说，内置 DNS 在向 servers 列表中的 localhost 发 DNS
                                                            请求时，不会用任何 outbound 来发（甚至不用 Freedom
                                                            outbound），而是直接从本机发出，就像任何其它程序做 DNS 请求那样，直接调用系统的 DNS API，用系统
                                                            DNS 中配置的 DNS 服务器。</p>
                                                        <h2 id="709d"
                                                            class="nd ne gt be nf ng nh dx ni nj nk dz nl mp nm nn no mt np nq nr mx ns nt nu nv bj">
                                                            V2Ray DNS Outbound</h2>
                                                        <p id="f68e"
                                                            class="pw-post-body-paragraph me mf gt mg b mh nw mj mk ml nx mn mo mp ny mr ms mt nz mv mw mx oa mz na nb gm bj">
                                                            接下来会说一说 V2Ray 的 DNS outbound。因为我们上面的例子中所说的都是路由模块去调用内置
                                                            DNS，但路由模块仅仅是用它的结果来做规则匹配，而且是当配置了 <code
                                                                class="cw ou ov ow oh b">IPIfNonMatch/IPOnDemand</code>
                                                            ，而且没有匹配任何域名规则的情况下，才用得到它，当下各种域名列表盛行，它的应用范围实际上是很窄的。</p>
                                                        <p id="db02"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            DNS outbound 可以说是一个把内置 DNS
                                                            的功能真正地开放出来，让各种程序、各种模块可以更加方便地使用得上内置 DNS 的一个功能。为什么要把内置 DNS
                                                            开放出来呢？很明显啊，因为现在它支持 <code
                                                                class="cw ou ov ow oh b">DNS 分流</code>
                                                            ，相信大部分读者都知道已经存在很多专门做 DNS 分流的工具，这已经说明 DNS 分流是一个很有用的功能，而 V2Ray
                                                            已经支持 DNS 分流了，可是外部用不了就等于没有，所以就得开放出来。</p>
                                                        <p id="bad8"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            要说 DNS outbound 的配置，它目前就只有那么 3 （network, address, port）个配置项：
                                                        </p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="7bfe" class="nd ne gt oh b in ol om l on oo">&quot;outbounds&quot;: [<br/>    {<br/>        &quot;tag&quot;: &quot;dns-out&quot;,<br/>        &quot;protocol&quot;: &quot;dns&quot;,<br/>        &quot;settings&quot;: {<br/>            &quot;network&quot;: &quot;tcp&quot;,<br/>            &quot;address&quot;: &quot;1.1.1.1&quot;,<br/>            &quot;port&quot;: 53<br/>        }<br/>    }<br/>]</span></pre>
                                                        <p id="598d"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            而这 3 个配置项其实都不是本文想要关注的点，下文只会稍微提一下。DNS outbound
                                                            最重要的功能是它的默认行为：对进来的 DNS 流量进行拦截、解析，以及对 A, AAAA 类型的 DNS
                                                            查询做重新转发。</p>
                                                        <p id="a1c9"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            其中最难理解的，恐怕就是 “拦截”、“重新转发” 两个词的具体意思。</p>
                                                        <p id="ea25"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            这里可以回看上面的 F1，是这么描述一般 DNS 请求的：</p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="2505" class="nd ne gt oh b in ol om l on oo">一般这种 DNS 请求都是纯文本（我们也只讨论这种 DNS），它们所流经的各种设备，各种程序都可以看到，可以修改里面的内容，发出的请求可以修改，返回的结果也可以修改，甚至修改过后毫无痕迹，就是说，对于发出的请求，DNS 服务器没办法知道它是否在中间链路被修改过，对于返回的结果，应用程序也没办法知道它是否在中间链路被修改过。</span></pre>
                                                        <p id="acc6"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            对于进入到 DNS outbound 里面的流量，DNS outbound 会把这个流量当作是 DNS
                                                            请求，也就是说把它当作一块数据，这块数据里面包含了 DNS 请求相关的信息，包括但不限于：DNS 请求的域名，DNS
                                                            请求的记录类型；还有所有类型的 outbound
                                                            都能够得到的一些通常的信息，比如这个流量的目的地址，目的端口，所用传输协议等等，这些信息都是 DNS outbound
                                                            能够轻易得到的。</p>
                                                        <p id="2822"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            因为 DNS 请求里面的数据都是明文的，流经的中间设备、中间模块都看得到里面内容，那 DNS 请求的流量既然流经 DNS
                                                            outbound，DNS outbound 理所当然也能看得到；而且返回数据的时候，就算 DNS outbound
                                                            把返回的数据删改了，或者索性自己凭空生成一个假的 DNS 回复返回给应用程序，应用程序也没办法知道真假。</p>
                                                        <p id="0000"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            这就是 DNS outbound 的工作原理。只不过它并不是凭空生成一个假的 DNS 回复，而是求助于内置 DNS
                                                            模块：</p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="6336" class="nd ne gt oh b in ol om l on oo">1. 某个应用程序发了一个 DNS 查询</span><span id="42c8" class="nd ne gt oh b in op om l on oo">2. 这个 DNS 查询的流量通过某种方式进入了 DNS outbound（这里暂时不讨论究竟是通过什么方式进入 DNS outbound 的）</span><span id="9bf9" class="nd ne gt oh b in op om l on oo">3. 如果这个流量是个明文 DNS 请求，DNS outbound 肯定看得到里面内容，可以拿出里面的域名</span><span id="730f" class="nd ne gt oh b in op om l on oo">4. DNS outbound 调用内置 DNS 模块，把拿到的域名传进去</span><span id="df41" class="nd ne gt oh b in op om l on oo">5. 内置 DNS 模块根据它的配置去查这个域名的 IP，具体怎么查的，DNS outbound 并不知道，它只管要结果</span><span id="c72b" class="nd ne gt oh b in op om l on oo">6. 内置 DNS 返回一些 IP 给 DNS outbound 后，DNS outbound 用这些 IP 生成了一个 DNS 回复</span><span id="efa3" class="nd ne gt oh b in op om l on oo">7. DNS outbound 把这个 DNS 回复若无其事地返回给应用程序</span><span id="5813" class="nd ne gt oh b in op om l on oo">8. 应用程序当然不知道这个 DNS 回复具体是怎么来的，它没办法，只能相信中间链路，相信这个回复就是它想要的回复</span></pre>
                                                        <p id="1822"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            DNS outbound 的这种行为，实质上相当于 DNS 劫持，但说它是 DNS
                                                            劫持也不太对，因为是我们配置的，自愿让它 “劫持” 的嘛。</p>
                                                        <p id="ecf2"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            DNS outbound 本身的工作原理相信已经比较清晰了，它只是劫持了进来的 DNS 请求的流量，然后找内置 DNS
                                                            模块帮忙解析 DNS，然后假装啥事没发生，返回结果而已。</p>
                                                        <blockquote class="oq or os">
                                                            <p id="8c71"
                                                                class="me mf ot mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                                要应用它，重点在于要用什么样的方式，把 DNS 流量引导到 DNS outbound 里去。</p>
                                                        </blockquote>
                                                        <p id="7db4"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            对于桌面系统，如果用浏览器来访问网站，那么，前面也说了，SOCKS5
                                                            协议可以带上域名给远端解析，根本不需要本地去解析域名。但假如不是用浏览器的情况呢？比如运行一个 nslookup
                                                            命令，默认它也不会用系统设置的代理，它是直接向系统设置的 DNS 服务器发 DNS 请求，怎么把这个请求的流量引导到
                                                            V2Ray 的 DNS outbound 呢？</p>
                                                        <p id="0ac0"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            考虑下以下配置：</p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="6557" class="nd ne gt oh b in ol om l on oo">{<br/>    &quot;inbounds&quot;: [<br/>        {<br/>            &quot;port&quot;: 53,<br/>            &quot;tag&quot;: &quot;dns-in&quot;,<br/>            &quot;protocol&quot;: &quot;dokodemo-door&quot;,<br/>            &quot;settings&quot;: {<br/>                &quot;address&quot;: &quot;1.1.1.1&quot;,<br/>                &quot;port&quot;: 53,<br/>                &quot;network&quot;: &quot;tcp,udp&quot;<br/>            }<br/>        }<br/>    ],<br/>    &quot;dns&quot;: {<br/>        &quot;hosts&quot;: {<br/>            &quot;domain:<a class="af nc" href="http://www.bilibili.com" rel="noopener ugc nofollow" target="_blank">www.bilibili.com</a>&quot;: &quot;1.2.3.4&quot;<br/>        }<br/>    },<br/>    &quot;outbounds&quot;: [<br/>        {<br/>            &quot;protocol&quot;: &quot;dns&quot;,<br/>            &quot;tag&quot;: &quot;dns-out&quot;<br/>        },<br/>        {<br/>            &quot;protocol&quot;: &quot;freedom&quot;,<br/>            &quot;tag&quot;: &quot;direct&quot;,<br/>            &quot;settings&quot;: {}<br/>        }<br/>    ],<br/>    &quot;routing&quot;: {<br/>        &quot;rules&quot;: [<br/>            {<br/>                &quot;type&quot;: &quot;field&quot;,<br/>                &quot;inboundTag&quot;: [&quot;dns-in&quot;],<br/>                &quot;outboundTag&quot;: &quot;dns-out&quot;<br/>            }<br/>        ],<br/>        &quot;strategy&quot;: &quot;rules&quot;<br/>    }<br/>}</span></pre>
                                                        <p id="fad0"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            这个配置让 V2Ray 的 dokodemo-door inbound 监听在本地 53
                                                            端口，对于任何进来的流量，会因为我们的路由规则，而被送到 DNS outbound 处理，然后我们把系统 DNS 设置为
                                                            127.0.0.1，相当于说 V2Ray 的 dokodemo-door inbound 就是一个 DNS 服务器。
                                                        </p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="0815" class="nd ne gt oh b in ol om l on oo">1. 命令行执行 nslookup <a class="af nc" href="http://www.bilibili.com" rel="noopener ugc nofollow" target="_blank">www.bilibili.com</a><br/>2. 因为系统 DNS 设置为 127.0.0.1<br/>3. DNS 请求发到 dokodemo-door inbound<br/>4. 因为 &quot;dns-in&quot; -&gt; &quot;dns-out&quot; 路由规则，流量传给 DNS outbound<br/>5. DNS outbound 识别到是个 DNS 请求，拿到域名 www.bilibili.com，调用内置 DNS<br/>6. 这个域名匹配到内置 DNS 的一条 hosts 规则，返回结果 1.2.3.4<br/>7. 于是 nslookup 查询 <a class="af nc" href="http://www.bilibili.com" rel="noopener ugc nofollow" target="_blank">www.bilibili.com</a> 的结果是 1.2.3.4</span></pre>
                                                        <p id="02c3"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            让 V2Ray 充当 DNS 服务器，设置系统 DNS 是其中一个把 DNS 流量引导到 DNS outbound
                                                            中的方式。但今天我们大部分的上网操作都是在浏览器上进行了，浏览器用了 SOCKS5 代理的话也不需要本地去解析
                                                            DNS，所以这个应用场景不常见。</p>
                                                        <blockquote class="oq or os">
                                                            <p id="e501"
                                                                class="me mf ot mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                                DNS outbound 开放出来后，最重要的应用场景，是在移动端和路由器上。</p>
                                                        </blockquote>
                                                        <p id="736d"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            在讨论移动端和路由器之前，先看看桌面系统上怎样可以做真正的全局代理。前面也说了，一般的浏览器代理，只代理浏览器的流量，要把
                                                            DNS 流量也代理了，就需要像上面那样更改系统 DNS 为 127.0.0.1，当我们需要真正的全局代理时（VPN
                                                            就是真正的全局代理），这种方便显然不合适，也不可能做得到真正全局代理。</p>
                                                        <h2 id="b828"
                                                            class="nd ne gt be nf ng nh dx ni nj nk dz nl mp nm nn no mt np nq nr mx ns nt nu nv bj">
                                                            tun2socks</h2>
                                                        <p id="a365"
                                                            class="pw-post-body-paragraph me mf gt mg b mh nw mj mk ml nx mn mo mp ny mr ms mt nz mv mw mx oa mz na nb gm bj">
                                                            下面介绍一种通过 tun2socks，能够把所有本机应用程序发出的流量都交给
                                                            V2Ray/SOCKS/Shadowsocks，从而达到全局 TCP/UDP 代理（对，只是 TCP/UDP，ICMP
                                                            等等是不支持的，全局性还是不比真正的 VPN）。</p>
                                                        <p id="0d94"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            为此我特意写了一篇关于在 Windows 上如何使用 tun2socks 实现全局 TCP/UDP 流量代理的教程：
                                                        </p>
                                                        <div class="pf pg ph pi pj pk"><a
                                                                href="https://medium.com/@TachyonDevel/%E6%95%99%E7%A8%8B-%E5%9C%A8-windows-%E4%B8%8A%E4%BD%BF%E7%94%A8-tun2socks-%E8%BF%9B%E8%A1%8C%E5%85%A8%E5%B1%80%E4%BB%A3%E7%90%86-aa51869dd0d?source=post_page-----62c50e58cbd0--------------------------------"
                                                                rel="noopener follow" target="_blank">
                                                                <div class="pl ab iw">
                                                                    <div class="pm ab cn ca pn po">
                                                                        <h2
                                                                            class="be gu in z pp pq pr ps pt pu pv gs bj">
                                                                            [教程] 在 Windows 上使用 tun2socks 进行全局代理</h2>
                                                                        <div class="pw l">
                                                                            <h3
                                                                                class="be b in z pp pq pr ps pt pu pv dt">
                                                                                这是一篇在 Windows 上使用 tun2socks 进行全局 TCP/UDP
                                                                                流量代理的教程，有别于一般仅使用 SOCKS5…</h3>
                                                                        </div>
                                                                        <div class="px l">
                                                                            <p
                                                                                class="be b du z pp pq pr ps pt pu pv dt">
                                                                                medium.com</p>
                                                                        </div>
                                                                    </div>
                                                                    <div class="py l">
                                                                        <div class="pz l qa qb qc py qd qe pk"></div>
                                                                    </div>
                                                                </div>
                                                            </a></div>
                                                        <p id="41a4"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            tun2socks 就是这么一种可以把所有应用程序的 TCP/UDP 流量都交给 V2Ray 的方式，当然其中包括
                                                            DNS 的流量，所以用了 tun2socks 后，我们甚至不需要更改系统的 DNS 设置，所有 DNS
                                                            请求的流量都能够被引导到 V2Ray，然后我们可以在 V2Ray 里加一条路由规则，识别出 DNS
                                                            的流量，把这些流量转给 DNS outbound：</p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="8751" class="nd ne gt oh b in ol om l on oo">{<br/>    &quot;dns&quot;: {<br/>        &quot;hosts&quot;: {<br/>            &quot;domain:<a class="af nc" href="http://www.bilibili.com" rel="noopener ugc nofollow" target="_blank">www.bilibili.com</a>&quot;: &quot;1.2.3.4&quot;<br/>        }<br/>    },<br/>    &quot;outbounds&quot;: [<br/>        {<br/>            &quot;protocol&quot;: &quot;dns&quot;,<br/>            &quot;tag&quot;: &quot;dns-out&quot;<br/>        },<br/>        {<br/>            // VMess outbound<br/>        }<br/>    ],<br/>    &quot;routing&quot;: {<br/>        &quot;rules&quot;: [<br/>            {<br/>                &quot;type&quot;: &quot;field&quot;,<br/>                &quot;network&quot;: &quot;udp&quot;,<br/>                &quot;port&quot;: 53,<br/>                &quot;outboundTag&quot;: &quot;dns-out&quot;<br/>            }<br/>        ],<br/>        &quot;strategy&quot;: &quot;rules&quot;<br/>    }<br/>}</span></pre>
                                                        <p id="b9af"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            配置做了简化，真拿来用的话要自己补上其它部分。配置中没有 inbound，因为我们所用的 tun2socks 软件：<a
                                                                class="af nc"
                                                                href="https://github.com/eycorsican/go-tun2socks"
                                                                rel="noopener ugc nofollow"
                                                                target="_blank">go-tun2socks</a> 本身把 tun2socks 内置为 V2Ray
                                                            的一个 inbound 了。</p>
                                                        <blockquote class="oq or os">
                                                            <p id="4ab0"
                                                                class="me mf ot mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                                <code class="cw ou ov ow oh b">go-tun2socks</code>
                                                                是一个命令行工具，要使用的话还要自己创建 TUN 接口，配置路由表等，比较繁琐，这里还有另一个应用叫 <a
                                                                    class="af nc"
                                                                    href="https://github.com/eycorsican/Mellow"
                                                                    rel="noopener ugc nofollow"
                                                                    target="_blank">Mellow</a> ，对 <code
                                                                    class="cw ou ov ow oh b">go-tun2socks</code>
                                                                进行了包装，可以自动完成这些繁琐的步骤，实际使用起来的效果就相当于 Proxifier、SSTap、Surge
                                                                for Mac 等软件，可以把所有流量都代理了：
                                                            </p>
                                                        </blockquote>
                                                        <div class="pf pg ph pi pj pk"><a
                                                                href="https://github.com/eycorsican/Mellow?source=post_page-----62c50e58cbd0--------------------------------"
                                                                rel="noopener  ugc nofollow" target="_blank">
                                                                <div class="pl ab iw">
                                                                    <div class="pm ab cn ca pn po">
                                                                        <h2
                                                                            class="be gu in z pp pq pr ps pt pu pv gs bj">
                                                                            eycorsican/Mellow</h2>
                                                                        <div class="pw l">
                                                                            <h3
                                                                                class="be b in z pp pq pr ps pt pu pv dt">
                                                                                A V2Ray client that can handle all
                                                                                TCP/UDP/ICMP traffic. -
                                                                                eycorsican/Mellow</h3>
                                                                        </div>
                                                                        <div class="px l">
                                                                            <p
                                                                                class="be b du z pp pq pr ps pt pu pv dt">
                                                                                github.com</p>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </a></div>
                                                        <p id="30cb"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            说白了，目的还是之前所说的，找到一种方法把 DNS 请求的流量引导到 DNS outbound 中。</p>
                                                        <h2 id="8260"
                                                            class="nd ne gt be nf ng nh dx ni nj nk dz nl mp nm nn no mt np nq nr mx ns nt nu nv bj">
                                                            移动端环境</h2>
                                                        <p id="6b84"
                                                            class="pw-post-body-paragraph me mf gt mg b mh nw mj mk ml nx mn mo mp ny mr ms mt nz mv mw mx oa mz na nb gm bj">
                                                            上面提 tun2socks，是因为在移动端上，要代理所有 app 的流量，tun2socks
                                                            是一种必须的手段，它们跟桌面系统上用 tun2socks 很相似，都是要把所有的 TCP/UDP 流量引导进
                                                            V2Ray，但也有不一样的地方，<em
                                                                class="ot">移动端系统一般都提供了特殊的方法，能够让指定的流量不受路由表基于 IP
                                                                地址的路由控制</em>。</p>
                                                        <p id="cc93"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            在移动端系统方面，iOS 既可以像桌面系统用 tun2socks 那样把所有 TCP/UDP 流量引导到
                                                            V2Ray，也可以设置一个 HTTP 代理把 HTTP 请求代理到 V2Ray 的 HTTP inbound 里；而
                                                            Android，只能以 tun2socks 那样的方式把 TCP/UDP 流量引导进去。</p>
                                                        <p id="77ce"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            iOS 的 HTTP/S 代理跟 SOCKS5 代理比较相似，应用程序不需要自己解析 DNS，可以把域名带上交给
                                                            V2Ray，然后如果请求匹配到代理的路由规则，这个域名就通过代理协议（VMess/Shadowsocks/SOCKS5）交给代理服务器自己去解析，所以本地不需要做任何
                                                            DNS 解析。问题是很明显这个只适用于 HTTP/S 请求（而且并不是所有的 HTTP/S 请求，貌似应用程序还必须要用
                                                            iOS 系统提供的 HTTP 库来做请求才会被代理到）。</p>
                                                        <p id="42b2"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            再考虑到 Android 并不能很自然地支持 HTTP/S 或者 SOCKS5
                                                            代理，所以想要一个通用的解决方案，还是要从 TCP/UDP 流量入手。</p>
                                                        <p id="0b56"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            假如你使用的 Android 客户端是 <a class="af nc"
                                                                href="https://play.google.com/store/apps/details?id=fun.kitsunebi.kitsunebi4android"
                                                                rel="noopener ugc nofollow"
                                                                target="_blank">Kitsunebi</a>，那大致上可以这么配置：</p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="38b7" class="nd ne gt oh b in ol om l on oo">{<br/>    &quot;dns&quot;: {<br/>        &quot;hosts&quot;: {<br/>            &quot;domain:<a class="af nc" href="http://www.bilibili.com" rel="noopener ugc nofollow" target="_blank">www.bilibili.com</a>&quot;: &quot;1.2.3.4&quot;<br/>        },<br/>        &quot;servers&quot;: [<br/>            &quot;114.114.114.114&quot;,<br/>            {<br/>                &quot;address&quot;: &quot;8.8.8.8&quot;,<br/>                &quot;domains&quot;: [<br/>                    &quot;google&quot;<br/>                ],<br/>                &quot;port&quot;: 53<br/>            }<br/>        ]<br/>    },<br/>    &quot;outbounds&quot;: [<br/>        {<br/>            &quot;protocol&quot;: &quot;vmess&quot;,<br/>            &quot;tag&quot;: &quot;proxy&quot;<br/>        },<br/>        {<br/>            &quot;protocol&quot;: &quot;freedom&quot;,<br/>            &quot;settings&quot;: {},<br/>            &quot;tag&quot;: &quot;direct&quot;<br/>        },<br/>     {<br/>         &quot;protocol&quot;: &quot;dns&quot;,<br/>         &quot;tag&quot;: &quot;dns-out&quot;<br/>     }<br/>    ],<br/>    &quot;routing&quot;: {<br/>        &quot;rules&quot;: [<br/>            {<br/>                &quot;inboundTag&quot;: [&quot;tun2socks&quot;],<br/>                &quot;network&quot;: &quot;udp&quot;,<br/>                &quot;port&quot;: 53,<br/>                &quot;outboundTag&quot;: &quot;dns-out&quot;,<br/>                &quot;type&quot;: &quot;field&quot;<br/>            },<br/>            {<br/>                &quot;ip&quot;: [<br/>                    &quot;8.8.8.8/32&quot;<br/>                ],<br/>                &quot;outboundTag&quot;: &quot;proxy&quot;,<br/>                &quot;type&quot;: &quot;field&quot;<br/>            }<br/>        ],<br/>        &quot;strategy&quot;: &quot;rules&quot;<br/>    }<br/>}</span></pre>
                                                        <p id="79ff"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            配置中的 inboundTag tun2socks 是必须的，虽然单凭 53 端口 和 network udp
                                                            大致达到识别出 UDP 流量的目的，但因为在 V2Ray 中 UDP 流量并不只从 tun2socks inbound
                                                            进来，还会从 内置 DNS 那边过来，如果不加上 inboundTag tun2socks 这个限制，内置 DNS
                                                            那边过来的流量就会被转到 DNS outbound，接着有可能又被转给 内置 DNS，造成环路。</p>
                                                        <p id="b9ff"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            通过前面桌面端上对 V2Ray 的 内置 DNS 和 DNS outbound 的说明，现在移动端也可以方便地拿到所有
                                                            TCP/UDP 流量，上面的方法都可以套用下来，就不继续说了。</p>
                                                        <p id="4b05"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            大体上，从流量流向的角度来看，一般 DNS 处理方式也就 3 种：</p>
                                                        <ul class="">
                                                            <li id="2156"
                                                                class="me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb qf oy oz bj">
                                                                直接从本机发出 DNS 请求到目的 DNS 服务器</li>
                                                            <li id="972f"
                                                                class="me mf gt mg b mh pa mj mk ml pb mn mo mp pc mr ms mt pd mv mw mx pe mz na nb qf oy oz bj">
                                                                通过代理把 DNS 请求发送到目的 DNS 服务器</li>
                                                            <li id="afb8"
                                                                class="me mf gt mg b mh pa mj mk ml pb mn mo mp pc mr ms mt pd mv mw mx pe mz na nb qf oy oz bj">
                                                                本机不向互联网发出 DNS 请求流量（由远端代理服务器来解析或者直接本地伪造 DNS 答复返回）</li>
                                                        </ul>
                                                        <h2 id="2d7c"
                                                            class="nd ne gt be nf ng nh dx ni nj nk dz nl mp nm nn no mt np nq nr mx ns nt nu nv bj">
                                                            Fake DNS</h2>
                                                        <p id="4cf6"
                                                            class="pw-post-body-paragraph me mf gt mg b mh nw mj mk ml nx mn mo mp ny mr ms mt nz mv mw mx oa mz na nb gm bj">
                                                            虽然现在已经可以完全利用 V2Ray 的 DNS 功能模块对 DNS 的 UDP 流量做各种处理，可以对 DNS
                                                            请求按域名做分流，但仔细想想，分流时不管是发到 freedom outbound 直连还是发到 VMess
                                                            outbound 代理，这些 DNS 请求终究是要以实际的流量形式从本地发送到互联网上，是否有方法可以在利用
                                                            tun2socks 获取所有 TCP/UDP 流量的同时，又可以像 HTTP/S 和 SOCKS5
                                                            代理那样，本地完全不发出 DNS 请求流量，只把域名交给代理服务器，让代理服务器自己去解析呢？</p>
                                                        <p id="b90a"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            答案是有的，那就是 Fake DNS，Fake DNS 是有一个 <a class="af nc"
                                                                href="https://tools.ietf.org/html/rfc3089"
                                                                rel="noopener ugc nofollow" target="_blank">RFC</a>
                                                            的，某些使用 iOS 的读者可能也并不陌生，Surge 中的 <code
                                                                class="cw ou ov ow oh b">force-remote-dns</code>
                                                            就是利用了这种技术。</p>
                                                        <p id="903d"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            大致工作原理如下：</p>
                                                        <pre
                                                            class="ob oc od oe of og oh oi oj ax ok bj"><span id="aeef" class="nd ne gt oh b in ol om l on oo">1. 手机上某个 app 想发出 <a class="af nc" href="https://www.google.com" rel="noopener ugc nofollow" target="_blank">https://www.google.com</a> 请求</span><span id="f67d" class="nd ne gt oh b in op om l on oo">2. app 发出 <a class="af nc" href="http://www.google.com" rel="noopener ugc nofollow" target="_blank">www.google.com</a> 的 DNS 查询</span><span id="a384" class="nd ne gt oh b in op om l on oo">3. DNS 请求的 UDP 流量来到 tun2socks，被 tun2socks 交到 Fake DNS 模块</span><span id="952a" class="nd ne gt oh b in op om l on oo">4. Fake DNS 模块选择一个伪造的 IP 地址，比如 244.0.0.3，并把这个地址跟 <a class="af nc" href="http://www.google.com" rel="noopener ugc nofollow" target="_blank">www.google.com</a> 关联起来</span><span id="e1ea" class="nd ne gt oh b in op om l on oo">5. Fake DNS 根据 DNS 请求，生成相应的 DNS 答复，并把 244.0.0.3 当作 DNS 结果放进答复中，通过 tun2socks 把这个伪造的 DNS 答复返回给 app</span><span id="54a5" class="nd ne gt oh b in op om l on oo">6. app 得到 <a class="af nc" href="http://www.google.com" rel="noopener ugc nofollow" target="_blank">www.google.com</a> 的 DNS 查询结果是 244.0.0.3</span><span id="448d" class="nd ne gt oh b in op om l on oo">7. app 向 244.0.0.3 发出 HTTP 请求流量</span><span id="d999" class="nd ne gt oh b in op om l on oo">8. HTTP 请求流量来到 tun2socks，tun2socks 向 Fake DNS 模块查询目的地址 244.0.0.3 是否是一个伪造的 IP 地址，如果是，向 Fake DNS 查询这个 IP 所关联的 域名，也即 <a class="af nc" href="http://www.google.com" rel="noopener ugc nofollow" target="_blank">www.google.com</a></span><span id="faf0" class="nd ne gt oh b in op om l on oo">9. tun2socks 现在已经得到 HTTP 请求流量的域名，把流量以及域名一并交给 V2Ray</span><span id="b0e4" class="nd ne gt oh b in op om l on oo">10. V2Ray 有了域名，接下来路由什么的该怎么处理就怎么处理了</span></pre>
                                                        <p id="857b"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            上面过程中，虽然 app 是发出了 DNS 请求流量，但这个流量被拦截下来了，并没有真正地发到互联网上；最终 V2Ray
                                                            也拿到了域名，如果这个域名匹配到代理规则，就会交到代理服务器来解析，也就是所谓的 远程 DNS 解析。</p>
                                                        <p id="a2a9"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            上面过程中，Fake DNS 模块如果没有对域名做过滤，对任何域名都返回伪造的 IP
                                                            地址，则可能会引起一些问题，有一种做法是在 Fake DNS 模块里内置一个域名列表，只对匹配到列表的域名返回 伪造
                                                            DNS 答复。</p>
                                                        <p id="a547"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            Fake DNS 不管是原理上还是实现上都是非常简单的，如果有兴趣可以看一下 <a class="af nc"
                                                                href="https://github.com/eycorsican/leaf/blob/master/leaf/src/app/fake_dns.rs"
                                                                rel="noopener ugc nofollow" target="_blank">这里的实现代码</a>。
                                                        </p>
                                                        <h2 id="b2c9"
                                                            class="nd ne gt be nf ng nh dx ni nj nk dz nl mp nm nn no mt np nq nr mx ns nt nu nv bj">
                                                            DNS Fallback</h2>
                                                        <p id="e449"
                                                            class="pw-post-body-paragraph me mf gt mg b mh nw mj mk ml nx mn mo mp ny mr ms mt nz mv mw mx oa mz na nb gm bj">
                                                            接下来再说说一种叫做 DNS fallback 的技术（这个名字可能不太对），在代理服务器不支持 UDP
                                                            的时候，<strong class="mg gu">单纯的全局 TCP/UDP 流量代理
                                                            </strong>就会出问题了，因为要解析 DNS 就需要 UDP，服务器不支持 UDP 就没办法处理 DNS
                                                            ，也就没办法处理所有域名请求了，DNS fallback 是一种可以强制让应用程序把 DNS 请求以 TCP
                                                            流量发送出去的技术。</p>
                                                        <blockquote class="oq or os">
                                                            <p id="9801"
                                                                class="me mf ot mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                                需要说明的是，如果用了 V2Ray 的技术，或者 Fake DNS，那 DNS fallback
                                                                是没必要的，DNS fallback 也是一种处理 DNS 相关问题技术，这里只是想把这种技术也列举出来</p>
                                                        </blockquote>
                                                        <p id="57f1"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            众所周知一般的 DNS 请求都是用 UDP 发的，但 DNS 的 UDP 报文的大小会被限制在大概 512
                                                            字节，如果某个 DNS 答复很长，超过了这个限制，就不能通过 UDP 来传输了，为此 DNS
                                                            规范中提出，对于这种超过限制大小的 DNS 请求，DNS 服务器可以在答复中设置一个
                                                            flag（truncated），来告诉客户端这个答复太长，你不能用 UDP 来做这个 DNS 请求，请用
                                                            TCP，于是客户端就会用 TCP 来重新请求 DNS。</p>
                                                        <p id="c342"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            DNS fallback 正是利用了这一点，在 tun2socks 给过来的 UDP 流量中识别出 DNS
                                                            请求，然后伪造一个设置了 truncated flag 的答复返回给客户端，客户端就会转用 TCP 来做 DNS
                                                            请求了。</p>
                                                        <p id="83b7"
                                                            class="pw-post-body-paragraph me mf gt mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb gm bj">
                                                            DNS fallback 的实现也是非常简单的，有兴趣可以看一下 <a class="af nc"
                                                                href="https://github.com/eycorsican/go-tun2socks/blob/master/proxy/dnsfallback/udp.go"
                                                                rel="noopener ugc nofollow" target="_blank">这里的代码</a>。
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </section>
                                </div>
                            </div>
                        </article>
                        <div class="ab ca">
                            <div class="ch bg fy fz ga gb"></div>
                        </div>
                    </div>
                    <div class="ab ca">
                        <div class="ch bg fy fz ga gb">
                            <div class="qg qh ab iz">
                                <div class="pw ab"><a class="qi ax am ao"
                                        href="https://medium.com/tag/dns?source=post_page-----62c50e58cbd0---------------dns-----------------"
                                        rel="noopener follow">
                                        <div class="qj fi cw qk gd ql qm be b bf z bj qn">DNS</div>
                                    </a></div>
                                <div class="pw ab"><a class="qi ax am ao"
                                        href="https://medium.com/tag/v2ray?source=post_page-----62c50e58cbd0---------------v2ray-----------------"
                                        rel="noopener follow">
                                        <div class="qj fi cw qk gd ql qm be b bf z bj qn">V2ray</div>
                                    </a></div>
                                <div class="pw ab"><a class="qi ax am ao"
                                        href="https://medium.com/tag/proxy?source=post_page-----62c50e58cbd0---------------proxy-----------------"
                                        rel="noopener follow">
                                        <div class="qj fi cw qk gd ql qm be b bf z bj qn">Proxy</div>
                                    </a></div>
                                <div class="pw ab"><a class="qi ax am ao"
                                        href="https://medium.com/tag/fakedns?source=post_page-----62c50e58cbd0---------------fakedns-----------------"
                                        rel="noopener follow">
                                        <div class="qj fi cw qk gd ql qm be b bf z bj qn">Fakedns</div>
                                    </a></div>
                                <div class="pw ab"><a class="qi ax am ao"
                                        href="https://medium.com/tag/dnsfallback?source=post_page-----62c50e58cbd0---------------dnsfallback-----------------"
                                        rel="noopener follow">
                                        <div class="qj fi cw qk gd ql qm be b bf z bj qn">Dnsfallback</div>
                                    </a></div>
                            </div>
                        </div>
                    </div>
                    <div class="l"></div>
                    <footer class="qo qp qq qr qs qt qu qv qw ab q qx qy c">
                        <div class="l ae">
                            <div class="ab ca">
                                <div class="ch bg fy fz ga gb">
                                    <div class="ab co qz">
                                        <div class="ab q ki">
                                            <div class="ra l"><span class="l rb rc rd e d">
                                                    <div class="ab q ki kj">
                                                        <div class="pw-multi-vote-icon fi kk kl km kn"><span><a
                                                                    class="af ag ah ai aj ak al am an ao ap aq ar as at"
                                                                    data-testid="footerClapButton"
                                                                    href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Fp%2F62c50e58cbd0&amp;operation=register&amp;redirect=https%3A%2F%2Ftachyondevel.medium.com%2F%25E6%25BC%25AB%25E8%25B0%2588%25E5%2590%2584%25E7%25A7%258D%25E9%25BB%2591%25E7%25A7%2591%25E6%258A%2580%25E5%25BC%258F-dns-%25E6%258A%2580%25E6%259C%25AF%25E5%259C%25A8%25E4%25BB%25A3%25E7%2590%2586%25E7%258E%25AF%25E5%25A2%2583%25E4%25B8%25AD%25E7%259A%2584%25E5%25BA%2594%25E7%2594%25A8-62c50e58cbd0&amp;user=Tachyon&amp;userId=35c856cf9e4d&amp;source=-----62c50e58cbd0---------------------clap_footer-----------"
                                                                    rel="noopener follow">
                                                                    <div>
                                                                        <div class="bl" aria-hidden="false">
                                                                            <div
                                                                                class="ko ao kp kq kr ks am kt ku kv kn">
                                                                                <svg width="24" height="24"
                                                                                    viewBox="0 0 24 24"
                                                                                    aria-label="clap">
                                                                                    <path fill-rule="evenodd"
                                                                                        clip-rule="evenodd"
                                                                                        d="M11.37.83L12 3.28l.63-2.45h-1.26zM13.92 3.95l1.52-2.1-1.18-.4-.34 2.5zM8.59 1.84l1.52 2.11-.34-2.5-1.18.4zM18.52 18.92a4.23 4.23 0 0 1-2.62 1.33l.41-.37c2.39-2.4 2.86-4.95 1.4-7.63l-.91-1.6-.8-1.67c-.25-.56-.19-.98.21-1.29a.7.7 0 0 1 .55-.13c.28.05.54.23.72.5l2.37 4.16c.97 1.62 1.14 4.23-1.33 6.7zm-11-.44l-4.15-4.15a.83.83 0 0 1 1.17-1.17l2.16 2.16a.37.37 0 0 0 .51-.52l-2.15-2.16L3.6 11.2a.83.83 0 0 1 1.17-1.17l3.43 3.44a.36.36 0 0 0 .52 0 .36.36 0 0 0 0-.52L5.29 9.51l-.97-.97a.83.83 0 0 1 0-1.16.84.84 0 0 1 1.17 0l.97.97 3.44 3.43a.36.36 0 0 0 .51 0 .37.37 0 0 0 0-.52L6.98 7.83a.82.82 0 0 1-.18-.9.82.82 0 0 1 .76-.51c.22 0 .43.09.58.24l5.8 5.79a.37.37 0 0 0 .58-.42L13.4 9.67c-.26-.56-.2-.98.2-1.29a.7.7 0 0 1 .55-.13c.28.05.55.23.73.5l2.2 3.86c1.3 2.38.87 4.59-1.29 6.75a4.65 4.65 0 0 1-4.19 1.37 7.73 7.73 0 0 1-4.07-2.25zm3.23-12.5l2.12 2.11c-.41.5-.47 1.17-.13 1.9l.22.46-3.52-3.53a.81.81 0 0 1-.1-.36c0-.23.09-.43.24-.59a.85.85 0 0 1 1.17 0zm7.36 1.7a1.86 1.86 0 0 0-1.23-.84 1.44 1.44 0 0 0-1.12.27c-.3.24-.5.55-.58.89-.25-.25-.57-.4-.91-.47-.28-.04-.56 0-.82.1l-2.18-2.18a1.56 1.56 0 0 0-2.2 0c-.2.2-.33.44-.4.7a1.56 1.56 0 0 0-2.63.75 1.6 1.6 0 0 0-2.23-.04 1.56 1.56 0 0 0 0 2.2c-.24.1-.5.24-.72.45a1.56 1.56 0 0 0 0 2.2l.52.52a1.56 1.56 0 0 0-.75 2.61L7 19a8.46 8.46 0 0 0 4.48 2.45 5.18 5.18 0 0 0 3.36-.5 4.89 4.89 0 0 0 4.2-1.51c2.75-2.77 2.54-5.74 1.43-7.59L18.1 7.68z">
                                                                                    </path>
                                                                                </svg>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </a></span></div>
                                                        <div class="pw-multi-vote-count l kw kx ky kz la lb lc">
                                                            <p class="be b du z dt"><span class="ld">--</span></p>
                                                        </div>
                                                    </div>
                                                </span><span class="l h g f re rf">
                                                    <div class="ab q ki kj">
                                                        <div class="pw-multi-vote-icon fi kk kl km kn"><span><a
                                                                    class="af ag ah ai aj ak al am an ao ap aq ar as at"
                                                                    data-testid="footerClapButton"
                                                                    href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Fp%2F62c50e58cbd0&amp;operation=register&amp;redirect=https%3A%2F%2Ftachyondevel.medium.com%2F%25E6%25BC%25AB%25E8%25B0%2588%25E5%2590%2584%25E7%25A7%258D%25E9%25BB%2591%25E7%25A7%2591%25E6%258A%2580%25E5%25BC%258F-dns-%25E6%258A%2580%25E6%259C%25AF%25E5%259C%25A8%25E4%25BB%25A3%25E7%2590%2586%25E7%258E%25AF%25E5%25A2%2583%25E4%25B8%25AD%25E7%259A%2584%25E5%25BA%2594%25E7%2594%25A8-62c50e58cbd0&amp;user=Tachyon&amp;userId=35c856cf9e4d&amp;source=-----62c50e58cbd0---------------------clap_footer-----------"
                                                                    rel="noopener follow">
                                                                    <div>
                                                                        <div class="bl" aria-hidden="false">
                                                                            <div
                                                                                class="ko ao kp kq kr ks am kt ku kv kn">
                                                                                <svg width="24" height="24"
                                                                                    viewBox="0 0 24 24"
                                                                                    aria-label="clap">
                                                                                    <path fill-rule="evenodd"
                                                                                        clip-rule="evenodd"
                                                                                        d="M11.37.83L12 3.28l.63-2.45h-1.26zM13.92 3.95l1.52-2.1-1.18-.4-.34 2.5zM8.59 1.84l1.52 2.11-.34-2.5-1.18.4zM18.52 18.92a4.23 4.23 0 0 1-2.62 1.33l.41-.37c2.39-2.4 2.86-4.95 1.4-7.63l-.91-1.6-.8-1.67c-.25-.56-.19-.98.21-1.29a.7.7 0 0 1 .55-.13c.28.05.54.23.72.5l2.37 4.16c.97 1.62 1.14 4.23-1.33 6.7zm-11-.44l-4.15-4.15a.83.83 0 0 1 1.17-1.17l2.16 2.16a.37.37 0 0 0 .51-.52l-2.15-2.16L3.6 11.2a.83.83 0 0 1 1.17-1.17l3.43 3.44a.36.36 0 0 0 .52 0 .36.36 0 0 0 0-.52L5.29 9.51l-.97-.97a.83.83 0 0 1 0-1.16.84.84 0 0 1 1.17 0l.97.97 3.44 3.43a.36.36 0 0 0 .51 0 .37.37 0 0 0 0-.52L6.98 7.83a.82.82 0 0 1-.18-.9.82.82 0 0 1 .76-.51c.22 0 .43.09.58.24l5.8 5.79a.37.37 0 0 0 .58-.42L13.4 9.67c-.26-.56-.2-.98.2-1.29a.7.7 0 0 1 .55-.13c.28.05.55.23.73.5l2.2 3.86c1.3 2.38.87 4.59-1.29 6.75a4.65 4.65 0 0 1-4.19 1.37 7.73 7.73 0 0 1-4.07-2.25zm3.23-12.5l2.12 2.11c-.41.5-.47 1.17-.13 1.9l.22.46-3.52-3.53a.81.81 0 0 1-.1-.36c0-.23.09-.43.24-.59a.85.85 0 0 1 1.17 0zm7.36 1.7a1.86 1.86 0 0 0-1.23-.84 1.44 1.44 0 0 0-1.12.27c-.3.24-.5.55-.58.89-.25-.25-.57-.4-.91-.47-.28-.04-.56 0-.82.1l-2.18-2.18a1.56 1.56 0 0 0-2.2 0c-.2.2-.33.44-.4.7a1.56 1.56 0 0 0-2.63.75 1.6 1.6 0 0 0-2.23-.04 1.56 1.56 0 0 0 0 2.2c-.24.1-.5.24-.72.45a1.56 1.56 0 0 0 0 2.2l.52.52a1.56 1.56 0 0 0-.75 2.61L7 19a8.46 8.46 0 0 0 4.48 2.45 5.18 5.18 0 0 0 3.36-.5 4.89 4.89 0 0 0 4.2-1.51c2.75-2.77 2.54-5.74 1.43-7.59L18.1 7.68z">
                                                                                    </path>
                                                                                </svg>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </a></span></div>
                                                        <div class="pw-multi-vote-count l kw kx ky kz la lb lc">
                                                            <p class="be b du z dt"><span class="ld">--</span></p>
                                                        </div>
                                                    </div>
                                                </span></div>
                                            <div class="bp ab">
                                                <div>
                                                    <div class="bl" aria-hidden="false"><button
                                                            class="ao ko lg lh ab q fj li lj"
                                                            aria-label="responses"><svg width="24" height="24"
                                                                viewBox="0 0 24 24" class="lf">
                                                                <path
                                                                    d="M18 16.8a7.14 7.14 0 0 0 2.24-5.32c0-4.12-3.53-7.48-8.05-7.48C7.67 4 4 7.36 4 11.48c0 4.13 3.67 7.48 8.2 7.48a8.9 8.9 0 0 0 2.38-.32c.23.2.48.39.75.56 1.06.69 2.2 1.04 3.4 1.04.22 0 .4-.11.48-.29a.5.5 0 0 0-.04-.52 6.4 6.4 0 0 1-1.16-2.65v.02zm-3.12 1.06l-.06-.22-.32.1a8 8 0 0 1-2.3.33c-4.03 0-7.3-2.96-7.3-6.59S8.17 4.9 12.2 4.9c4 0 7.1 2.96 7.1 6.6 0 1.8-.6 3.47-2.02 4.72l-.2.16v.26l.02.3a6.74 6.74 0 0 0 .88 2.4 5.27 5.27 0 0 1-2.17-.86c-.28-.17-.72-.38-.94-.59l.01-.02z">
                                                                </path>
                                                            </svg>
                                                            <p class="be b bf z dt"><span
                                                                    class="pw-responses-count le lf">12</span></p>
                                                        </button></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="ab q">
                                            <div class="rg l iw">
                                                <div>
                                                    <div class="bl" aria-hidden="false"><span><a
                                                                class="af ag ah ai aj ak al am an ao ap aq ar as at"
                                                                data-testid="footerBookmarkButton"
                                                                href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F62c50e58cbd0&amp;operation=register&amp;redirect=https%3A%2F%2Ftachyondevel.medium.com%2F%25E6%25BC%25AB%25E8%25B0%2588%25E5%2590%2584%25E7%25A7%258D%25E9%25BB%2591%25E7%25A7%2591%25E6%258A%2580%25E5%25BC%258F-dns-%25E6%258A%2580%25E6%259C%25AF%25E5%259C%25A8%25E4%25BB%25A3%25E7%2590%2586%25E7%258E%25AF%25E5%25A2%2583%25E4%25B8%25AD%25E7%259A%2584%25E5%25BA%2594%25E7%2594%25A8-62c50e58cbd0&amp;source=--------------------------bookmark_footer-----------"
                                                                rel="noopener follow"><svg width="25" height="25"
                                                                    viewBox="0 0 25 25" fill="none" class="dt ll"
                                                                    aria-label="Add to list bookmark button">
                                                                    <path
                                                                        d="M18 2.5a.5.5 0 0 1 1 0V5h2.5a.5.5 0 0 1 0 1H19v2.5a.5.5 0 1 1-1 0V6h-2.5a.5.5 0 0 1 0-1H18V2.5zM7 7a1 1 0 0 1 1-1h3.5a.5.5 0 0 0 0-1H8a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4V7z"
                                                                        fill="currentColor"></path>
                                                                </svg></a></span></div>
                                                </div>
                                            </div>
                                            <div class="rg l iw">
                                                <div class="bl" aria-hidden="false"
                                                    aria-describedby="postFooterSocialMenu"
                                                    aria-labelledby="postFooterSocialMenu">
                                                    <div>
                                                        <div class="bl" aria-hidden="false"><button
                                                                aria-controls="postFooterSocialMenu"
                                                                aria-expanded="false" aria-label="Share Post"
                                                                data-testid="footerSocialShareButton"
                                                                class="af fj ah ai aj ak al lm an ao ap ew ln lo lj lp"><svg
                                                                    width="24" height="24" viewBox="0 0 24 24"
                                                                    fill="none">
                                                                    <path fill-rule="evenodd" clip-rule="evenodd"
                                                                        d="M15.22 4.93a.42.42 0 0 1-.12.13h.01a.45.45 0 0 1-.29.08.52.52 0 0 1-.3-.13L12.5 3v7.07a.5.5 0 0 1-.5.5.5.5 0 0 1-.5-.5V3.02l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.8a.42.42 0 0 1 .07.5zm-.1.14zm.88 2h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11a2 2 0 0 1-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.14c.1.1.15.22.15.35a.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9V8.96c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1z"
                                                                        fill="currentColor"></path>
                                                                </svg></button></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </footer>
                    <div class="rh ri rj rk rl l bw">
                        <div class="ab ca">
                            <div class="ch bg fy fz ga gb">
                                <div class="ck ab rm co">
                                    <div class="ab ie"><a rel="noopener follow"
                                            href="/?source=post_page-----62c50e58cbd0--------------------------------">
                                            <div class="l rn ro bx rp ii">
                                                <div class="l fi"><img alt="Tachyon" class="l fc bx rq rr cw"
                                                        src="https://miro.medium.com/v2/resize:fill:144:144/0*8tbyh9DEBZIccKB1.jpg"
                                                        width="72" height="72" loading="lazy" />
                                                    <div class="ij bx l rq rr fr n ik fs"></div>
                                                </div>
                                            </div>
                                        </a></div>
                                    <div class="j i d">
                                        <div class="ab"><span><button
                                                    class="be b bf z eo qj ep eq er es et eu ev ew ex ey ez rs fa fb fc bl fd fe">Follow</button></span>
                                            <div class="ds l">
                                                <div>
                                                    <div>
                                                        <div class="bl" aria-hidden="false">
                                                            <div class="l"><span><a
                                                                        class="af ag ah ai aj ak al am an ao ap aq ar as at"
                                                                        href="https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F52f7aa4c8544&amp;operation=register&amp;redirect=https%3A%2F%2Ftachyondevel.medium.com%2F%E6%BC%AB%E8%B0%88%E5%90%84%E7%A7%8D%E9%BB%91%E7%A7%91%E6%8A%80%E5%BC%8F-dns-%E6%8A%80%E6%9C%AF%E5%9C%A8%E4%BB%A3%E7%90%86%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8-62c50e58cbd0&amp;newsletterV3=35c856cf9e4d&amp;newsletterV3Id=52f7aa4c8544&amp;user=Tachyon&amp;userId=35c856cf9e4d&amp;source=-----62c50e58cbd0---------------------subscribe_user-----------"
                                                                        rel="noopener follow"><button
                                                                            class="be b bf z rw am rx ok ry rz sa sb sc sd ev ew ex ey ez fa fb fc bl fd fe"
                                                                            aria-label="Subscribe"><svg width="38"
                                                                                height="38" viewBox="0 0 38 38"
                                                                                fill="none" class="rt ru rv">
                                                                                <rect x="26.25" y="9.25" width="0.5"
                                                                                    height="6.5" rx="0.25"></rect>
                                                                                <rect x="29.75" y="12.25" width="0.5"
                                                                                    height="6.5" rx="0.25"
                                                                                    transform="rotate(90 29.75 12.25)">
                                                                                </rect>
                                                                                <path
                                                                                    d="M19.5 12.5h-7a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h13a1 1 0 0 0 1-1v-5">
                                                                                </path>
                                                                                <path d="M11.5 14.5L19 20l4-3"></path>
                                                                            </svg></button></a></span></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="ab cm co">
                                    <div class="l">
                                        <div class="ab q"><a class="af ag ah ai aj ak al am an ao ap aq ar as at ab q"
                                                rel="noopener follow"
                                                href="/?source=post_page-----62c50e58cbd0--------------------------------">
                                                <h2 class="pw-author-name be se sf sg sh bj"><span class="gm">Written by
                                                        <!-- -->Tachyon</span></h2>
                                            </a></div>
                                        <div class="pw ab">
                                            <div class="l iw"><span class="pw-follower-count be b bf z bj"><a
                                                        class="af ag ah ai aj ak al am an ao ap aq ar ip"
                                                        rel="noopener follow"
                                                        href="/followers?source=post_page-----62c50e58cbd0--------------------------------">619
                                                        Followers</a></span></div>
                                        </div>
                                        <div class="si l">
                                            <p class="be b bf z bj"><a
                                                    class="af ag ah ai aj ak al am an ao ap aq ar nc gn"
                                                    href="mailto:eric.y.corsican@gmail.com"
                                                    rel="noopener  ugc nofollow">eric.y.corsican@gmail.com</a> <a
                                                    class="af ag ah ai aj ak al am an ao ap aq ar nc gn"
                                                    href="https://twitter.com/TachyonDevel"
                                                    rel="noopener  ugc nofollow">https://twitter.com/TachyonDevel</a>
                                            </p>
                                        </div>
                                    </div>
                                    <div class="h k">
                                        <div class="ab"><span><button
                                                    class="be b bf z eo qj ep eq er es et eu ev ew ex ey ez rs fa fb fc bl fd fe">Follow</button></span>
                                            <div class="ds l">
                                                <div>
                                                    <div>
                                                        <div class="bl" aria-hidden="false">
                                                            <div class="l"><span><a
                                                                        class="af ag ah ai aj ak al am an ao ap aq ar as at"
                                                                        href="https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F52f7aa4c8544&amp;operation=register&amp;redirect=https%3A%2F%2Ftachyondevel.medium.com%2F%E6%BC%AB%E8%B0%88%E5%90%84%E7%A7%8D%E9%BB%91%E7%A7%91%E6%8A%80%E5%BC%8F-dns-%E6%8A%80%E6%9C%AF%E5%9C%A8%E4%BB%A3%E7%90%86%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8-62c50e58cbd0&amp;newsletterV3=35c856cf9e4d&amp;newsletterV3Id=52f7aa4c8544&amp;user=Tachyon&amp;userId=35c856cf9e4d&amp;source=-----62c50e58cbd0---------------------subscribe_user-----------"
                                                                        rel="noopener follow"><button
                                                                            class="be b bf z rw am rx ok ry rz sa sb sc sd ev ew ex ey ez fa fb fc bl fd fe"
                                                                            aria-label="Subscribe"><svg width="38"
                                                                                height="38" viewBox="0 0 38 38"
                                                                                fill="none" class="rt ru rv">
                                                                                <rect x="26.25" y="9.25" width="0.5"
                                                                                    height="6.5" rx="0.25"></rect>
                                                                                <rect x="29.75" y="12.25" width="0.5"
                                                                                    height="6.5" rx="0.25"
                                                                                    transform="rotate(90 29.75 12.25)">
                                                                                </rect>
                                                                                <path
                                                                                    d="M19.5 12.5h-7a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h13a1 1 0 0 0 1-1v-5">
                                                                                </path>
                                                                                <path d="M11.5 14.5L19 20l4-3"></path>
                                                                            </svg></button></a></span></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="sj bg sk sl sm sn so sp"></div>
                            </div>
                        </div>
                        <div class="h k j">
                            <div class="sj bg sk sq"></div>
                            <div class="ab ca">
                                <div class="ch bg fy fz ga gb">
                                    <div class="sr ab ki iz">
                                        <div class="ss st l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at"
                                                href="https://help.medium.com/hc/en-us?source=post_page-----62c50e58cbd0--------------------------------"
                                                rel="noopener follow">
                                                <p class="be b du z dt">Help</p>
                                            </a></div>
                                        <div class="ss st l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at"
                                                href="https://medium.statuspage.io/?source=post_page-----62c50e58cbd0--------------------------------"
                                                rel="noopener follow">
                                                <p class="be b du z dt">Status</p>
                                            </a></div>
                                        <div class="ss st l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at"
                                                href="https://medium.com/about?autoplay=1&amp;source=post_page-----62c50e58cbd0--------------------------------"
                                                rel="noopener follow">
                                                <p class="be b du z dt">About</p>
                                            </a></div>
                                        <div class="ss st l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at"
                                                href="https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=post_page-----62c50e58cbd0--------------------------------"
                                                rel="noopener follow">
                                                <p class="be b du z dt">Careers</p>
                                            </a></div>
                                        <div class="ss st l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at"
                                                href="mailto:pressinquiries@medium.com?source=post_page-----62c50e58cbd0--------------------------------"
                                                rel="noopener follow">
                                                <p class="be b du z dt">Press</p>
                                            </a></div>
                                        <div class="ss st l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at"
                                                href="https://blog.medium.com/?source=post_page-----62c50e58cbd0--------------------------------"
                                                rel="noopener follow">
                                                <p class="be b du z dt">Blog</p>
                                            </a></div>
                                        <div class="ss st l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at"
                                                href="https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----62c50e58cbd0--------------------------------"
                                                rel="noopener follow">
                                                <p class="be b du z dt">Privacy</p>
                                            </a></div>
                                        <div class="ss st l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at"
                                                href="https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----62c50e58cbd0--------------------------------"
                                                rel="noopener follow">
                                                <p class="be b du z dt">Terms</p>
                                            </a></div>
                                        <div class="ss st l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at"
                                                href="https://speechify.com/medium?source=post_page-----62c50e58cbd0--------------------------------"
                                                rel="noopener follow">
                                                <p class="be b du z dt">Text to speech</p>
                                            </a></div>
                                        <div class="ss l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at"
                                                href="https://medium.com/business?source=post_page-----62c50e58cbd0--------------------------------"
                                                rel="noopener follow">
                                                <p class="be b du z dt">Teams</p>
                                            </a></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>window.__BUILD_ID__ = "main-20240520-173527-404d6c7138"</script>
    <script>window.__GRAPHQL_URI__ = "https://tachyondevel.medium.com/_/graphql"</script>
    <script>window.__PRELOADED_STATE__ = { "algolia": { "queries": {} }, "cache": { "experimentGroupSet": true, "reason": "", "group": "enabled", "tags": ["group-edgeCachePosts", "post-62c50e58cbd0", "user-35c856cf9e4d"], "serverVariantState": "44136fa355b3678a1146ad16f7e8649e94fb4fc21fe77e8310c060f61caaff8a", "middlewareEnabled": true, "cacheStatus": "DYNAMIC", "shouldUseCache": true, "vary": [], "updatedPostPreviewsEnabled": false, "enableLohpEditorEntry": false, "lohpExperimentEnabled": "control" }, "client": { "hydrated": false, "isUs": false, "isNativeMedium": false, "isSafariMobile": false, "isSafari": false, "isFirefox": false, "routingEntity": { "type": "USER", "id": "35c856cf9e4d", "explicit": true }, "viewerIsBot": false }, "debug": { "requestId": "f4063ae2-dee7-46d0-be9c-02ca829f35e9", "hybridDevServices": [], "originalSpanCarrier": { "ot-tracer-spanid": "25f8405f62b1a053", "ot-tracer-traceid": "32aae469efdc323f", "ot-tracer-sampled": "true" } }, "multiVote": { "clapsPerPost": {} }, "navigation": { "branch": { "show": null, "hasRendered": null, "blockedByCTA": false }, "hideGoogleOneTap": false, "hasRenderedAlternateUserBanner": null, "currentLocation": "https:\u002F\u002Ftachyondevel.medium.com\u002F漫谈各种黑科技式-dns-技术在代理环境中的应用-62c50e58cbd0", "host": "tachyondevel.medium.com", "hostname": "tachyondevel.medium.com", "referrer": "", "hasSetReferrer": false, "susiModal": { "step": null, "operation": "register" }, "postRead": false, "queryString": "", "currentHash": "" }, "config": { "nodeEnv": "production", "version": "main-20240520-173527-404d6c7138", "target": "production", "productName": "Medium", "publicUrl": "https:\u002F\u002Fcdn-client.medium.com\u002Flite", "authDomain": "medium.com", "authGoogleClientId": "216296035834-k1k6qe060s2tp2a2jam4ljdcms00sttg.apps.googleusercontent.com", "favicon": "production", "glyphUrl": "https:\u002F\u002Fglyph.medium.com", "branchKey": "key_live_ofxXr2qTrrU9NqURK8ZwEhknBxiI6KBm", "algolia": { "appId": "MQ57UUUQZ2", "apiKeySearch": "394474ced050e3911ae2249ecc774921", "indexPrefix": "medium_", "host": "-dsn.algolia.net" }, "recaptchaKey": "6Lfc37IUAAAAAKGGtC6rLS13R1Hrw_BqADfS1LRk", "recaptcha3Key": "6Lf8R9wUAAAAABMI_85Wb8melS7Zj6ziuf99Yot5", "recaptchaEnterpriseKeyId": "6Le-uGgpAAAAAPprRaokM8AKthQ9KNGdoxaGUvVp", "datadog": { "applicationId": "6702d87d-a7e0-42fe-bbcb-95b469547ea0", "clientToken": "pub853ea8d17ad6821d9f8f11861d23dfed", "rumToken": "pubf9cc52896502b9413b68ba36fc0c7162", "context": { "deployment": { "target": "production", "tag": "main-20240520-173527-404d6c7138", "commit": "404d6c713878708018aab5173a2a3ba5f551bc54" } }, "datacenter": "us" }, "googleAnalyticsCode": "G-7JY7T788PK", "googlePay": { "apiVersion": "2", "apiVersionMinor": "0", "merchantId": "BCR2DN6TV7EMTGBM", "merchantName": "Medium", "instanceMerchantId": "13685562959212738550" }, "applePay": { "version": 3 }, "signInWallCustomDomainCollectionIds": ["3a8144eabfe3", "336d898217ee", "61061eb0c96b", "138adf9c44c", "819cc2aaeee0"], "mediumMastodonDomainName": "me.dm", "mediumOwnedAndOperatedCollectionIds": ["8a9336e5bb4", "b7e45b22fec3", "193b68bd4fba", "8d6b8a439e32", "54c98c43354d", "3f6ecf56618", "d944778ce714", "92d2092dc598", "ae2a65f35510", "1285ba81cada", "544c7006046e", "fc8964313712", "40187e704f1c", "88d9857e584e", "7b6769f2748b", "bcc38c8f6edf", "cef6983b292", "cb8577c9149e", "444d13b52878", "713d7dbc99b0", "ef8e90590e66", "191186aaafa0", "55760f21cdc5", "9dc80918cc93", "bdc4052bbdba", "8ccfed20cbb2"], "tierOneDomains": ["medium.com", "thebolditalic.com", "arcdigital.media", "towardsdatascience.com", "uxdesign.cc", "codeburst.io", "psiloveyou.xyz", "writingcooperative.com", "entrepreneurshandbook.co", "prototypr.io", "betterhumans.coach.me", "theascent.pub"], "topicsToFollow": ["d61cf867d93f", "8a146bc21b28", "1eca0103fff3", "4d562ee63426", "aef1078a3ef5", "e15e46793f8d", "6158eb913466", "55f1c20aba7a", "3d18b94f6858", "4861fee224fd", "63c6f1f93ee", "1d98b3a9a871", "decb52b64abf", "ae5d4995e225", "830cded25262"], "topicToTagMappings": { "accessibility": "accessibility", "addiction": "addiction", "android-development": "android-development", "art": "art", "artificial-intelligence": "artificial-intelligence", "astrology": "astrology", "basic-income": "basic-income", "beauty": "beauty", "biotech": "biotech", "blockchain": "blockchain", "books": "books", "business": "business", "cannabis": "cannabis", "cities": "cities", "climate-change": "climate-change", "comics": "comics", "coronavirus": "coronavirus", "creativity": "creativity", "cryptocurrency": "cryptocurrency", "culture": "culture", "cybersecurity": "cybersecurity", "data-science": "data-science", "design": "design", "digital-life": "digital-life", "disability": "disability", "economy": "economy", "education": "education", "equality": "equality", "family": "family", "feminism": "feminism", "fiction": "fiction", "film": "film", "fitness": "fitness", "food": "food", "freelancing": "freelancing", "future": "future", "gadgets": "gadgets", "gaming": "gaming", "gun-control": "gun-control", "health": "health", "history": "history", "humor": "humor", "immigration": "immigration", "ios-development": "ios-development", "javascript": "javascript", "justice": "justice", "language": "language", "leadership": "leadership", "lgbtqia": "lgbtqia", "lifestyle": "lifestyle", "machine-learning": "machine-learning", "makers": "makers", "marketing": "marketing", "math": "math", "media": "media", "mental-health": "mental-health", "mindfulness": "mindfulness", "money": "money", "music": "music", "neuroscience": "neuroscience", "nonfiction": "nonfiction", "outdoors": "outdoors", "parenting": "parenting", "pets": "pets", "philosophy": "philosophy", "photography": "photography", "podcasts": "podcast", "poetry": "poetry", "politics": "politics", "privacy": "privacy", "product-management": "product-management", "productivity": "productivity", "programming": "programming", "psychedelics": "psychedelics", "psychology": "psychology", "race": "race", "relationships": "relationships", "religion": "religion", "remote-work": "remote-work", "san-francisco": "san-francisco", "science": "science", "self": "self", "self-driving-cars": "self-driving-cars", "sexuality": "sexuality", "social-media": "social-media", "society": "society", "software-engineering": "software-engineering", "space": "space", "spirituality": "spirituality", "sports": "sports", "startups": "startup", "style": "style", "technology": "technology", "transportation": "transportation", "travel": "travel", "true-crime": "true-crime", "tv": "tv", "ux": "ux", "venture-capital": "venture-capital", "visual-design": "visual-design", "work": "work", "world": "world", "writing": "writing" }, "defaultImages": { "avatar": { "imageId": "1*dmbNkD5D-u45r44go_cf0g.png", "height": 150, "width": 150 }, "orgLogo": { "imageId": "1*OMF3fSqH8t4xBJ9-6oZDZw.png", "height": 106, "width": 545 }, "postLogo": { "imageId": "1*kFrc4tBFM_tCis-2Ic87WA.png", "height": 810, "width": 1440 }, "postPreviewImage": { "imageId": "1*hn4v1tCaJy7cWMyb0bpNpQ.png", "height": 386, "width": 579 } }, "collectionStructuredData": { "8d6b8a439e32": { "name": "Elemental", "data": { "@type": "NewsMediaOrganization", "ethicsPolicy": "https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473", "logo": { "@type": "ImageObject", "url": "https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F980\u002F1*9ygdqoKprhwuTVKUM0DLPA@2x.png", "width": 980, "height": 159 } } }, "3f6ecf56618": { "name": "Forge", "data": { "@type": "NewsMediaOrganization", "ethicsPolicy": "https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473", "logo": { "@type": "ImageObject", "url": "https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F596\u002F1*uULpIlImcO5TDuBZ6lm7Lg@2x.png", "width": 596, "height": 183 } } }, "ae2a65f35510": { "name": "GEN", "data": { "@type": "NewsMediaOrganization", "ethicsPolicy": "https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473", "logo": { "@type": "ImageObject", "url": "https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F264\u002F1*RdVZMdvfV3YiZTw6mX7yWA.png", "width": 264, "height": 140 } } }, "88d9857e584e": { "name": "LEVEL", "data": { "@type": "NewsMediaOrganization", "ethicsPolicy": "https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473", "logo": { "@type": "ImageObject", "url": "https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F540\u002F1*JqYMhNX6KNNb2UlqGqO2WQ.png", "width": 540, "height": 108 } } }, "7b6769f2748b": { "name": "Marker", "data": { "@type": "NewsMediaOrganization", "ethicsPolicy": "https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473", "logo": { "@type": "ImageObject", "url": "https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F383\u002F1*haCUs0wF6TgOOvfoY-jEoQ@2x.png", "width": 383, "height": 92 } } }, "444d13b52878": { "name": "OneZero", "data": { "@type": "NewsMediaOrganization", "ethicsPolicy": "https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473", "logo": { "@type": "ImageObject", "url": "https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F540\u002F1*cw32fIqCbRWzwJaoQw6BUg.png", "width": 540, "height": 123 } } }, "8ccfed20cbb2": { "name": "Zora", "data": { "@type": "NewsMediaOrganization", "ethicsPolicy": "https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473", "logo": { "@type": "ImageObject", "url": "https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F540\u002F1*tZUQqRcCCZDXjjiZ4bDvgQ.png", "width": 540, "height": 106 } } } }, "embeddedPostIds": { "coronavirus": "cd3010f9d81f" }, "sharedCdcMessaging": { "COVID_APPLICABLE_TAG_SLUGS": [], "COVID_APPLICABLE_TOPIC_NAMES": [], "COVID_APPLICABLE_TOPIC_NAMES_FOR_TOPIC_PAGE": [], "COVID_MESSAGES": { "tierA": { "text": "For more information on the novel coronavirus and Covid-19, visit cdc.gov.", "markups": [{ "start": 66, "end": 73, "href": "https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV" }] }, "tierB": { "text": "Anyone can publish on Medium per our Policies, but we don’t fact-check every story. For more info about the coronavirus, see cdc.gov.", "markups": [{ "start": 37, "end": 45, "href": "https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Fcategories\u002F201931128-Policies-Safety" }, { "start": 125, "end": 132, "href": "https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV" }] }, "paywall": { "text": "This article has been made free for everyone, thanks to Medium Members. For more information on the novel coronavirus and Covid-19, visit cdc.gov.", "markups": [{ "start": 56, "end": 70, "href": "https:\u002F\u002Fmedium.com\u002Fmembership" }, { "start": 138, "end": 145, "href": "https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV" }] }, "unbound": { "text": "This article is free for everyone, thanks to Medium Members. For more information on the novel coronavirus and Covid-19, visit cdc.gov.", "markups": [{ "start": 45, "end": 59, "href": "https:\u002F\u002Fmedium.com\u002Fmembership" }, { "start": 127, "end": 134, "href": "https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV" }] } }, "COVID_BANNER_POST_ID_OVERRIDE_WHITELIST": ["3b31a67bff4a"] }, "sharedVoteMessaging": { "TAGS": ["politics", "election-2020", "government", "us-politics", "election", "2020-presidential-race", "trump", "donald-trump", "democrats", "republicans", "congress", "republican-party", "democratic-party", "biden", "joe-biden", "maga"], "TOPICS": ["politics", "election"], "MESSAGE": { "text": "Find out more about the U.S. election results here.", "markups": [{ "start": 46, "end": 50, "href": "https:\u002F\u002Fcookpolitical.com\u002F2020-national-popular-vote-tracker" }] }, "EXCLUDE_POSTS": ["397ef29e3ca5"] }, "embedPostRules": [], "recircOptions": { "v1": { "limit": 3 }, "v2": { "limit": 8 } }, "braintreeClientKey": "production_zjkj96jm_m56f8fqpf7ngnrd4", "braintree": { "enabled": true, "merchantId": "m56f8fqpf7ngnrd4", "merchantAccountId": { "usd": "AMediumCorporation_instant", "eur": "amediumcorporation_EUR", "cad": "amediumcorporation_CAD" }, "publicKey": "ds2nn34bg2z7j5gd", "braintreeEnvironment": "production", "dashboardUrl": "https:\u002F\u002Fwww.braintreegateway.com\u002Fmerchants", "gracePeriodDurationInDays": 14, "mediumMembershipPlanId": { "monthly": "ce105f8c57a3", "monthlyV2": "e8a5e126-792b-4ee6-8fba-d574c1b02fc5", "monthlyWithTrial": "d5ee3dbe3db8", "monthlyPremium": "fa741a9b47a2", "yearly": "a40ad4a43185", "yearlyV2": "3815d7d6-b8ca-4224-9b8c-182f9047866e", "yearlyStaff": "d74fb811198a", "yearlyWithTrial": "b3bc7350e5c7", "yearlyPremium": "e21bd2c12166", "monthlyOneYearFree": "e6c0637a-2bad-4171-ab4f-3c268633d83c", "monthly25PercentOffFirstYear": "235ecc62-0cdb-49ae-9378-726cd21c504b", "monthly20PercentOffFirstYear": "ba518864-9c13-4a99-91ca-411bf0cac756", "monthly15PercentOffFirstYear": "594c029b-9f89-43d5-88f8-8173af4e070e", "monthly10PercentOffFirstYear": "c6c7bc9a-40f2-4b51-8126-e28511d5bdb0", "monthlyForStudents": "629ebe51-da7d-41fd-8293-34cd2f2030a8", "yearlyOneYearFree": "78ba7be9-0d9f-4ece-aa3e-b54b826f2bf1", "yearly25PercentOffFirstYear": "2dbb010d-bb8f-4eeb-ad5c-a08509f42d34", "yearly20PercentOffFirstYear": "47565488-435b-47f8-bf93-40d5fbe0ebc8", "yearly15PercentOffFirstYear": "8259809b-0881-47d9-acf7-6c001c7f720f", "yearly10PercentOffFirstYear": "9dd694fb-96e1-472c-8d9e-3c868d5c1506", "yearlyForStudents": "e29345ef-ab1c-4234-95c5-70e50fe6bc23", "monthlyCad": "p52orjkaceei", "yearlyCad": "h4q9g2up9ktt" }, "braintreeDiscountId": { "oneMonthFree": "MONTHS_FREE_01", "threeMonthsFree": "MONTHS_FREE_03", "sixMonthsFree": "MONTHS_FREE_06", "fiftyPercentOffOneYear": "FIFTY_PERCENT_OFF_ONE_YEAR" }, "3DSecureVersion": "2", "defaultCurrency": "usd", "providerPlanIdCurrency": { "4ycw": "usd", "rz3b": "usd", "3kqm": "usd", "jzw6": "usd", "c2q2": "usd", "nnsw": "usd", "q8qw": "usd", "d9y6": "usd", "fx7w": "cad", "nwf2": "cad" } }, "paypalClientId": "AXj1G4fotC2GE8KzWX9mSxCH1wmPE3nJglf4Z2ig_amnhvlMVX87otaq58niAg9iuLktVNF_1WCMnN7v", "paypal": { "host": "https:\u002F\u002Fapi.paypal.com:443", "clientMode": "production", "serverMode": "live", "webhookId": "4G466076A0294510S", "monthlyPlan": { "planId": "P-9WR0658853113943TMU5FDQA", "name": "Medium Membership (Monthly) with setup fee", "description": "Unlimited access to the best and brightest stories on Medium. Membership billed monthly." }, "yearlyPlan": { "planId": "P-7N8963881P8875835MU5JOPQ", "name": "Medium Membership (Annual) with setup fee", "description": "Unlimited access to the best and brightest stories on Medium. Membership billed annually." }, "oneYearGift": { "name": "Medium Membership (1 Year, Digital Gift Code)", "description": "Unlimited access to the best and brightest stories on Medium. Gift codes can be redeemed at medium.com\u002Fredeem.", "price": "50.00", "currency": "USD", "sku": "membership-gift-1-yr" }, "oldMonthlyPlan": { "planId": "P-96U02458LM656772MJZUVH2Y", "name": "Medium Membership (Monthly)", "description": "Unlimited access to the best and brightest stories on Medium. Membership billed monthly." }, "oldYearlyPlan": { "planId": "P-59P80963JF186412JJZU3SMI", "name": "Medium Membership (Annual)", "description": "Unlimited access to the best and brightest stories on Medium. Membership billed annually." }, "monthlyPlanWithTrial": { "planId": "P-66C21969LR178604GJPVKUKY", "name": "Medium Membership (Monthly) with setup fee", "description": "Unlimited access to the best and brightest stories on Medium. Membership billed monthly." }, "yearlyPlanWithTrial": { "planId": "P-6XW32684EX226940VKCT2MFA", "name": "Medium Membership (Annual) with setup fee", "description": "Unlimited access to the best and brightest stories on Medium. Membership billed annually." }, "oldMonthlyPlanNoSetupFee": { "planId": "P-4N046520HR188054PCJC7LJI", "name": "Medium Membership (Monthly)", "description": "Unlimited access to the best and brightest stories on Medium. Membership billed monthly." }, "oldYearlyPlanNoSetupFee": { "planId": "P-7A4913502Y5181304CJEJMXQ", "name": "Medium Membership (Annual)", "description": "Unlimited access to the best and brightest stories on Medium. Membership billed annually." }, "sdkUrl": "https:\u002F\u002Fwww.paypal.com\u002Fsdk\u002Fjs" }, "stripePublishableKey": "pk_live_7FReX44VnNIInZwrIIx6ghjl", "log": { "json": true, "level": "info" }, "imageUploadMaxSizeMb": 25, "staffPicks": { "title": "Staff Picks", "catalogId": "c7bc6e1ee00f" } }, "session": { "xsrf": "" } }</script>
    <script>window.__APOLLO_STATE__ = { "ROOT_QUERY": { "__typename": "Query", "isLoggedIn": false, "collectionByDomainOrSlug({\"domainOrSlug\":\"tachyondevel.medium.com\"})": null, "viewer": null, "postResult({\"id\":\"62c50e58cbd0\"})": { "__ref": "Post:62c50e58cbd0" } }, "LinkedAccounts:35c856cf9e4d": { "__typename": "LinkedAccounts", "mastodon": null, "id": "35c856cf9e4d" }, "UserViewerEdge:userId:35c856cf9e4d-viewerId:lo_fe2a7be3d7e5": { "__typename": "UserViewerEdge", "id": "userId:35c856cf9e4d-viewerId:lo_fe2a7be3d7e5", "isFollowing": false, "isUser": false, "isMuting": false }, "NewsletterV3:52f7aa4c8544": { "__typename": "NewsletterV3", "id": "52f7aa4c8544", "type": "NEWSLETTER_TYPE_AUTHOR", "slug": "35c856cf9e4d", "name": "35c856cf9e4d", "collection": null, "user": { "__ref": "User:35c856cf9e4d" } }, "User:35c856cf9e4d": { "__typename": "User", "id": "35c856cf9e4d", "name": "Tachyon", "username": "tachyondevel", "newsletterV3": { "__ref": "NewsletterV3:52f7aa4c8544" }, "linkedAccounts": { "__ref": "LinkedAccounts:35c856cf9e4d" }, "isSuspended": false, "imageId": "0*8tbyh9DEBZIccKB1.jpg", "mediumMemberAt": 0, "verifications": { "__typename": "VerifiedInfo", "isBookAuthor": false }, "socialStats": { "__typename": "SocialStats", "followerCount": 619 }, "customDomainState": { "__typename": "CustomDomainState", "live": { "__typename": "CustomDomain", "domain": "tachyondevel.medium.com" } }, "hasSubdomain": true, "bio": "eric.y.corsican@gmail.com https:\u002F\u002Ftwitter.com\u002FTachyonDevel", "isPartnerProgramEnrolled": false, "viewerEdge": { "__ref": "UserViewerEdge:userId:35c856cf9e4d-viewerId:lo_fe2a7be3d7e5" }, "viewerIsUser": false, "postSubscribeMembershipUpsellShownAt": 0, "allowNotes": true, "membership": null, "twitterScreenName": "" }, "Paragraph:2f7bedd0404b_0": { "__typename": "Paragraph", "id": "2f7bedd0404b_0", "name": "294d", "type": "H3", "href": null, "layout": null, "metadata": null, "text": "漫谈各种黑科技式 DNS 技术在代理环境中的应用", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_1": { "__typename": "Paragraph", "id": "2f7bedd0404b_1", "name": "0e36", "type": "P", "href": null, "layout": null, "metadata": null, "text": "这篇文章目的是以非技术性例举方式，谈一谈各种 DNS 技术在代理环境中如何工作，主要集中在对 V2Ray 的使用上，因为最近 V2Ray 发布了一个 DNS 相关的功能：https:\u002F\u002Fsteemit.com\u002Fcn\u002F@v2ray\u002Fdns，其用法很多，可以解决很多问题，但如果不理解其工作方式，就很难做出合理的配置。", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 85, "end": 118, "href": "https:\u002F\u002Fsteemit.com\u002Fcn\u002F@v2ray\u002Fdns", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_2": { "__typename": "Paragraph", "id": "2f7bedd0404b_2", "name": "8f17", "type": "P", "href": null, "layout": null, "metadata": null, "text": "本文所讨论的也不单纯是 DNS，还涉及 V2Ray 的部分工作原理，因为我们的讨论是依赖于使用 V2Ray 来对 DNS 流量做各种处理的。所以也希望读者看懂了文章中的例子后，可以举一反三，从而更好理解 V2Ray 的整体工作原理。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_3": { "__typename": "Paragraph", "id": "2f7bedd0404b_3", "name": "2d91", "type": "P", "href": null, "layout": null, "metadata": null, "text": "本文举例范围预计会包括桌面系统（Windows, macOS）、移动端（iOS, Android）、普通浏览器代理（系统代理）、全局代理（tun2socks），或许还会聊聊路由器上的透明代理。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_4": { "__typename": "Paragraph", "id": "2f7bedd0404b_4", "name": "4691", "type": "H4", "href": null, "layout": null, "metadata": null, "text": "桌面端环境", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_5": { "__typename": "Paragraph", "id": "2f7bedd0404b_5", "name": "e5ea", "type": "P", "href": null, "layout": null, "metadata": null, "text": "先从非常简单的例子说起，了解下大概的过程。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_6": { "__typename": "Paragraph", "id": "2f7bedd0404b_6", "name": "d7f6", "type": "P", "href": null, "layout": null, "metadata": null, "text": "首先说一下不开任何代理软件，不做任何代理设置时，DNS 的工作方式：", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_7": { "__typename": "Paragraph", "id": "2f7bedd0404b_7", "name": "d938", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "S1", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_8": { "__typename": "Paragraph", "id": "2f7bedd0404b_8", "name": "90d8", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "1. 浏览器地址栏输入 www.bilibili.com，敲下 Enter\n2. 浏览器发起针对 \"www.bilibili.com\" 这个域名的 DNS 请求\n3. 假设系统 DNS 设置了 114.114.114.114\n4. 承载 DNS 请求的 UDP 流量就会从你本机直接发到 114.114.114.114\n5. 114.114.114.114 接收了这些 UDP 流量\n6. 114.114.114.114 从这些 UDP 流量中解析出请求的域名 \"www.bilibili.com\"\n7. 114.114.114.114 尝试从自己缓存里找结果，有的话返回结果\n8. 114.114.114.114 如果没缓存，会向其它 DNS 服务器要结果，拿到后返回\n9. 浏览器收到 114.114.114.114 返回的结果\n10. 浏览器开始真正地对 Bilibili 的服务器发起 HTTP\u002FHTTPS 连接", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_9": { "__typename": "Paragraph", "id": "2f7bedd0404b_9", "name": "0f5f", "type": "P", "href": null, "layout": null, "metadata": null, "text": "下面假设在系统或浏览器中设置了 SOCKS 5（注意是 SOCKS 5，版本 5）代理服务器地址为：127.0.0.1:1086。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_10": { "__typename": "Paragraph", "id": "2f7bedd0404b_10", "name": "d082", "type": "BQ", "href": null, "layout": null, "metadata": null, "text": "Windows 系统的用户需要注意，系统代理里直接设置 SOCKS 代理有可能用的不是 SOCKS 5，而是 SOCKS 4，SOCKS 4 是不支持远程 DNS 解析的，想要设置 SOCKS 5 的话要用 PAC 文件，PAC 文件内容可以这么写：", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_11": { "__typename": "Paragraph", "id": "2f7bedd0404b_11", "name": "d884", "type": "BQ", "href": null, "layout": null, "metadata": null, "text": "function FindProxyForURL(url, host) {\n return \"SOCKS5 127.0.0.1:1086; SOCKS 127.0.0.1:1086\";\n}", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_12": { "__typename": "Paragraph", "id": "2f7bedd0404b_12", "name": "3ca4", "type": "P", "href": null, "layout": null, "metadata": null, "text": "然后在本地开启一个 V2Ray，配置大概如下：", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_13": { "__typename": "Paragraph", "id": "2f7bedd0404b_13", "name": "4de5", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "C1", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_14": { "__typename": "Paragraph", "id": "2f7bedd0404b_14", "name": "4f45", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "{\n    \"dns\": {\n        \"servers\": [\n            \"223.5.5.5\",\n            \"8.8.8.8\"\n        ]\n    },\n    \"outbounds\": [\n        {\n            \"protocol\": \"freedom\",\n            \"settings\": {}\n        }\n    ],\n    \"inbounds\": [\n        {\n            \"domainOverride\": [\n                \"http\",\n                \"tls\"\n            ],\n            \"port\": 1086,\n            \"listen\": \"127.0.0.1\",\n            \"protocol\": \"socks\",\n            \"settings\": {\n                \"auth\": \"noauth\",\n                \"udp\": true,\n                \"ip\": \"127.0.0.1\"\n            }\n        }\n    ]\n}", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_15": { "__typename": "Paragraph", "id": "2f7bedd0404b_15", "name": "cdc4", "type": "P", "href": null, "layout": null, "metadata": null, "text": "在这个基础上对比上面（S1）不设置代理的情况：", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_16": { "__typename": "Paragraph", "id": "2f7bedd0404b_16", "name": "7d11", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "S2", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_17": { "__typename": "Paragraph", "id": "2f7bedd0404b_17", "name": "14fa", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "1. 浏览器地址栏输入 www.bilibili.com，敲下 Enter", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_18": { "__typename": "Paragraph", "id": "2f7bedd0404b_18", "name": "27f8", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "2. 浏览器发现设置了 SOCKS 代理，因为 SOCKS 代理可以把域名传给服务器处理\n3. 所以浏览器不需要做 DNS 请求，直接把域名放进 SOCKS 请求中发给代理服务器\n4. 我们的代理服务器(V2Ray) 127.0.0.1:1086 收到了这个 SOCKS 代理请求\n5. 代理服务器(V2Ray) 从 SOCKS 请求中解析出 \"www.bilibili.com\" 这个域名\n6. 代理服务器(V2Ray) 要代理这个请求，但因为只有一个 Freedom outbound\n7. 于是就用 Freedom outbound 向 www.bilibili.com 发起 TCP 连接\n8. Freedom outbound 要向一个域名发 TCP 连接，得先解析域名", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_19": { "__typename": "Paragraph", "id": "2f7bedd0404b_19", "name": "f5fe", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "9. 承载 DNS 请求的 UDP 流量就会从你本机直接发到 114.114.114.114\n10. 114.114.114.114 接收了这些 UDP 流量\n11. 114.114.114.114 从这些 UDP 流量中解析出请求的域名 \"www.bilibili.com\"\n12. 114.114.114.114 尝试从自己缓存里找结果，有的话返回结果\n13. 114.114.114.114 如果没缓存，会向其它 DNS 服务器要结果，拿到后返回", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_20": { "__typename": "Paragraph", "id": "2f7bedd0404b_20", "name": "26a8", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "14. 程序(V2Ray)收到 114.114.114.114 返回的结果\n15. 程序(V2Ray)开始真正地对 Bilibili 的服务器发起 TCP 连接\n16. 连接一旦建立，代理服务器(V2Ray) 就可以真正地代理客户端(浏览器)的请求流量", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_21": { "__typename": "Paragraph", "id": "2f7bedd0404b_21", "name": "3fc2", "type": "P", "href": null, "layout": null, "metadata": null, "text": "上面（S2）设置不涉及任何远程代理服务器，由本地的 V2Ray 充当代了理服务器，代理的 www.bilibili.com 请求是采用直连方式，也一样有向 114.114.114.114 发出了 DNS 请求。但可以看到在后一个例子发起 DNS 请求的是 V2Ray（而不是浏览器），而从 Bilibili 的服务器看来，跟它连接是 V2Ray（而不是浏览器）。", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 45, "end": 61, "href": "http:\u002F\u002Fwww.bilibili.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_22": { "__typename": "Paragraph", "id": "2f7bedd0404b_22", "name": "8b47", "type": "P", "href": null, "layout": null, "metadata": null, "text": "加了这么一层代理，看起来什么都没发生，只是换了角色，其实不然，角色这么一换，可做的事情就相当多了。拿 DNS 来说，原来是浏览器发起的 DNS 请求，我们没办法控制浏览器怎么去发这个 DNS 请求（你不可能去改浏览器的源代码自己编译一个来用吧？），但换成由 V2Ray 来发这个 DNS 请求后，我们就可以做很多事情。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_23": { "__typename": "Paragraph", "id": "2f7bedd0404b_23", "name": "1dec", "type": "P", "href": null, "layout": null, "metadata": null, "text": "比如稍微改一下上面（C1）的配置，在 Freedom oubound 中加入 \"domainStrategy\": \"UseIP\" ：", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "CODE", "start": 39, "end": 64, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_24": { "__typename": "Paragraph", "id": "2f7bedd0404b_24", "name": "35d6", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "C2", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_25": { "__typename": "Paragraph", "id": "2f7bedd0404b_25", "name": "412a", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "{\n    \"dns\": {\n        \"servers\": [\n            \"223.5.5.5\",\n            \"8.8.8.8\"\n        ]\n    },\n    \"outbounds\": [\n        {\n            \"protocol\": \"freedom\",\n            \"settings\": {\n                \"domainStrategy\": \"UseIP\"\n            }\n        }\n    ],\n    \"inbounds\": [\n        {\n            \"domainOverride\": [\n                \"http\",\n                \"tls\"\n            ],\n            \"port\": 1086,\n            \"listen\": \"127.0.0.1\",\n            \"protocol\": \"socks\",\n            \"settings\": {\n                \"auth\": \"noauth\",\n                \"udp\": true,\n                \"ip\": \"127.0.0.1\"\n            }\n        }\n    ]\n}", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_26": { "__typename": "Paragraph", "id": "2f7bedd0404b_26", "name": "e611", "type": "P", "href": null, "layout": null, "metadata": null, "text": "V2Ray 文档 中对 domainStrategy 的说明是这样的：", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "CODE", "start": 12, "end": 26, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }, { "__typename": "Markup", "type": "A", "start": 0, "end": 8, "href": "https:\u002F\u002Fv2ray.com\u002Fchapter_02\u002Fprotocols\u002Ffreedom.html", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_27": { "__typename": "Paragraph", "id": "2f7bedd0404b_27", "name": "0f96", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "在目标地址为域名时，Freedom 可以直接向此域名发出连接（\"AsIs\"），或者将域名解析为 IP 之后再建立连接（\"UseIP\"、\"UseIPv4\"、\"UseIPv6\"）。解析 IP 的步骤会使用 V2Ray 内建的 DNS。默认值为\"AsIs\"。", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "CODE", "start": 31, "end": 37, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }, { "__typename": "Markup", "type": "CODE", "start": 59, "end": 66, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }, { "__typename": "Markup", "type": "CODE", "start": 67, "end": 76, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }, { "__typename": "Markup", "type": "CODE", "start": 77, "end": 86, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }, { "__typename": "Markup", "type": "CODE", "start": 119, "end": 125, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }, { "__typename": "Markup", "type": "A", "start": 107, "end": 114, "href": "https:\u002F\u002Fv2ray.com\u002Fchapter_02\u002F04_dns.html", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_28": { "__typename": "Paragraph", "id": "2f7bedd0404b_28", "name": "080a", "type": "P", "href": null, "layout": null, "metadata": null, "text": "原本默认为 AsIs 的话，直接向域名发出连接就是说会用系统 DNS 来做 DNS 解析，但如果我们设置为 UseIP ，S2 中的步骤就会变成这样：", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "CODE", "start": 6, "end": 10, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }, { "__typename": "Markup", "type": "CODE", "start": 54, "end": 59, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_29": { "__typename": "Paragraph", "id": "2f7bedd0404b_29", "name": "8efb", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "S3", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_30": { "__typename": "Paragraph", "id": "2f7bedd0404b_30", "name": "a1c7", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "...", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_31": { "__typename": "Paragraph", "id": "2f7bedd0404b_31", "name": "0eaa", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "8. Freedom outbound 要向一个域名发 TCP 连接，得先解析域名", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_32": { "__typename": "Paragraph", "id": "2f7bedd0404b_32", "name": "50c7", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "* Freedom outbound 用了 UseIP 策略，所以使用内置 DNS 来解析域名\n* 内置 DNS 按顺序第一个是 223.5.5.5\n* 内置 DNS 请求会按路由规则走，因为没有任何规则，且只有一个 Freedom outbound\n* 内置 DNS 发到 223.5.5.5 的请求走 Freedom outbound", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_33": { "__typename": "Paragraph", "id": "2f7bedd0404b_33", "name": "1e15", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "9. 承载 DNS 请求的 UDP 流量就会从你本机直接发到 223.5.5.5\n10. 223.5.5.5 接收了这些 UDP 流量\n11. 223.5.5.5 从这些 UDP 流量中解析出请求的域名 \"www.bilibili.com\"\n12. 223.5.5.5 尝试从自己缓存里找结果，有的话返回结果\n13. 223.5.5.5 如果没缓存，会向其它 DNS 服务器要结果，拿到后返回", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_34": { "__typename": "Paragraph", "id": "2f7bedd0404b_34", "name": "2351", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "14. 程序(V2Ray)收到 223.5.5.5 返回的结果", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_35": { "__typename": "Paragraph", "id": "2f7bedd0404b_35", "name": "4880", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "...", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_36": { "__typename": "Paragraph", "id": "2f7bedd0404b_36", "name": "e032", "type": "P", "href": null, "layout": null, "metadata": null, "text": "所以这里我们改了一个 domainStrategy 参数，就相当于覆盖了系统的 DNS，本来应该走 114.114.114.114（系统 DNS）的 DNS 请求现在走 223.5.5.5（V2Ray 内置 DNS）了。", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "CODE", "start": 11, "end": 25, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_37": { "__typename": "Paragraph", "id": "2f7bedd0404b_37", "name": "b4d5", "type": "P", "href": null, "layout": null, "metadata": null, "text": "上面例子都很简单，并没什么实际用处，但了解这些可以方便理解后续各种花式玩法。另外虽说简单，但也已经包括了几个需要关注的点。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_38": { "__typename": "Paragraph", "id": "2f7bedd0404b_38", "name": "deb8", "type": "P", "href": null, "layout": null, "metadata": null, "text": "比如在 S2 中是这么写的：", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_39": { "__typename": "Paragraph", "id": "2f7bedd0404b_39", "name": "b2c0", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "浏览器发现设置了 SOCKS 代理", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_40": { "__typename": "Paragraph", "id": "2f7bedd0404b_40", "name": "d82c", "type": "P", "href": null, "layout": null, "metadata": null, "text": "这里就得注意了，我们设置的 SOCKS 代理需要浏览器（应用程序）发现了，浏览器（应用程序）才会去使用它。如果应用程序没发现我们设置的系统代理呢？或者浏览器（应用程序）无视了我们设置的系统代理，按正常的流程去做请求呢？", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_41": { "__typename": "Paragraph", "id": "2f7bedd0404b_41", "name": "56b2", "type": "P", "href": null, "layout": null, "metadata": null, "text": "这里的关键点是，一般桌面操作系统（Windows, macOS）中的系统代理设置只是一个 可选 的连接方式。", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "CODE", "start": 45, "end": 47, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_42": { "__typename": "Paragraph", "id": "2f7bedd0404b_42", "name": "1323", "type": "P", "href": null, "layout": null, "metadata": null, "text": "如果设置了系统代理，一般的浏览器程序（Chrome, Firefox, Safari）默认都会发现并遵从这个设置。其它的一些应用程序就不一定会遵从这个设置了，比如 QQ 这样的程序，它默认应该是不会遵从这个设置的（它有自己的设置项），再比如打开命令行，输入以下命令：", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_43": { "__typename": "Paragraph", "id": "2f7bedd0404b_43", "name": "ea7f", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "curl https:\u002F\u002Fwww.bilibili.com", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_44": { "__typename": "Paragraph", "id": "2f7bedd0404b_44", "name": "648d", "type": "P", "href": null, "layout": null, "metadata": null, "text": "curl 做的这个请求时是不会使用系统代理的。如果想让 curl 使用代理，可以这么设置一个环境变量， curl 会读取这个变量，从而得知代理的存在并使用它：", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "CODE", "start": 0, "end": 4, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }, { "__typename": "Markup", "type": "CODE", "start": 28, "end": 32, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }, { "__typename": "Markup", "type": "CODE", "start": 52, "end": 56, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_45": { "__typename": "Paragraph", "id": "2f7bedd0404b_45", "name": "dce4", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "http_proxy=127.0.0.1:1086 curl https:\u002F\u002Fwww.bilibili.com", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_46": { "__typename": "Paragraph", "id": "2f7bedd0404b_46", "name": "aac9", "type": "P", "href": null, "layout": null, "metadata": null, "text": "再比如上面场景中多次提到 DNS 请求相关内容时，用了 DNS 请求 ，承载 DNS 请求的 UDP 流量 等多种说法，它们其实都是指同一个东西，只是在不同的上下文中用了不同的说法。", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "CODE", "start": 28, "end": 34, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }, { "__typename": "Markup", "type": "CODE", "start": 36, "end": 53, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_47": { "__typename": "Paragraph", "id": "2f7bedd0404b_47", "name": "86d9", "type": "P", "href": null, "layout": null, "metadata": null, "text": "简单来说，从我们机器发出去的一个 DNS 请求会是这个样子的：", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_48": { "__typename": "Paragraph", "id": "2f7bedd0404b_48", "name": "3bc8", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "F1", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_49": { "__typename": "Paragraph", "id": "2f7bedd0404b_49", "name": "84ec", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "+------+-------+--------------------------+\n| IP 头| UDP 头 | DNS 头 及 其 请 求 内 容  |\n+------+-------+--------------------------+", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_50": { "__typename": "Paragraph", "id": "2f7bedd0404b_50", "name": "c2c7", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "重点：一般这种 DNS 请求都是纯文本（我们也只讨论这种 DNS），它们所流经的各种设备，各种程序都可以看到，可以修改里面的内容，发出的请求可以修改，返回的结果也可以修改，甚至修改过后毫无痕迹，就是说，对于发出的请求，DNS 服务器没办法知道它是否在中间链路被修改过，对于返回的结果，应用程序也没办法知道它是否在中间链路被修改过。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_51": { "__typename": "Paragraph", "id": "2f7bedd0404b_51", "name": "7d67", "type": "P", "href": null, "layout": null, "metadata": null, "text": "这是一个 IP 包，从某种角度来看可以说它是一个承载了 UDP 流量的 IP 包，其中 IP 头中包含了源地址（本机 IP）和目的地址（114.114.114.114），UDP 头中包含了源端口（随机）和目的端口（53），DNS 头及其请求内容中包含了请求要解析的域名（www.bilibili.com），要解析的 DNS 类型（A\u002FAAAA）。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_52": { "__typename": "Paragraph", "id": "2f7bedd0404b_52", "name": "23bb", "type": "P", "href": null, "layout": null, "metadata": null, "text": "所谓在不同上下文用不同的说法，一般就是指在不同的时候我们关注不同信息，当表达流量从本机发送到 114.114.114.114，我们关注的是 IP 地址和端口，这时我们说承载 DNS 请求的 UDP 流量（因为 IP 地址和端口信息在 IP 头 和 UDP 头中），当我们只关注所要解析的域名 “www.bilibili.com” 时，会说 DNS 请求（因为这个信息在 DNS 头及其请求内容中）。更多的时候是混用，在这方面不会太严谨。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_53": { "__typename": "Paragraph", "id": "2f7bedd0404b_53", "name": "5f4f", "type": "P", "href": null, "layout": null, "metadata": null, "text": "知道哪个信息包含在哪一部分的数据中，会对我们理解各种 DNS 技术的工作方式有很大帮助。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_54": { "__typename": "Paragraph", "id": "2f7bedd0404b_54", "name": "b0a8", "type": "P", "href": null, "layout": null, "metadata": null, "text": "下面举一个实际使用中可能用上的例子，配置如下：", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_55": { "__typename": "Paragraph", "id": "2f7bedd0404b_55", "name": "f568", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "C3", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_56": { "__typename": "Paragraph", "id": "2f7bedd0404b_56", "name": "363e", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "{\n    \"dns\": {\n        \"servers\": [\n            \"8.8.8.8\",\n            \"localhost\"\n        ]\n    },\n    \"outbounds\": [\n        {\n            \"protocol\": \"vmess\",\n            \"settings\": {\n                \"vnext\": [\n                    {\n                        \"users\": [\n                            {\n                                \"id\": \"xxx-x-x-x-xx-x-x-x-x\"\n                            }\n                        ],\n                        \"address\": \"1.2.3.4\",\n                        \"port\": 10086\n                    }\n                ]\n            },\n            \"streamSettings\": {\n                \"network\": \"tcp\"\n            },\n            \"tag\": \"proxy\"\n        },\n        {\n            \"tag\": \"direct\",\n            \"protocol\": \"freedom\",\n            \"settings\": {}\n        }\n    ],\n    \"inbounds\": [\n        {\n            \"domainOverride\": [\n                \"http\",\n                \"tls\"\n            ],\n            \"port\": 1086,\n            \"listen\": \"127.0.0.1\",\n            \"protocol\": \"socks\",\n            \"settings\": {\n                \"auth\": \"noauth\",\n                \"udp\": true,\n                \"ip\": \"127.0.0.1\"\n            }\n        }\n    ],\n    \"routing\": {\n        \"domainStrategy\": \"IPIfNonMatch\",\n        \"rules\": [\n            {\n                \"type\": \"field\",\n                \"ip\": [\n                    \"8.8.8.8\"\n                ],\n                \"outboundTag\": \"proxy\"\n            },\n            {\n                \"type\": \"field\",\n                \"domain\": [\n                    \"geosite:cn\"\n                ],\n                \"outboundTag\": \"direct\"\n            }\n        ]\n    }\n}", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_57": { "__typename": "Paragraph", "id": "2f7bedd0404b_57", "name": "680e", "type": "P", "href": null, "layout": null, "metadata": null, "text": "简单描述下上面配置：内置 DNS 用 8.8.8.8 做首选服务器，localhost 作备用，路由中首先来一条规则让 8.8.8.8 的流量一定走 proxy，匹配了 geosite:cn 中的域名的请求走 direct，如果没匹配任何规则，则走主 outbound，也即 outbounds 中的第一个，也即 proxy。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_58": { "__typename": "Paragraph", "id": "2f7bedd0404b_58", "name": "5396", "type": "P", "href": null, "layout": null, "metadata": null, "text": "同样设置系统代理至 V2Ray 的 SOCKS inbound 127.0.0.1:1086，再来考虑浏览器做请求的过程，经过上面几个例子，可以看到很多步骤其实是一样的，所以后续例子中会简化一些：", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_59": { "__typename": "Paragraph", "id": "2f7bedd0404b_59", "name": "2832", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "S4", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_60": { "__typename": "Paragraph", "id": "2f7bedd0404b_60", "name": "b74e", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "1. 假设浏览器请求 https:\u002F\u002Fwww.bilibili.com\n2. 浏览器发 SOCKS 请求到 V2Ray\n3. 请求来到 V2Ray 的 inbound，再到路由过程\n4. 很明显 www.bilibili.com 这个域名包括在 geosite:cn 中，走 direct\n5. Freedom outbound (direct) 对 www.bilibili.com 发起 TCP 连接\n6. Freedom outbound 解析域名，因为这次没有用 UseIP，用的是系统 DNS\n7. 直接发 DNS 请求到 114.114.114.114\n8. 得到结果后可以跟 Bilibili 服务器建立连接，准备代理浏览器发过来的 HTTPS 流量", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 11, "end": 35, "href": "https:\u002F\u002Fwww.bilibili.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }, { "__typename": "Markup", "type": "A", "start": 98, "end": 114, "href": "http:\u002F\u002Fwww.bilibili.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }, { "__typename": "Markup", "type": "A", "start": 176, "end": 192, "href": "http:\u002F\u002Fwww.bilibili.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_61": { "__typename": "Paragraph", "id": "2f7bedd0404b_61", "name": "62aa", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "\nS5", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_62": { "__typename": "Paragraph", "id": "2f7bedd0404b_62", "name": "e67d", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "1. 再假设浏览器请求 https:\u002F\u002Fwww.google.com\n2. 浏览器发 SOCKS 请求到 V2Ray\n3. 请求来到 V2Ray 的 inbound，再到路由过程", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_63": { "__typename": "Paragraph", "id": "2f7bedd0404b_63", "name": "2508", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "4. www.google.com 不在 gesoite:cn，也没匹配任何规则，本来应该直接走主 outbound: proxy，但因为我们用了 IPIfNonMatch 策略，V2Ray 会去尝试使用内置的 DNS 把 www.google.com 的 IP 解析出来", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 112, "end": 126, "href": "http:\u002F\u002Fwww.google.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_64": { "__typename": "Paragraph", "id": "2f7bedd0404b_64", "name": "051d", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "5. V2Ray 使用内置 DNS 向 8.8.8.8 发起针对 www.google.com 的 DNS 请求，这个请求的流量将会是 UDP 流量", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 33, "end": 47, "href": "http:\u002F\u002Fwww.google.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_65": { "__typename": "Paragraph", "id": "2f7bedd0404b_65", "name": "4a43", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "6. 内置 DNS 发出的 DNS 请求会按路由规则走，因为 8.8.8.8 匹配了路由中的第一条规则，这个 DNS 请求的流量会走 proxy", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_66": { "__typename": "Paragraph", "id": "2f7bedd0404b_66", "name": "a1f3", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "7. proxy 向远端代理服务器发起 TCP 代理连接（因为 \"network\": \"tcp\"）", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_67": { "__typename": "Paragraph", "id": "2f7bedd0404b_67", "name": "2b1c", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "8. 建立起 TCP 连接后，proxy 向远端代理服务器发出 udp:8.8.8.8:53 这样的代理请求", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_68": { "__typename": "Paragraph", "id": "2f7bedd0404b_68", "name": "6cf1", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "9. 远端服务器表示接受这个代理请求后，proxy 用建立好的 TCP 连接向远端服务器发送承载了 DNS 请求的 UDP 流量（所以 V2Ray\u002FVMess 目前是 UDP over TCP）", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_69": { "__typename": "Paragraph", "id": "2f7bedd0404b_69", "name": "6341", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "10. 远端代理服务器接收到这些承载 DNS 请求的 UDP 流量后，发送给最终目标 udp:8.8.8.8:53", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_70": { "__typename": "Paragraph", "id": "2f7bedd0404b_70", "name": "f414", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "11. 8.8.8.8 返回给远端代理服务器 DNS 结果后，远端代理服务器原路返回至本地 V2Ray 的内置 DNS，至此，从步骤 5 ~ 11，整个 DNS 解析过程完成。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_71": { "__typename": "Paragraph", "id": "2f7bedd0404b_71", "name": "9896", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "12. 接上面步骤 4，V2Ray 得到 www.google.com 的 IP，再进行一次规则匹配，很明显路由规则中没有相关的 IP 规则，所以还是没匹配到任何规则，最终还是走了主 outbound: proxy", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 21, "end": 35, "href": "http:\u002F\u002Fwww.google.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_72": { "__typename": "Paragraph", "id": "2f7bedd0404b_72", "name": "52f6", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "13. proxy 向远端代理服务器发起 TCP 代理连接（因为 \"network\": \"tcp\"）", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_73": { "__typename": "Paragraph", "id": "2f7bedd0404b_73", "name": "a079", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "14. 连接建立后，因为 proxy 中所用的 VMess 协议可以像 SOCKS 那样把域名交给代理服务器处理，所以本地的 V2Ray 不需要自己解析 www.google.com，把域名放进 VMess 协议的参数中一并交给代理服务器来处理", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_74": { "__typename": "Paragraph", "id": "2f7bedd0404b_74", "name": "5df0", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "15. 远端的 V2Ray 代理服务器收到这个代理请求后，它可能自己做域名解析，也可能继续交给下一级代理处理，只要后续代理都支持类 SOCKS 的域名处理方式，这个 DNS 请求就可以一推再推，推给最后一个代理服务器来处理，这个超出本文范围不作讨论，反正这个域名不需要我们本地去解析", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_75": { "__typename": "Paragraph", "id": "2f7bedd0404b_75", "name": "108d", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "16. 远端代理服务器最后会发出针对 www.google.com 的 DNS 请求（至于究竟是如何发，发到哪个 DNS 服务器，我们不一定能知道，也不关心这个）", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 19, "end": 33, "href": "http:\u002F\u002Fwww.google.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_76": { "__typename": "Paragraph", "id": "2f7bedd0404b_76", "name": "5fdd", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "17. 远端代理服务器得到 DNS 结果后，可以真正地向 Google 的服务器建立 TCP 连接18. 远端的 V2Ray 做好准备后告诉本地 V2Ray 连接建立好了，可以传数据了", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_77": { "__typename": "Paragraph", "id": "2f7bedd0404b_77", "name": "ab9b", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "19. 本地 V2Ray 就告诉浏览器连接好了，可以传数据了，浏览器就可以把 HTTPS 流量顺着这个代理链发送至 Google 的服务器", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_78": { "__typename": "Paragraph", "id": "2f7bedd0404b_78", "name": "16a9", "type": "P", "href": null, "layout": null, "metadata": null, "text": "在上面 S5 中，步骤 5 ~ 11 做了次 DNS 请求，采用代理转发 DNS 请求流量的方式，而在步骤 14 中，又说可以不解析域名，交给远端服务器来解析，这两者其实并不冲突。一般来说，前者的处理方式就是实实在在的 UDP 流量代理而已，后者一般叫作远程 DNS 解析。用了 IPIfNonMatch ，对域名做一次 DNS 解析要经过 5 ~ 11 这么多步骤，看起来效率很慢，但如果代理服务器不慢的话，这个过程一般是很快的，最重要的是 V2Ray 内置 DNS 对 DNS 结果有一个缓存，所以并不需要每次都去做 DNS 请求。不管怎么说，毕竟还是做了额外的事情，而且有可能涉及到一个 UDP over TCP 的代理请求，的确会相对地慢点。", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "CODE", "start": 140, "end": 152, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_79": { "__typename": "Paragraph", "id": "2f7bedd0404b_79", "name": "16bd", "type": "P", "href": null, "layout": null, "metadata": null, "text": "另外要提到一点是，上面的配置中都在本地 SOCKS inbound 中用了：", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_80": { "__typename": "Paragraph", "id": "2f7bedd0404b_80", "name": "8737", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "\"domainOverride\": [\n   \"http\",\n   \"tls\"\n]", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_81": { "__typename": "Paragraph", "id": "2f7bedd0404b_81", "name": "91a8", "type": "BQ", "href": null, "layout": null, "metadata": null, "text": "在新的配置格式中这个流量嗅探的配置有了新的写法，后续会用这个写法：", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_82": { "__typename": "Paragraph", "id": "2f7bedd0404b_82", "name": "a13c", "type": "BQ", "href": null, "layout": null, "metadata": null, "text": "\"sniffing\": {\n \"enabled\": true,\n \"destOverride\": [\"http\", \"tls\"]\n}", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "CODE", "start": 0, "end": 66, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_83": { "__typename": "Paragraph", "id": "2f7bedd0404b_83", "name": "eb10", "type": "P", "href": null, "layout": null, "metadata": null, "text": "这个是对流量进行域名嗅探，如果配置了，V2Ray 就会做嗅探操作，但上面的例子没有把这个操作过程列出来，是因为目前我们的场景是桌面系统 + 浏览器，在这个环境中，这个嗅探功能不会起额外的作用，浏览器会把域名交给 V2Ray，不需要 V2Ray 去嗅探。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_84": { "__typename": "Paragraph", "id": "2f7bedd0404b_84", "name": "1664", "type": "P", "href": null, "layout": null, "metadata": null, "text": "如果看明白上面的上面几个举例，相信读者已经对 V2Ray 的工作方式有了大致的了解。一般来说，流量从 inbound 进入到 V2Ray，再进入到路由匹配过程，找到匹配到的 outbound，然后流量就给到这个 outbound 处理。V2Ray 虽然有多种 inbound，多种 outbound，以及很灵活的路由匹配规则，有时候会让人眼花缭乱，但这条流量流经的路线是默认的，没有特殊配置，流量都会按这个顺序在 V2Ray 内部传递。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_85": { "__typename": "Paragraph", "id": "2f7bedd0404b_85", "name": "89d4", "type": "H4", "href": null, "layout": null, "metadata": null, "text": "V2Ray 内置 DNS", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_86": { "__typename": "Paragraph", "id": "2f7bedd0404b_86", "name": "5399", "type": "P", "href": null, "layout": null, "metadata": null, "text": "而 V2Ray 的内置 DNS 其实也只是一个很简单的功能模块，它为 V2Ray 内部其它模块提供 DNS 功能，它接受一个域名作为输入，返回一个 IP 列表作为输出。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_87": { "__typename": "Paragraph", "id": "2f7bedd0404b_87", "name": "1c62", "type": "BQ", "href": null, "layout": null, "metadata": null, "text": "直接拿 V2Ray 里面代码出来看，内置 DNS 功能对其它模块提供的接口是这样的，表示输入参数是域名，输出是 IP 列表以及一个错误信息，如果正常返回，错误信息会是空的，IP 列表可以同时有 IPv4 和 IPv6 地址：", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_88": { "__typename": "Paragraph", "id": "2f7bedd0404b_88", "name": "a811", "type": "BQ", "href": null, "layout": null, "metadata": null, "text": "LookupIP(domain string) ([]net.IP, error)", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_89": { "__typename": "Paragraph", "id": "2f7bedd0404b_89", "name": "bb76", "type": "P", "href": null, "layout": null, "metadata": null, "text": "这就是从其它 V2Ray 模块的角度来看 V2Ray 内置 DNS 功能，至于内置 DNS 内部是否做域名分流，内部向哪个 DNS 服务器发出 DNS 请求，用何种方式发这个 DNS 请求，其它模块是管不着的，也完全不知情的。这样看内置 DNS 功能就很简单，其它模块，比如上面提到路由模块用内置 DNS 来解析域名后用 IP 再次进行匹配（或者后面会提到的 DNS outbound 模块），其实就是这样调用了内置 DNS：", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_90": { "__typename": "Paragraph", "id": "2f7bedd0404b_90", "name": "86d0", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "路由模块：我有一个域名，给你（内置 DNS 模块），帮我查查它的 IP 地址是什么", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_91": { "__typename": "Paragraph", "id": "2f7bedd0404b_91", "name": "228b", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "内置 DNS 模块按照自己的配置，做了各种处理，最终得到 IP 地址", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_92": { "__typename": "Paragraph", "id": "2f7bedd0404b_92", "name": "553b", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "内置 DNS 模块：这就是它（域名）的 IP，给你（路由模块）", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_93": { "__typename": "Paragraph", "id": "2f7bedd0404b_93", "name": "e643", "type": "P", "href": null, "layout": null, "metadata": null, "text": "从其它模块（外部）看 V2Ray 的内置 DNS 就这么简单的，那从内部看它呢？从内部看也是比较简单的，只要分清楚外部和内部各自负责的事情，各自所能得到的信息，就很好理解。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_94": { "__typename": "Paragraph", "id": "2f7bedd0404b_94", "name": "706a", "type": "P", "href": null, "layout": null, "metadata": null, "text": "比如内置 DNS 支持 hosts，这个功能是怎么做的呢？按上面的描述，外部只传入一个域名，其它的管不了，那内置 DNS 里面随便返回什么样的结果，外部都不能有任何疑问，比如路由模块要查 www.google.com 的 IP，传它给内置 DNS，但如果内置 DNS 根本就不发任何 DNS 请求，不做任何额外处理，直接就返回一个 127.0.0.1 给路由模块，这时路由模块也不得有任何异议，就算很显示 127.0.0.1 不可能是 www.google.com 真正的 IP 地址。那样在内置 DNS 中配置一个 域名 -\u003E IP 的列表，只要传进来的域名匹配了列表中的域名，就直接返回相应 IP，这就等效于 hosts 了。", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "CODE", "start": 259, "end": 267, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }, { "__typename": "Markup", "type": "A", "start": 94, "end": 108, "href": "http:\u002F\u002Fwww.bilibili.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }, { "__typename": "Markup", "type": "A", "start": 218, "end": 232, "href": "http:\u002F\u002Fwww.bilibili.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_95": { "__typename": "Paragraph", "id": "2f7bedd0404b_95", "name": "42a6", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "\"dns\": {\n  \"hosts\": {\n    \"www.google.com\": \"127.0.0.1\"\n  }\n}", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 27, "end": 41, "href": "http:\u002F\u002Fwww.bilibili.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_96": { "__typename": "Paragraph", "id": "2f7bedd0404b_96", "name": "70b5", "type": "P", "href": null, "layout": null, "metadata": null, "text": "再看内置 DNS 的 servers 一项，如果内置 DNS 这样配置：", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_97": { "__typename": "Paragraph", "id": "2f7bedd0404b_97", "name": "39b3", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "\"dns\": {\n  \"servers\": [\n    \"8.8.8.8\",\n    \"223.5.5.5\",\n    \"localhost\"\n  ]\n}", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_98": { "__typename": "Paragraph", "id": "2f7bedd0404b_98", "name": "1241", "type": "P", "href": null, "layout": null, "metadata": null, "text": "路由模块传入 www.bilibili.com 这个域名，想要它的 IP 地址，内置 DNS 会从上至下按顺序，向 servers 里每个 DNS 服务器发 DNS 请求，一个一个地来，直到有结果返回，然后再把结果返回给路由模块。", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 7, "end": 23, "href": "http:\u002F\u002Fwww.bilibili.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_99": { "__typename": "Paragraph", "id": "2f7bedd0404b_99", "name": "7a5a", "type": "P", "href": null, "layout": null, "metadata": null, "text": "从内置 DNS 向 servers 列表中的 DNS 服务器发出的 DNS 请求的流量，并不是从本机直接发到对应的服务器（localhost 除外），而是会通过 outbound 发出去，假如是 Freedom outbound，的确还是会从本机直接发到相应 DNS 服务器，但假如是一个 VMess outbound，DNS 请求的流量就会被代理到 VMess 代理服务器上，由代理服务器发到相应的 DNS 服务器。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_100": { "__typename": "Paragraph", "id": "2f7bedd0404b_100", "name": "d05c", "type": "P", "href": null, "layout": null, "metadata": null, "text": "内置 DNS 发出的请求的流量可能的流经线路：", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_101": { "__typename": "Paragraph", "id": "2f7bedd0404b_101", "name": "e010", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "内置 DNS -\u003E 通过路由功能选择了 Freedom outbound -\u003E 8.8.8.8\n内置 DNS -\u003E 通过路由功能选择了 VMess outbound -\u003E VMess 代理服务器 -\u003E 8.8.8.8", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_102": { "__typename": "Paragraph", "id": "2f7bedd0404b_102", "name": "4aa7", "type": "P", "href": null, "layout": null, "metadata": null, "text": "使用哪个 outbound，取决于路由配置。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_103": { "__typename": "Paragraph", "id": "2f7bedd0404b_103", "name": "030d", "type": "P", "href": null, "layout": null, "metadata": null, "text": "所以这里就很有趣了：", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_104": { "__typename": "Paragraph", "id": "2f7bedd0404b_104", "name": "55a4", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "1. 路由模块想要 www.bilibili.com 的域名，调用了内置 DNS 模块去查\n2. 内置 DNS 模块内部需要发个 DNS 请求去查，但它不太确定要把流量发到哪个 outbound\n3. 内置 DNS 模块于是调用路由模块，让路由来给它决定发到 udp:8.8.8.8:53 的流量究竟要交给哪个 outbound 比较合适", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 10, "end": 26, "href": "http:\u002F\u002Fwww.bilibili.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_105": { "__typename": "Paragraph", "id": "2f7bedd0404b_105", "name": "d566", "type": "P", "href": null, "layout": null, "metadata": null, "text": "可是呢，考虑一下我们的配置以及要查询的这个域名，8.8.8.8 在列表第一项，要先用它来查，但我们要查的域名是 www.bilibili.com，一般来说是不太合适向 8.8.8.8 查这个域名。所以无论路由模块判断走 Freedom outbound 还是 VMess outbound，都不合适。因为走 Freedom outbound 发到 8.8.8.8，恐怕返回结果是假的，走 VMess outbound，恐怕返回结果是国外 CDN 的。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_106": { "__typename": "Paragraph", "id": "2f7bedd0404b_106", "name": "ff62", "type": "BQ", "href": null, "layout": null, "metadata": null, "text": "这里必须再插一段话，要考虑返回结果如何如何，我们还得考虑这个返回结果是用来干什么的，如果是我们当前的例子，是用来给路由模块做 IP 规则匹配的，那返回结果是不是假的并不重要，重要的是它是否能匹配到 direct 规则；如果返回结果用作其它目的，比如后面会说到的 DNS outbound，就又是另一个故事了~", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_107": { "__typename": "Paragraph", "id": "2f7bedd0404b_107", "name": "fd52", "type": "P", "href": null, "layout": null, "metadata": null, "text": "回到主线，不管怎么，我们不想考虑太多东西，我们只想这个 DNS 请求能够合理地发出，很明显的一个选择就是让这个 www.bilibili.com 的 DNS 请求发到 223.5.5.5，且走 Freedom outbound。", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 56, "end": 72, "href": "http:\u002F\u002Fwww.bilibili.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_108": { "__typename": "Paragraph", "id": "2f7bedd0404b_108", "name": "448c", "type": "P", "href": null, "layout": null, "metadata": null, "text": "那把 223.5.5.5 放到列表第一项如何？这是治标不治本，想想假如又有另一个 DNS 请求要发到 www.google.com 的，这个请求先发到 223.5.5.5 就又不太合适了。", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 51, "end": 65, "href": "http:\u002F\u002Fwww.google.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_109": { "__typename": "Paragraph", "id": "2f7bedd0404b_109", "name": "a00f", "type": "P", "href": null, "layout": null, "metadata": null, "text": "V2Ray 当然已经考虑到这情况，有了所谓的 DNS 分流 功能：", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "CODE", "start": 23, "end": 29, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_110": { "__typename": "Paragraph", "id": "2f7bedd0404b_110", "name": "06f1", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "\"dns\": {\n  \"servers\": [\n    \"8.8.8.8\",\n    {\n      \"address\": \"223.5.5.5\",\n      \"port\": 53,\n      \"domains\": [\n        \"domain:www.bilibili.com\"\n      ]\n    },\n    \"localhost\"\n  ]\n}", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 128, "end": 144, "href": "http:\u002F\u002Fwww.bilibili.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_111": { "__typename": "Paragraph", "id": "2f7bedd0404b_111", "name": "5786", "type": "P", "href": null, "layout": null, "metadata": null, "text": "这样配置内置 DNS，虽然 8.8.8.8 在第一，但因为要查询的域名 www.bilibili.com 匹配了第二项中的域名规则，内置 DNS 就会优先向第二个 DNS 服务器发出 DNS 请求。", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 36, "end": 52, "href": "http:\u002F\u002Fwww.bilibili.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_112": { "__typename": "Paragraph", "id": "2f7bedd0404b_112", "name": "4091", "type": "P", "href": null, "layout": null, "metadata": null, "text": "这里有一个很容易忽略掉的过程，就是选择 outbound，我们用 DNS 分流功能选择了 DNS 服务器，还得在路由中配置合适的规则，来选合适的 outbound 向这个 DNS 服务器发出 DNS 请求流量。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_113": { "__typename": "Paragraph", "id": "2f7bedd0404b_113", "name": "2ab4", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "内置 DNS 查询 www.bilibili.com -\u003E 内置 DNS 通过分流功能选择了 223.5.5.5 -\u003E 通过路由功能选择了 Freedom outbound -\u003E 223.5.5.5", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_114": { "__typename": "Paragraph", "id": "2f7bedd0404b_114", "name": "a6a0", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "内置 DNS 查询 www.bilibili.com -\u003E 内置 DNS 通过分流功能选择了 223.5.5.5 -\u003E 通过路由功能选择了 VMess outbound -\u003E VMess 代理服务器 -\u003E 223.5.5.5", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_115": { "__typename": "Paragraph", "id": "2f7bedd0404b_115", "name": "aab5", "type": "P", "href": null, "layout": null, "metadata": null, "text": "就算 DNS 分流配置好了，如果路由规则配置不当，让 udp:223.5.5.5:53 的流量走了 proxy，就有可能发生上面第二个线路，返回的 IP 地址就有可能是 Bilibili 在国外 CDN 的 IP。（IP 结果是真的，只是…）", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_116": { "__typename": "Paragraph", "id": "2f7bedd0404b_116", "name": "df76", "type": "P", "href": null, "layout": null, "metadata": null, "text": "所以千万不能忘记，除了配置好 DNS 分流域名，还要为各个 DNS 服务器配置路由规则：", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_117": { "__typename": "Paragraph", "id": "2f7bedd0404b_117", "name": "1fcc", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "\"routing\": {\n    \"domainStrategy\": \"IPIfNonMatch\",\n    \"rules\": [\n        {\n            \"type\": \"field\",\n            \"ip\": [\n                \"8.8.8.8\"\n            ],\n            \"outboundTag\": \"proxy\"\n        },\n        {\n            \"type\": \"field\",\n            \"ip\": [\n                \"223.5.5.5\"\n            ],\n            \"outboundTag\": \"direct\"\n        }\n    ]\n}", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_118": { "__typename": "Paragraph", "id": "2f7bedd0404b_118", "name": "1df9", "type": "P", "href": null, "layout": null, "metadata": null, "text": "总结一下上面的，要正确配置 V2Ray 内置 DNS：", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_119": { "__typename": "Paragraph", "id": "2f7bedd0404b_119", "name": "6966", "type": "OLI", "href": null, "layout": null, "metadata": null, "text": "正确配置 servers 列表及域名分流（用域名信息来选 DNS 服务器）", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_120": { "__typename": "Paragraph", "id": "2f7bedd0404b_120", "name": "cb6c", "type": "OLI", "href": null, "layout": null, "metadata": null, "text": "正确为发出的 DNS 请求配置路由规则（用 DNS 服务器的地址信息以及流量的协议信息：IP，端口，tcp\u002Fudp）", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_121": { "__typename": "Paragraph", "id": "2f7bedd0404b_121", "name": "28c7", "type": "P", "href": null, "layout": null, "metadata": null, "text": "V2Ray 内置 DNS 还有一个叫 clientIp 的项是什么用的？我个人不太建议去依赖这个选项，但如果你想知道它的作用，是这样的，假如上面例子中真的在路由规则上配置错了，出现了这个线路的情况：", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "CODE", "start": 19, "end": 27, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_122": { "__typename": "Paragraph", "id": "2f7bedd0404b_122", "name": "9ea6", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "内置 DNS 查询 www.bilibili.com -\u003E 内置 DNS 通过分流功能选择了 223.5.5.5 -\u003E 通过路由功能选择了 VMess outbound -\u003E VMess 代理服务器 -\u003E 223.5.5.5", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_123": { "__typename": "Paragraph", "id": "2f7bedd0404b_123", "name": "1158", "type": "P", "href": null, "layout": null, "metadata": null, "text": "那 clientIP 是 DNS 请求中可以带上的一个参数，它用来提示 DNS 服务器（223.5.5.5）你所在的地理位置，223.5.5.5 就知道你在哪，就 有可能 会返回一个合适你所在的地理位置的 CDN 的 IP（也即 Bilibili 国内 CDN 的 IP）。", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "CODE", "start": 2, "end": 10, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }, { "__typename": "Markup", "type": "CODE", "start": 82, "end": 85, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_124": { "__typename": "Paragraph", "id": "2f7bedd0404b_124", "name": "15fb", "type": "P", "href": null, "layout": null, "metadata": null, "text": "关于内置 DNS，最后再说一说 localhost ，上面的描述不适用于 localhost，简单说，内置 DNS 在向 servers 列表中的 localhost 发 DNS 请求时，不会用任何 outbound 来发（甚至不用 Freedom outbound），而是直接从本机发出，就像任何其它程序做 DNS 请求那样，直接调用系统的 DNS API，用系统 DNS 中配置的 DNS 服务器。", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "CODE", "start": 16, "end": 25, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_125": { "__typename": "Paragraph", "id": "2f7bedd0404b_125", "name": "709d", "type": "H4", "href": null, "layout": null, "metadata": null, "text": "V2Ray DNS Outbound", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_126": { "__typename": "Paragraph", "id": "2f7bedd0404b_126", "name": "f68e", "type": "P", "href": null, "layout": null, "metadata": null, "text": "接下来会说一说 V2Ray 的 DNS outbound。因为我们上面的例子中所说的都是路由模块去调用内置 DNS，但路由模块仅仅是用它的结果来做规则匹配，而且是当配置了 IPIfNonMatch\u002FIPOnDemand ，而且没有匹配任何域名规则的情况下，才用得到它，当下各种域名列表盛行，它的应用范围实际上是很窄的。", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "CODE", "start": 86, "end": 109, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_127": { "__typename": "Paragraph", "id": "2f7bedd0404b_127", "name": "db02", "type": "P", "href": null, "layout": null, "metadata": null, "text": "DNS outbound 可以说是一个把内置 DNS 的功能真正地开放出来，让各种程序、各种模块可以更加方便地使用得上内置 DNS 的一个功能。为什么要把内置 DNS 开放出来呢？很明显啊，因为现在它支持 DNS 分流 ，相信大部分读者都知道已经存在很多专门做 DNS 分流的工具，这已经说明 DNS 分流是一个很有用的功能，而 V2Ray 已经支持 DNS 分流了，可是外部用不了就等于没有，所以就得开放出来。", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "CODE", "start": 103, "end": 109, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_128": { "__typename": "Paragraph", "id": "2f7bedd0404b_128", "name": "bad8", "type": "P", "href": null, "layout": null, "metadata": null, "text": "要说 DNS outbound 的配置，它目前就只有那么 3 （network, address, port）个配置项：", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_129": { "__typename": "Paragraph", "id": "2f7bedd0404b_129", "name": "7bfe", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "\"outbounds\": [\n    {\n        \"tag\": \"dns-out\",\n        \"protocol\": \"dns\",\n        \"settings\": {\n            \"network\": \"tcp\",\n            \"address\": \"1.1.1.1\",\n            \"port\": 53\n        }\n    }\n]", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_130": { "__typename": "Paragraph", "id": "2f7bedd0404b_130", "name": "598d", "type": "P", "href": null, "layout": null, "metadata": null, "text": "而这 3 个配置项其实都不是本文想要关注的点，下文只会稍微提一下。DNS outbound 最重要的功能是它的默认行为：对进来的 DNS 流量进行拦截、解析，以及对 A, AAAA 类型的 DNS 查询做重新转发。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_131": { "__typename": "Paragraph", "id": "2f7bedd0404b_131", "name": "a1c9", "type": "P", "href": null, "layout": null, "metadata": null, "text": "其中最难理解的，恐怕就是 “拦截”、“重新转发” 两个词的具体意思。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_132": { "__typename": "Paragraph", "id": "2f7bedd0404b_132", "name": "ea25", "type": "P", "href": null, "layout": null, "metadata": null, "text": "这里可以回看上面的 F1，是这么描述一般 DNS 请求的：", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_133": { "__typename": "Paragraph", "id": "2f7bedd0404b_133", "name": "2505", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "一般这种 DNS 请求都是纯文本（我们也只讨论这种 DNS），它们所流经的各种设备，各种程序都可以看到，可以修改里面的内容，发出的请求可以修改，返回的结果也可以修改，甚至修改过后毫无痕迹，就是说，对于发出的请求，DNS 服务器没办法知道它是否在中间链路被修改过，对于返回的结果，应用程序也没办法知道它是否在中间链路被修改过。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_134": { "__typename": "Paragraph", "id": "2f7bedd0404b_134", "name": "acc6", "type": "P", "href": null, "layout": null, "metadata": null, "text": "对于进入到 DNS outbound 里面的流量，DNS outbound 会把这个流量当作是 DNS 请求，也就是说把它当作一块数据，这块数据里面包含了 DNS 请求相关的信息，包括但不限于：DNS 请求的域名，DNS 请求的记录类型；还有所有类型的 outbound 都能够得到的一些通常的信息，比如这个流量的目的地址，目的端口，所用传输协议等等，这些信息都是 DNS outbound 能够轻易得到的。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_135": { "__typename": "Paragraph", "id": "2f7bedd0404b_135", "name": "2822", "type": "P", "href": null, "layout": null, "metadata": null, "text": "因为 DNS 请求里面的数据都是明文的，流经的中间设备、中间模块都看得到里面内容，那 DNS 请求的流量既然流经 DNS outbound，DNS outbound 理所当然也能看得到；而且返回数据的时候，就算 DNS outbound 把返回的数据删改了，或者索性自己凭空生成一个假的 DNS 回复返回给应用程序，应用程序也没办法知道真假。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_136": { "__typename": "Paragraph", "id": "2f7bedd0404b_136", "name": "0000", "type": "P", "href": null, "layout": null, "metadata": null, "text": "这就是 DNS outbound 的工作原理。只不过它并不是凭空生成一个假的 DNS 回复，而是求助于内置 DNS 模块：", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_137": { "__typename": "Paragraph", "id": "2f7bedd0404b_137", "name": "6336", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "1. 某个应用程序发了一个 DNS 查询", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_138": { "__typename": "Paragraph", "id": "2f7bedd0404b_138", "name": "42c8", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "2. 这个 DNS 查询的流量通过某种方式进入了 DNS outbound（这里暂时不讨论究竟是通过什么方式进入 DNS outbound 的）", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_139": { "__typename": "Paragraph", "id": "2f7bedd0404b_139", "name": "9bf9", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "3. 如果这个流量是个明文 DNS 请求，DNS outbound 肯定看得到里面内容，可以拿出里面的域名", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_140": { "__typename": "Paragraph", "id": "2f7bedd0404b_140", "name": "730f", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "4. DNS outbound 调用内置 DNS 模块，把拿到的域名传进去", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_141": { "__typename": "Paragraph", "id": "2f7bedd0404b_141", "name": "df41", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "5. 内置 DNS 模块根据它的配置去查这个域名的 IP，具体怎么查的，DNS outbound 并不知道，它只管要结果", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_142": { "__typename": "Paragraph", "id": "2f7bedd0404b_142", "name": "c72b", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "6. 内置 DNS 返回一些 IP 给 DNS outbound 后，DNS outbound 用这些 IP 生成了一个 DNS 回复", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_143": { "__typename": "Paragraph", "id": "2f7bedd0404b_143", "name": "efa3", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "7. DNS outbound 把这个 DNS 回复若无其事地返回给应用程序", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_144": { "__typename": "Paragraph", "id": "2f7bedd0404b_144", "name": "5813", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "8. 应用程序当然不知道这个 DNS 回复具体是怎么来的，它没办法，只能相信中间链路，相信这个回复就是它想要的回复", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_145": { "__typename": "Paragraph", "id": "2f7bedd0404b_145", "name": "1822", "type": "P", "href": null, "layout": null, "metadata": null, "text": "DNS outbound 的这种行为，实质上相当于 DNS 劫持，但说它是 DNS 劫持也不太对，因为是我们配置的，自愿让它 “劫持” 的嘛。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_146": { "__typename": "Paragraph", "id": "2f7bedd0404b_146", "name": "ecf2", "type": "P", "href": null, "layout": null, "metadata": null, "text": "DNS outbound 本身的工作原理相信已经比较清晰了，它只是劫持了进来的 DNS 请求的流量，然后找内置 DNS 模块帮忙解析 DNS，然后假装啥事没发生，返回结果而已。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_147": { "__typename": "Paragraph", "id": "2f7bedd0404b_147", "name": "8c71", "type": "BQ", "href": null, "layout": null, "metadata": null, "text": "要应用它，重点在于要用什么样的方式，把 DNS 流量引导到 DNS outbound 里去。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_148": { "__typename": "Paragraph", "id": "2f7bedd0404b_148", "name": "7db4", "type": "P", "href": null, "layout": null, "metadata": null, "text": "对于桌面系统，如果用浏览器来访问网站，那么，前面也说了，SOCKS5 协议可以带上域名给远端解析，根本不需要本地去解析域名。但假如不是用浏览器的情况呢？比如运行一个 nslookup 命令，默认它也不会用系统设置的代理，它是直接向系统设置的 DNS 服务器发 DNS 请求，怎么把这个请求的流量引导到 V2Ray 的 DNS outbound 呢？", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_149": { "__typename": "Paragraph", "id": "2f7bedd0404b_149", "name": "0ac0", "type": "P", "href": null, "layout": null, "metadata": null, "text": "考虑下以下配置：", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_150": { "__typename": "Paragraph", "id": "2f7bedd0404b_150", "name": "6557", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "{\n    \"inbounds\": [\n        {\n            \"port\": 53,\n            \"tag\": \"dns-in\",\n            \"protocol\": \"dokodemo-door\",\n            \"settings\": {\n                \"address\": \"1.1.1.1\",\n                \"port\": 53,\n                \"network\": \"tcp,udp\"\n            }\n        }\n    ],\n    \"dns\": {\n        \"hosts\": {\n            \"domain:www.bilibili.com\": \"1.2.3.4\"\n        }\n    },\n    \"outbounds\": [\n        {\n            \"protocol\": \"dns\",\n            \"tag\": \"dns-out\"\n        },\n        {\n            \"protocol\": \"freedom\",\n            \"tag\": \"direct\",\n            \"settings\": {}\n        }\n    ],\n    \"routing\": {\n        \"rules\": [\n            {\n                \"type\": \"field\",\n                \"inboundTag\": [\"dns-in\"],\n                \"outboundTag\": \"dns-out\"\n            }\n        ],\n        \"strategy\": \"rules\"\n    }\n}", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 336, "end": 352, "href": "http:\u002F\u002Fwww.bilibili.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_151": { "__typename": "Paragraph", "id": "2f7bedd0404b_151", "name": "fad0", "type": "P", "href": null, "layout": null, "metadata": null, "text": "这个配置让 V2Ray 的 dokodemo-door inbound 监听在本地 53 端口，对于任何进来的流量，会因为我们的路由规则，而被送到 DNS outbound 处理，然后我们把系统 DNS 设置为 127.0.0.1，相当于说 V2Ray 的 dokodemo-door inbound 就是一个 DNS 服务器。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_152": { "__typename": "Paragraph", "id": "2f7bedd0404b_152", "name": "0815", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "1. 命令行执行 nslookup www.bilibili.com\n2. 因为系统 DNS 设置为 127.0.0.1\n3. DNS 请求发到 dokodemo-door inbound\n4. 因为 \"dns-in\" -\u003E \"dns-out\" 路由规则，流量传给 DNS outbound\n5. DNS outbound 识别到是个 DNS 请求，拿到域名 www.bilibili.com，调用内置 DNS\n6. 这个域名匹配到内置 DNS 的一条 hosts 规则，返回结果 1.2.3.4\n7. 于是 nslookup 查询 www.bilibili.com 的结果是 1.2.3.4", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 18, "end": 34, "href": "http:\u002F\u002Fwww.bilibili.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }, { "__typename": "Markup", "type": "A", "start": 267, "end": 283, "href": "http:\u002F\u002Fwww.bilibili.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_153": { "__typename": "Paragraph", "id": "2f7bedd0404b_153", "name": "02c3", "type": "P", "href": null, "layout": null, "metadata": null, "text": "让 V2Ray 充当 DNS 服务器，设置系统 DNS 是其中一个把 DNS 流量引导到 DNS outbound 中的方式。但今天我们大部分的上网操作都是在浏览器上进行了，浏览器用了 SOCKS5 代理的话也不需要本地去解析 DNS，所以这个应用场景不常见。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_154": { "__typename": "Paragraph", "id": "2f7bedd0404b_154", "name": "e501", "type": "BQ", "href": null, "layout": null, "metadata": null, "text": "DNS outbound 开放出来后，最重要的应用场景，是在移动端和路由器上。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_155": { "__typename": "Paragraph", "id": "2f7bedd0404b_155", "name": "736d", "type": "P", "href": null, "layout": null, "metadata": null, "text": "在讨论移动端和路由器之前，先看看桌面系统上怎样可以做真正的全局代理。前面也说了，一般的浏览器代理，只代理浏览器的流量，要把 DNS 流量也代理了，就需要像上面那样更改系统 DNS 为 127.0.0.1，当我们需要真正的全局代理时（VPN 就是真正的全局代理），这种方便显然不合适，也不可能做得到真正全局代理。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_156": { "__typename": "Paragraph", "id": "2f7bedd0404b_156", "name": "b828", "type": "H4", "href": null, "layout": null, "metadata": null, "text": "tun2socks", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_157": { "__typename": "Paragraph", "id": "2f7bedd0404b_157", "name": "a365", "type": "P", "href": null, "layout": null, "metadata": null, "text": "下面介绍一种通过 tun2socks，能够把所有本机应用程序发出的流量都交给 V2Ray\u002FSOCKS\u002FShadowsocks，从而达到全局 TCP\u002FUDP 代理（对，只是 TCP\u002FUDP，ICMP 等等是不支持的，全局性还是不比真正的 VPN）。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_158": { "__typename": "Paragraph", "id": "2f7bedd0404b_158", "name": "0d94", "type": "P", "href": null, "layout": null, "metadata": null, "text": "为此我特意写了一篇关于在 Windows 上如何使用 tun2socks 实现全局 TCP\u002FUDP 流量代理的教程：", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_159": { "__typename": "Paragraph", "id": "2f7bedd0404b_159", "name": "6255", "type": "MIXTAPE_EMBED", "href": null, "layout": null, "metadata": null, "text": "[教程] 在 Windows 上使用 tun2socks 进行全局代理\n这是一篇在 Windows 上使用 tun2socks 进行全局 TCP\u002FUDP 流量代理的教程，有别于一般仅使用 SOCKS5…medium.com", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 0, "end": 111, "href": "https:\u002F\u002Fmedium.com\u002F@TachyonDevel\u002F%E6%95%99%E7%A8%8B-%E5%9C%A8-windows-%E4%B8%8A%E4%BD%BF%E7%94%A8-tun2socks-%E8%BF%9B%E8%A1%8C%E5%85%A8%E5%B1%80%E4%BB%A3%E7%90%86-aa51869dd0d", "anchorType": "LINK", "userId": null, "linkMetadata": null }, { "__typename": "Markup", "type": "STRONG", "start": 0, "end": 35, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }, { "__typename": "Markup", "type": "EM", "start": 36, "end": 101, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": { "__typename": "MixtapeMetadata", "href": "https:\u002F\u002Fmedium.com\u002F@TachyonDevel\u002F%E6%95%99%E7%A8%8B-%E5%9C%A8-windows-%E4%B8%8A%E4%BD%BF%E7%94%A8-tun2socks-%E8%BF%9B%E8%A1%8C%E5%85%A8%E5%B1%80%E4%BB%A3%E7%90%86-aa51869dd0d", "mediaResource": { "__typename": "MediaResource", "mediumCatalog": null }, "thumbnailImageId": "1*FMxGqnBy9DV48g4yZ_vWKg.png" } }, "Paragraph:2f7bedd0404b_160": { "__typename": "Paragraph", "id": "2f7bedd0404b_160", "name": "41a4", "type": "P", "href": null, "layout": null, "metadata": null, "text": "tun2socks 就是这么一种可以把所有应用程序的 TCP\u002FUDP 流量都交给 V2Ray 的方式，当然其中包括 DNS 的流量，所以用了 tun2socks 后，我们甚至不需要更改系统的 DNS 设置，所有 DNS 请求的流量都能够被引导到 V2Ray，然后我们可以在 V2Ray 里加一条路由规则，识别出 DNS 的流量，把这些流量转给 DNS outbound：", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_161": { "__typename": "Paragraph", "id": "2f7bedd0404b_161", "name": "8751", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "{\n    \"dns\": {\n        \"hosts\": {\n            \"domain:www.bilibili.com\": \"1.2.3.4\"\n        }\n    },\n    \"outbounds\": [\n        {\n            \"protocol\": \"dns\",\n            \"tag\": \"dns-out\"\n        },\n        {\n            \u002F\u002F VMess outbound\n        }\n    ],\n    \"routing\": {\n        \"rules\": [\n            {\n                \"type\": \"field\",\n                \"network\": \"udp\",\n                \"port\": 53,\n                \"outboundTag\": \"dns-out\"\n            }\n        ],\n        \"strategy\": \"rules\"\n    }\n}", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 54, "end": 70, "href": "http:\u002F\u002Fwww.bilibili.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_162": { "__typename": "Paragraph", "id": "2f7bedd0404b_162", "name": "b9af", "type": "P", "href": null, "layout": null, "metadata": null, "text": "配置做了简化，真拿来用的话要自己补上其它部分。配置中没有 inbound，因为我们所用的 tun2socks 软件：go-tun2socks 本身把 tun2socks 内置为 V2Ray 的一个 inbound 了。", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 58, "end": 70, "href": "https:\u002F\u002Fgithub.com\u002Feycorsican\u002Fgo-tun2socks", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_163": { "__typename": "Paragraph", "id": "2f7bedd0404b_163", "name": "4ab0", "type": "BQ", "href": null, "layout": null, "metadata": null, "text": "go-tun2socks 是一个命令行工具，要使用的话还要自己创建 TUN 接口，配置路由表等，比较繁琐，这里还有另一个应用叫 Mellow ，对 go-tun2socks 进行了包装，可以自动完成这些繁琐的步骤，实际使用起来的效果就相当于 Proxifier、SSTap、Surge for Mac 等软件，可以把所有流量都代理了：", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "CODE", "start": 0, "end": 12, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }, { "__typename": "Markup", "type": "CODE", "start": 74, "end": 86, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }, { "__typename": "Markup", "type": "A", "start": 64, "end": 70, "href": "https:\u002F\u002Fgithub.com\u002Feycorsican\u002FMellow", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_164": { "__typename": "Paragraph", "id": "2f7bedd0404b_164", "name": "fa21", "type": "MIXTAPE_EMBED", "href": null, "layout": null, "metadata": null, "text": "eycorsican\u002FMellow\nA V2Ray client that can handle all TCP\u002FUDP\u002FICMP traffic. - eycorsican\u002FMellowgithub.com", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 0, "end": 104, "href": "https:\u002F\u002Fgithub.com\u002Feycorsican\u002FMellow", "anchorType": "LINK", "userId": null, "linkMetadata": null }, { "__typename": "Markup", "type": "STRONG", "start": 0, "end": 17, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }, { "__typename": "Markup", "type": "EM", "start": 18, "end": 94, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": { "__typename": "MixtapeMetadata", "href": "https:\u002F\u002Fgithub.com\u002Feycorsican\u002FMellow", "mediaResource": { "__typename": "MediaResource", "mediumCatalog": null }, "thumbnailImageId": "" } }, "Paragraph:2f7bedd0404b_165": { "__typename": "Paragraph", "id": "2f7bedd0404b_165", "name": "30cb", "type": "P", "href": null, "layout": null, "metadata": null, "text": "说白了，目的还是之前所说的，找到一种方法把 DNS 请求的流量引导到 DNS outbound 中。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_166": { "__typename": "Paragraph", "id": "2f7bedd0404b_166", "name": "8260", "type": "H4", "href": null, "layout": null, "metadata": null, "text": "移动端环境", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_167": { "__typename": "Paragraph", "id": "2f7bedd0404b_167", "name": "6b84", "type": "P", "href": null, "layout": null, "metadata": null, "text": "上面提 tun2socks，是因为在移动端上，要代理所有 app 的流量，tun2socks 是一种必须的手段，它们跟桌面系统上用 tun2socks 很相似，都是要把所有的 TCP\u002FUDP 流量引导进 V2Ray，但也有不一样的地方，移动端系统一般都提供了特殊的方法，能够让指定的流量不受路由表基于 IP 地址的路由控制。", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "EM", "start": 118, "end": 161, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_168": { "__typename": "Paragraph", "id": "2f7bedd0404b_168", "name": "cc93", "type": "P", "href": null, "layout": null, "metadata": null, "text": "在移动端系统方面，iOS 既可以像桌面系统用 tun2socks 那样把所有 TCP\u002FUDP 流量引导到 V2Ray，也可以设置一个 HTTP 代理把 HTTP 请求代理到 V2Ray 的 HTTP inbound 里；而 Android，只能以 tun2socks 那样的方式把 TCP\u002FUDP 流量引导进去。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_169": { "__typename": "Paragraph", "id": "2f7bedd0404b_169", "name": "77ce", "type": "P", "href": null, "layout": null, "metadata": null, "text": "iOS 的 HTTP\u002FS 代理跟 SOCKS5 代理比较相似，应用程序不需要自己解析 DNS，可以把域名带上交给 V2Ray，然后如果请求匹配到代理的路由规则，这个域名就通过代理协议（VMess\u002FShadowsocks\u002FSOCKS5）交给代理服务器自己去解析，所以本地不需要做任何 DNS 解析。问题是很明显这个只适用于 HTTP\u002FS 请求（而且并不是所有的 HTTP\u002FS 请求，貌似应用程序还必须要用 iOS 系统提供的 HTTP 库来做请求才会被代理到）。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_170": { "__typename": "Paragraph", "id": "2f7bedd0404b_170", "name": "42b2", "type": "P", "href": null, "layout": null, "metadata": null, "text": "再考虑到 Android 并不能很自然地支持 HTTP\u002FS 或者 SOCKS5 代理，所以想要一个通用的解决方案，还是要从 TCP\u002FUDP 流量入手。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_171": { "__typename": "Paragraph", "id": "2f7bedd0404b_171", "name": "0b56", "type": "P", "href": null, "layout": null, "metadata": null, "text": "假如你使用的 Android 客户端是 Kitsunebi，那大致上可以这么配置：", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 20, "end": 29, "href": "https:\u002F\u002Fplay.google.com\u002Fstore\u002Fapps\u002Fdetails?id=fun.kitsunebi.kitsunebi4android", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_172": { "__typename": "Paragraph", "id": "2f7bedd0404b_172", "name": "38b7", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "{\n    \"dns\": {\n        \"hosts\": {\n            \"domain:www.bilibili.com\": \"1.2.3.4\"\n        },\n        \"servers\": [\n            \"114.114.114.114\",\n            {\n                \"address\": \"8.8.8.8\",\n                \"domains\": [\n                    \"google\"\n                ],\n                \"port\": 53\n            }\n        ]\n    },\n    \"outbounds\": [\n        {\n            \"protocol\": \"vmess\",\n            \"tag\": \"proxy\"\n        },\n        {\n            \"protocol\": \"freedom\",\n            \"settings\": {},\n            \"tag\": \"direct\"\n        },\n     {\n         \"protocol\": \"dns\",\n         \"tag\": \"dns-out\"\n     }\n    ],\n    \"routing\": {\n        \"rules\": [\n            {\n                \"inboundTag\": [\"tun2socks\"],\n                \"network\": \"udp\",\n                \"port\": 53,\n                \"outboundTag\": \"dns-out\",\n                \"type\": \"field\"\n            },\n            {\n                \"ip\": [\n                    \"8.8.8.8\u002F32\"\n                ],\n                \"outboundTag\": \"proxy\",\n                \"type\": \"field\"\n            }\n        ],\n        \"strategy\": \"rules\"\n    }\n}", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 54, "end": 70, "href": "http:\u002F\u002Fwww.bilibili.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_173": { "__typename": "Paragraph", "id": "2f7bedd0404b_173", "name": "79ff", "type": "P", "href": null, "layout": null, "metadata": null, "text": "配置中的 inboundTag tun2socks 是必须的，虽然单凭 53 端口 和 network udp 大致达到识别出 UDP 流量的目的，但因为在 V2Ray 中 UDP 流量并不只从 tun2socks inbound 进来，还会从 内置 DNS 那边过来，如果不加上 inboundTag tun2socks 这个限制，内置 DNS 那边过来的流量就会被转到 DNS outbound，接着有可能又被转给 内置 DNS，造成环路。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_174": { "__typename": "Paragraph", "id": "2f7bedd0404b_174", "name": "b9ff", "type": "P", "href": null, "layout": null, "metadata": null, "text": "通过前面桌面端上对 V2Ray 的 内置 DNS 和 DNS outbound 的说明，现在移动端也可以方便地拿到所有 TCP\u002FUDP 流量，上面的方法都可以套用下来，就不继续说了。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_175": { "__typename": "Paragraph", "id": "2f7bedd0404b_175", "name": "4b05", "type": "P", "href": null, "layout": null, "metadata": null, "text": "大体上，从流量流向的角度来看，一般 DNS 处理方式也就 3 种：", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_176": { "__typename": "Paragraph", "id": "2f7bedd0404b_176", "name": "2156", "type": "ULI", "href": null, "layout": null, "metadata": null, "text": "直接从本机发出 DNS 请求到目的 DNS 服务器", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_177": { "__typename": "Paragraph", "id": "2f7bedd0404b_177", "name": "972f", "type": "ULI", "href": null, "layout": null, "metadata": null, "text": "通过代理把 DNS 请求发送到目的 DNS 服务器", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_178": { "__typename": "Paragraph", "id": "2f7bedd0404b_178", "name": "afb8", "type": "ULI", "href": null, "layout": null, "metadata": null, "text": "本机不向互联网发出 DNS 请求流量（由远端代理服务器来解析或者直接本地伪造 DNS 答复返回）", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_179": { "__typename": "Paragraph", "id": "2f7bedd0404b_179", "name": "2d7c", "type": "H4", "href": null, "layout": null, "metadata": null, "text": "Fake DNS", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_180": { "__typename": "Paragraph", "id": "2f7bedd0404b_180", "name": "4cf6", "type": "P", "href": null, "layout": null, "metadata": null, "text": "虽然现在已经可以完全利用 V2Ray 的 DNS 功能模块对 DNS 的 UDP 流量做各种处理，可以对 DNS 请求按域名做分流，但仔细想想，分流时不管是发到 freedom outbound 直连还是发到 VMess outbound 代理，这些 DNS 请求终究是要以实际的流量形式从本地发送到互联网上，是否有方法可以在利用 tun2socks 获取所有 TCP\u002FUDP 流量的同时，又可以像 HTTP\u002FS 和 SOCKS5 代理那样，本地完全不发出 DNS 请求流量，只把域名交给代理服务器，让代理服务器自己去解析呢？", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_181": { "__typename": "Paragraph", "id": "2f7bedd0404b_181", "name": "b90a", "type": "P", "href": null, "layout": null, "metadata": null, "text": "答案是有的，那就是 Fake DNS，Fake DNS 是有一个 RFC 的，某些使用 iOS 的读者可能也并不陌生，Surge 中的 force-remote-dns 就是利用了这种技术。", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "CODE", "start": 68, "end": 84, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }, { "__typename": "Markup", "type": "A", "start": 33, "end": 36, "href": "https:\u002F\u002Ftools.ietf.org\u002Fhtml\u002Frfc3089", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_182": { "__typename": "Paragraph", "id": "2f7bedd0404b_182", "name": "903d", "type": "P", "href": null, "layout": null, "metadata": null, "text": "大致工作原理如下：", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_183": { "__typename": "Paragraph", "id": "2f7bedd0404b_183", "name": "aeef", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "1. 手机上某个 app 想发出 https:\u002F\u002Fwww.google.com 请求", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 17, "end": 39, "href": "https:\u002F\u002Fwww.google.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_184": { "__typename": "Paragraph", "id": "2f7bedd0404b_184", "name": "f67d", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "2. app 发出 www.google.com 的 DNS 查询", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 10, "end": 24, "href": "http:\u002F\u002Fwww.google.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_185": { "__typename": "Paragraph", "id": "2f7bedd0404b_185", "name": "a384", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "3. DNS 请求的 UDP 流量来到 tun2socks，被 tun2socks 交到 Fake DNS 模块", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_186": { "__typename": "Paragraph", "id": "2f7bedd0404b_186", "name": "952a", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "4. Fake DNS 模块选择一个伪造的 IP 地址，比如 244.0.0.3，并把这个地址跟 www.google.com 关联起来", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 49, "end": 63, "href": "http:\u002F\u002Fwww.google.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_187": { "__typename": "Paragraph", "id": "2f7bedd0404b_187", "name": "e1ea", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "5. Fake DNS 根据 DNS 请求，生成相应的 DNS 答复，并把 244.0.0.3 当作 DNS 结果放进答复中，通过 tun2socks 把这个伪造的 DNS 答复返回给 app", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_188": { "__typename": "Paragraph", "id": "2f7bedd0404b_188", "name": "54a5", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "6. app 得到 www.google.com 的 DNS 查询结果是 244.0.0.3", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 10, "end": 24, "href": "http:\u002F\u002Fwww.google.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_189": { "__typename": "Paragraph", "id": "2f7bedd0404b_189", "name": "448d", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "7. app 向 244.0.0.3 发出 HTTP 请求流量", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_190": { "__typename": "Paragraph", "id": "2f7bedd0404b_190", "name": "d999", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "8. HTTP 请求流量来到 tun2socks，tun2socks 向 Fake DNS 模块查询目的地址 244.0.0.3 是否是一个伪造的 IP 地址，如果是，向 Fake DNS 查询这个 IP 所关联的 域名，也即 www.google.com", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 114, "end": 128, "href": "http:\u002F\u002Fwww.google.com", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_191": { "__typename": "Paragraph", "id": "2f7bedd0404b_191", "name": "faf0", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "9. tun2socks 现在已经得到 HTTP 请求流量的域名，把流量以及域名一并交给 V2Ray", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_192": { "__typename": "Paragraph", "id": "2f7bedd0404b_192", "name": "b0e4", "type": "PRE", "href": null, "layout": null, "metadata": null, "text": "10. V2Ray 有了域名，接下来路由什么的该怎么处理就怎么处理了", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_193": { "__typename": "Paragraph", "id": "2f7bedd0404b_193", "name": "857b", "type": "P", "href": null, "layout": null, "metadata": null, "text": "上面过程中，虽然 app 是发出了 DNS 请求流量，但这个流量被拦截下来了，并没有真正地发到互联网上；最终 V2Ray 也拿到了域名，如果这个域名匹配到代理规则，就会交到代理服务器来解析，也就是所谓的 远程 DNS 解析。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_194": { "__typename": "Paragraph", "id": "2f7bedd0404b_194", "name": "a2a9", "type": "P", "href": null, "layout": null, "metadata": null, "text": "上面过程中，Fake DNS 模块如果没有对域名做过滤，对任何域名都返回伪造的 IP 地址，则可能会引起一些问题，有一种做法是在 Fake DNS 模块里内置一个域名列表，只对匹配到列表的域名返回 伪造 DNS 答复。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_195": { "__typename": "Paragraph", "id": "2f7bedd0404b_195", "name": "a547", "type": "P", "href": null, "layout": null, "metadata": null, "text": "Fake DNS 不管是原理上还是实现上都是非常简单的，如果有兴趣可以看一下 这里的实现代码。", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 39, "end": 46, "href": "https:\u002F\u002Fgithub.com\u002Feycorsican\u002Fleaf\u002Fblob\u002Fmaster\u002Fleaf\u002Fsrc\u002Fapp\u002Ffake_dns.rs", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_196": { "__typename": "Paragraph", "id": "2f7bedd0404b_196", "name": "b2c9", "type": "H4", "href": null, "layout": null, "metadata": null, "text": "DNS Fallback", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_197": { "__typename": "Paragraph", "id": "2f7bedd0404b_197", "name": "e449", "type": "P", "href": null, "layout": null, "metadata": null, "text": "接下来再说说一种叫做 DNS fallback 的技术（这个名字可能不太对），在代理服务器不支持 UDP 的时候，单纯的全局 TCP\u002FUDP 流量代理 就会出问题了，因为要解析 DNS 就需要 UDP，服务器不支持 UDP 就没办法处理 DNS ，也就没办法处理所有域名请求了，DNS fallback 是一种可以强制让应用程序把 DNS 请求以 TCP 流量发送出去的技术。", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "STRONG", "start": 57, "end": 76, "href": null, "anchorType": null, "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_198": { "__typename": "Paragraph", "id": "2f7bedd0404b_198", "name": "9801", "type": "BQ", "href": null, "layout": null, "metadata": null, "text": "需要说明的是，如果用了 V2Ray 的技术，或者 Fake DNS，那 DNS fallback 是没必要的，DNS fallback 也是一种处理 DNS 相关问题技术，这里只是想把这种技术也列举出来", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_199": { "__typename": "Paragraph", "id": "2f7bedd0404b_199", "name": "57f1", "type": "P", "href": null, "layout": null, "metadata": null, "text": "众所周知一般的 DNS 请求都是用 UDP 发的，但 DNS 的 UDP 报文的大小会被限制在大概 512 字节，如果某个 DNS 答复很长，超过了这个限制，就不能通过 UDP 来传输了，为此 DNS 规范中提出，对于这种超过限制大小的 DNS 请求，DNS 服务器可以在答复中设置一个 flag（truncated），来告诉客户端这个答复太长，你不能用 UDP 来做这个 DNS 请求，请用 TCP，于是客户端就会用 TCP 来重新请求 DNS。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_200": { "__typename": "Paragraph", "id": "2f7bedd0404b_200", "name": "c342", "type": "P", "href": null, "layout": null, "metadata": null, "text": "DNS fallback 正是利用了这一点，在 tun2socks 给过来的 UDP 流量中识别出 DNS 请求，然后伪造一个设置了 truncated flag 的答复返回给客户端，客户端就会转用 TCP 来做 DNS 请求了。", "hasDropCap": null, "dropCapImage": null, "markups": [], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "Paragraph:2f7bedd0404b_201": { "__typename": "Paragraph", "id": "2f7bedd0404b_201", "name": "83b7", "type": "P", "href": null, "layout": null, "metadata": null, "text": "DNS fallback 的实现也是非常简单的，有兴趣可以看一下 这里的代码。", "hasDropCap": null, "dropCapImage": null, "markups": [{ "__typename": "Markup", "type": "A", "start": 33, "end": 38, "href": "https:\u002F\u002Fgithub.com\u002Feycorsican\u002Fgo-tun2socks\u002Fblob\u002Fmaster\u002Fproxy\u002Fdnsfallback\u002Fudp.go", "anchorType": "LINK", "userId": null, "linkMetadata": null }], "codeBlockMetadata": null, "iframe": null, "mixtapeMetadata": null }, "ImageMetadata:": { "__typename": "ImageMetadata", "id": "", "alt": null, "focusPercentX": null, "focusPercentY": null, "originalHeight": null, "originalWidth": null }, "Tag:dns": { "__typename": "Tag", "id": "dns", "displayTitle": "DNS", "normalizedTagSlug": "dns" }, "Tag:v2ray": { "__typename": "Tag", "id": "v2ray", "displayTitle": "V2ray", "normalizedTagSlug": "v2ray" }, "Tag:proxy": { "__typename": "Tag", "id": "proxy", "displayTitle": "Proxy", "normalizedTagSlug": "proxy" }, "Tag:fakedns": { "__typename": "Tag", "id": "fakedns", "displayTitle": "Fakedns", "normalizedTagSlug": "fakedns" }, "Tag:dnsfallback": { "__typename": "Tag", "id": "dnsfallback", "displayTitle": "Dnsfallback", "normalizedTagSlug": "dnsfallback" }, "Post:62c50e58cbd0": { "__typename": "Post", "id": "62c50e58cbd0", "collection": null, "content({\"postMeteringOptions\":{}})": { "__typename": "PostContent", "isLockedPreviewOnly": false, "bodyModel": { "__typename": "RichText", "sections": [{ "__typename": "Section", "name": "d9e9", "startIndex": 0, "textLayout": null, "imageLayout": null, "backgroundImage": null, "videoLayout": null, "backgroundVideo": null }], "paragraphs": [{ "__ref": "Paragraph:2f7bedd0404b_0" }, { "__ref": "Paragraph:2f7bedd0404b_1" }, { "__ref": "Paragraph:2f7bedd0404b_2" }, { "__ref": "Paragraph:2f7bedd0404b_3" }, { "__ref": "Paragraph:2f7bedd0404b_4" }, { "__ref": "Paragraph:2f7bedd0404b_5" }, { "__ref": "Paragraph:2f7bedd0404b_6" }, { "__ref": "Paragraph:2f7bedd0404b_7" }, { "__ref": "Paragraph:2f7bedd0404b_8" }, { "__ref": "Paragraph:2f7bedd0404b_9" }, { "__ref": "Paragraph:2f7bedd0404b_10" }, { "__ref": "Paragraph:2f7bedd0404b_11" }, { "__ref": "Paragraph:2f7bedd0404b_12" }, { "__ref": "Paragraph:2f7bedd0404b_13" }, { "__ref": "Paragraph:2f7bedd0404b_14" }, { "__ref": "Paragraph:2f7bedd0404b_15" }, { "__ref": "Paragraph:2f7bedd0404b_16" }, { "__ref": "Paragraph:2f7bedd0404b_17" }, { "__ref": "Paragraph:2f7bedd0404b_18" }, { "__ref": "Paragraph:2f7bedd0404b_19" }, { "__ref": "Paragraph:2f7bedd0404b_20" }, { "__ref": "Paragraph:2f7bedd0404b_21" }, { "__ref": "Paragraph:2f7bedd0404b_22" }, { "__ref": "Paragraph:2f7bedd0404b_23" }, { "__ref": "Paragraph:2f7bedd0404b_24" }, { "__ref": "Paragraph:2f7bedd0404b_25" }, { "__ref": "Paragraph:2f7bedd0404b_26" }, { "__ref": "Paragraph:2f7bedd0404b_27" }, { "__ref": "Paragraph:2f7bedd0404b_28" }, { "__ref": "Paragraph:2f7bedd0404b_29" }, { "__ref": "Paragraph:2f7bedd0404b_30" }, { "__ref": "Paragraph:2f7bedd0404b_31" }, { "__ref": "Paragraph:2f7bedd0404b_32" }, { "__ref": "Paragraph:2f7bedd0404b_33" }, { "__ref": "Paragraph:2f7bedd0404b_34" }, { "__ref": "Paragraph:2f7bedd0404b_35" }, { "__ref": "Paragraph:2f7bedd0404b_36" }, { "__ref": "Paragraph:2f7bedd0404b_37" }, { "__ref": "Paragraph:2f7bedd0404b_38" }, { "__ref": "Paragraph:2f7bedd0404b_39" }, { "__ref": "Paragraph:2f7bedd0404b_40" }, { "__ref": "Paragraph:2f7bedd0404b_41" }, { "__ref": "Paragraph:2f7bedd0404b_42" }, { "__ref": "Paragraph:2f7bedd0404b_43" }, { "__ref": "Paragraph:2f7bedd0404b_44" }, { "__ref": "Paragraph:2f7bedd0404b_45" }, { "__ref": "Paragraph:2f7bedd0404b_46" }, { "__ref": "Paragraph:2f7bedd0404b_47" }, { "__ref": "Paragraph:2f7bedd0404b_48" }, { "__ref": "Paragraph:2f7bedd0404b_49" }, { "__ref": "Paragraph:2f7bedd0404b_50" }, { "__ref": "Paragraph:2f7bedd0404b_51" }, { "__ref": "Paragraph:2f7bedd0404b_52" }, { "__ref": "Paragraph:2f7bedd0404b_53" }, { "__ref": "Paragraph:2f7bedd0404b_54" }, { "__ref": "Paragraph:2f7bedd0404b_55" }, { "__ref": "Paragraph:2f7bedd0404b_56" }, { "__ref": "Paragraph:2f7bedd0404b_57" }, { "__ref": "Paragraph:2f7bedd0404b_58" }, { "__ref": "Paragraph:2f7bedd0404b_59" }, { "__ref": "Paragraph:2f7bedd0404b_60" }, { "__ref": "Paragraph:2f7bedd0404b_61" }, { "__ref": "Paragraph:2f7bedd0404b_62" }, { "__ref": "Paragraph:2f7bedd0404b_63" }, { "__ref": "Paragraph:2f7bedd0404b_64" }, { "__ref": "Paragraph:2f7bedd0404b_65" }, { "__ref": "Paragraph:2f7bedd0404b_66" }, { "__ref": "Paragraph:2f7bedd0404b_67" }, { "__ref": "Paragraph:2f7bedd0404b_68" }, { "__ref": "Paragraph:2f7bedd0404b_69" }, { "__ref": "Paragraph:2f7bedd0404b_70" }, { "__ref": "Paragraph:2f7bedd0404b_71" }, { "__ref": "Paragraph:2f7bedd0404b_72" }, { "__ref": "Paragraph:2f7bedd0404b_73" }, { "__ref": "Paragraph:2f7bedd0404b_74" }, { "__ref": "Paragraph:2f7bedd0404b_75" }, { "__ref": "Paragraph:2f7bedd0404b_76" }, { "__ref": "Paragraph:2f7bedd0404b_77" }, { "__ref": "Paragraph:2f7bedd0404b_78" }, { "__ref": "Paragraph:2f7bedd0404b_79" }, { "__ref": "Paragraph:2f7bedd0404b_80" }, { "__ref": "Paragraph:2f7bedd0404b_81" }, { "__ref": "Paragraph:2f7bedd0404b_82" }, { "__ref": "Paragraph:2f7bedd0404b_83" }, { "__ref": "Paragraph:2f7bedd0404b_84" }, { "__ref": "Paragraph:2f7bedd0404b_85" }, { "__ref": "Paragraph:2f7bedd0404b_86" }, { "__ref": "Paragraph:2f7bedd0404b_87" }, { "__ref": "Paragraph:2f7bedd0404b_88" }, { "__ref": "Paragraph:2f7bedd0404b_89" }, { "__ref": "Paragraph:2f7bedd0404b_90" }, { "__ref": "Paragraph:2f7bedd0404b_91" }, { "__ref": "Paragraph:2f7bedd0404b_92" }, { "__ref": "Paragraph:2f7bedd0404b_93" }, { "__ref": "Paragraph:2f7bedd0404b_94" }, { "__ref": "Paragraph:2f7bedd0404b_95" }, { "__ref": "Paragraph:2f7bedd0404b_96" }, { "__ref": "Paragraph:2f7bedd0404b_97" }, { "__ref": "Paragraph:2f7bedd0404b_98" }, { "__ref": "Paragraph:2f7bedd0404b_99" }, { "__ref": "Paragraph:2f7bedd0404b_100" }, { "__ref": "Paragraph:2f7bedd0404b_101" }, { "__ref": "Paragraph:2f7bedd0404b_102" }, { "__ref": "Paragraph:2f7bedd0404b_103" }, { "__ref": "Paragraph:2f7bedd0404b_104" }, { "__ref": "Paragraph:2f7bedd0404b_105" }, { "__ref": "Paragraph:2f7bedd0404b_106" }, { "__ref": "Paragraph:2f7bedd0404b_107" }, { "__ref": "Paragraph:2f7bedd0404b_108" }, { "__ref": "Paragraph:2f7bedd0404b_109" }, { "__ref": "Paragraph:2f7bedd0404b_110" }, { "__ref": "Paragraph:2f7bedd0404b_111" }, { "__ref": "Paragraph:2f7bedd0404b_112" }, { "__ref": "Paragraph:2f7bedd0404b_113" }, { "__ref": "Paragraph:2f7bedd0404b_114" }, { "__ref": "Paragraph:2f7bedd0404b_115" }, { "__ref": "Paragraph:2f7bedd0404b_116" }, { "__ref": "Paragraph:2f7bedd0404b_117" }, { "__ref": "Paragraph:2f7bedd0404b_118" }, { "__ref": "Paragraph:2f7bedd0404b_119" }, { "__ref": "Paragraph:2f7bedd0404b_120" }, { "__ref": "Paragraph:2f7bedd0404b_121" }, { "__ref": "Paragraph:2f7bedd0404b_122" }, { "__ref": "Paragraph:2f7bedd0404b_123" }, { "__ref": "Paragraph:2f7bedd0404b_124" }, { "__ref": "Paragraph:2f7bedd0404b_125" }, { "__ref": "Paragraph:2f7bedd0404b_126" }, { "__ref": "Paragraph:2f7bedd0404b_127" }, { "__ref": "Paragraph:2f7bedd0404b_128" }, { "__ref": "Paragraph:2f7bedd0404b_129" }, { "__ref": "Paragraph:2f7bedd0404b_130" }, { "__ref": "Paragraph:2f7bedd0404b_131" }, { "__ref": "Paragraph:2f7bedd0404b_132" }, { "__ref": "Paragraph:2f7bedd0404b_133" }, { "__ref": "Paragraph:2f7bedd0404b_134" }, { "__ref": "Paragraph:2f7bedd0404b_135" }, { "__ref": "Paragraph:2f7bedd0404b_136" }, { "__ref": "Paragraph:2f7bedd0404b_137" }, { "__ref": "Paragraph:2f7bedd0404b_138" }, { "__ref": "Paragraph:2f7bedd0404b_139" }, { "__ref": "Paragraph:2f7bedd0404b_140" }, { "__ref": "Paragraph:2f7bedd0404b_141" }, { "__ref": "Paragraph:2f7bedd0404b_142" }, { "__ref": "Paragraph:2f7bedd0404b_143" }, { "__ref": "Paragraph:2f7bedd0404b_144" }, { "__ref": "Paragraph:2f7bedd0404b_145" }, { "__ref": "Paragraph:2f7bedd0404b_146" }, { "__ref": "Paragraph:2f7bedd0404b_147" }, { "__ref": "Paragraph:2f7bedd0404b_148" }, { "__ref": "Paragraph:2f7bedd0404b_149" }, { "__ref": "Paragraph:2f7bedd0404b_150" }, { "__ref": "Paragraph:2f7bedd0404b_151" }, { "__ref": "Paragraph:2f7bedd0404b_152" }, { "__ref": "Paragraph:2f7bedd0404b_153" }, { "__ref": "Paragraph:2f7bedd0404b_154" }, { "__ref": "Paragraph:2f7bedd0404b_155" }, { "__ref": "Paragraph:2f7bedd0404b_156" }, { "__ref": "Paragraph:2f7bedd0404b_157" }, { "__ref": "Paragraph:2f7bedd0404b_158" }, { "__ref": "Paragraph:2f7bedd0404b_159" }, { "__ref": "Paragraph:2f7bedd0404b_160" }, { "__ref": "Paragraph:2f7bedd0404b_161" }, { "__ref": "Paragraph:2f7bedd0404b_162" }, { "__ref": "Paragraph:2f7bedd0404b_163" }, { "__ref": "Paragraph:2f7bedd0404b_164" }, { "__ref": "Paragraph:2f7bedd0404b_165" }, { "__ref": "Paragraph:2f7bedd0404b_166" }, { "__ref": "Paragraph:2f7bedd0404b_167" }, { "__ref": "Paragraph:2f7bedd0404b_168" }, { "__ref": "Paragraph:2f7bedd0404b_169" }, { "__ref": "Paragraph:2f7bedd0404b_170" }, { "__ref": "Paragraph:2f7bedd0404b_171" }, { "__ref": "Paragraph:2f7bedd0404b_172" }, { "__ref": "Paragraph:2f7bedd0404b_173" }, { "__ref": "Paragraph:2f7bedd0404b_174" }, { "__ref": "Paragraph:2f7bedd0404b_175" }, { "__ref": "Paragraph:2f7bedd0404b_176" }, { "__ref": "Paragraph:2f7bedd0404b_177" }, { "__ref": "Paragraph:2f7bedd0404b_178" }, { "__ref": "Paragraph:2f7bedd0404b_179" }, { "__ref": "Paragraph:2f7bedd0404b_180" }, { "__ref": "Paragraph:2f7bedd0404b_181" }, { "__ref": "Paragraph:2f7bedd0404b_182" }, { "__ref": "Paragraph:2f7bedd0404b_183" }, { "__ref": "Paragraph:2f7bedd0404b_184" }, { "__ref": "Paragraph:2f7bedd0404b_185" }, { "__ref": "Paragraph:2f7bedd0404b_186" }, { "__ref": "Paragraph:2f7bedd0404b_187" }, { "__ref": "Paragraph:2f7bedd0404b_188" }, { "__ref": "Paragraph:2f7bedd0404b_189" }, { "__ref": "Paragraph:2f7bedd0404b_190" }, { "__ref": "Paragraph:2f7bedd0404b_191" }, { "__ref": "Paragraph:2f7bedd0404b_192" }, { "__ref": "Paragraph:2f7bedd0404b_193" }, { "__ref": "Paragraph:2f7bedd0404b_194" }, { "__ref": "Paragraph:2f7bedd0404b_195" }, { "__ref": "Paragraph:2f7bedd0404b_196" }, { "__ref": "Paragraph:2f7bedd0404b_197" }, { "__ref": "Paragraph:2f7bedd0404b_198" }, { "__ref": "Paragraph:2f7bedd0404b_199" }, { "__ref": "Paragraph:2f7bedd0404b_200" }, { "__ref": "Paragraph:2f7bedd0404b_201" }] }, "validatedShareKey": "", "shareKeyCreator": null }, "creator": { "__ref": "User:35c856cf9e4d" }, "inResponseToEntityType": null, "isLocked": false, "isMarkedPaywallOnly": false, "lockedSource": "LOCKED_POST_SOURCE_NONE", "mediumUrl": "https:\u002F\u002Ftachyondevel.medium.com\u002F%E6%BC%AB%E8%B0%88%E5%90%84%E7%A7%8D%E9%BB%91%E7%A7%91%E6%8A%80%E5%BC%8F-dns-%E6%8A%80%E6%9C%AF%E5%9C%A8%E4%BB%A3%E7%90%86%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8-62c50e58cbd0", "primaryTopic": null, "topics": [], "isPublished": true, "latestPublishedVersion": "2f7bedd0404b", "visibility": "PUBLIC", "postResponses": { "__typename": "PostResponses", "count": 12 }, "createdAt": 1550255736154, "firstPublishedAt": 1550263320917, "latestPublishedAt": 1612631703897, "clapCount": 1126, "allowResponses": true, "isLimitedState": false, "title": "漫谈各种黑科技式 DNS 技术在代理环境中的应用", "isSeries": false, "sequence": null, "uniqueSlug": "漫谈各种黑科技式-dns-技术在代理环境中的应用-62c50e58cbd0", "socialTitle": "", "socialDek": "", "noIndex": null, "canonicalUrl": "", "metaDescription": "", "readingTime": 37.904, "previewContent": { "__typename": "PreviewContent", "subtitle": "这篇文章目的是以非技术性例举方式，谈一谈各种 DNS 技术在代理环境中如何工作，主要集中在对 V2Ray 的使用上，因为最近 V2Ray 发布了一个 DNS…" }, "previewImage": { "__ref": "ImageMetadata:" }, "isShortform": false, "seoTitle": "", "updatedAt": 1666942852845, "shortformType": "SHORTFORM_TYPE_LINK", "seoDescription": "", "isSuspended": false, "license": "ALL_RIGHTS_RESERVED", "tags": [{ "__ref": "Tag:dns" }, { "__ref": "Tag:v2ray" }, { "__ref": "Tag:proxy" }, { "__ref": "Tag:fakedns" }, { "__ref": "Tag:dnsfallback" }], "isNewsletter": false, "statusForCollection": null, "pendingCollection": null, "detectedLanguage": "zh", "wordCount": 2407, "layerCake": 0 } }</script>
    <script>window.__MIDDLEWARE_STATE__ = { "session": { "xsrf": "" }, "cache": { "cacheStatus": "HIT" } }</script>
    <script src="https://cdn-client.medium.com/lite/static/js/manifest.577390f3.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/3057.5e22bbb0.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/main.455e7898.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/instrumentation.4ddbf12e.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/reporting.2021fe63.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/4398.db4d4378.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/7883.0e445e04.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/9281.e9be8bce.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/7111.1421aaa2.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/6481.9389fa5e.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/8695.17d1af21.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/3418.eb013b5a.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/5971.2133e397.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/5514.32e692f6.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/5203.d7ff263d.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/7098.93054372.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/703.79c6106e.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/1711.7605eb3e.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/8597.c12400e1.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/9174.1df5a0ac.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/8883.2f95bbf4.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/705.15bf34f2.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/5781.9f2ea9e7.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/8580.feeb2549.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/6046.f9be485b.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/1525.9d7ce475.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/500.9a872e1f.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/9408.8ab2f0e9.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/6605.84e81b15.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/2790.ca0e202b.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/7421.3f94f5ea.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/51.d8fb2684.chunk.js"></script>
    <script src="https://cdn-client.medium.com/lite/static/js/PostPage.MainContent.44471406.chunk.js"></script>
    <script>window.main();</script>
    <script defer
        src="https://static.cloudflareinsights.com/beacon.min.js/vedd3670a3b1c4e178fdfb0cc912d969e1713874337387"
        integrity="sha512-EzCudv2gYygrCcVhu65FkAxclf3mYM6BCwiGUm6BEuLzSb5ulVhgokzCZED7yMIkzYVg65mxfIBNdNra5ZFNyQ=="
        data-cf-beacon='{"rayId":"887a1932cab281b9","version":"2024.4.1","token":"0b5f665943484354a59c39c6833f7078"}'
        crossorigin="anonymous"></script>
</body>

</html>